<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE MiniApp · กิจกรรม โดย ครบเครื่องเรื่องไอที</title>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        * {
            font-family: 'IBM Plex Sans Thai', sans-serif;
        }
        
        :root {
            --primary: #06c755;
            --primary-dark: #05b34a;
            --primary-light: #7ee0a3;
            --bg-primary: #0a0a0f;
            --bg-secondary: #111317;
            --bg-card: #1a1d24;
            --bg-hover: #252930;
            --border: #2a2e36;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Loading Animation */
        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-card);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Activity Card */
        .activity-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .activity-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px -10px rgba(6, 199, 85, 0.3);
        }
        
        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .badge-open {
            background: rgba(6, 199, 85, 0.15);
            color: var(--primary);
            border: 1px solid rgba(6, 199, 85, 0.3);
        }
        
        .badge-closed {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .badge-full {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        /* Buttons */
        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(6, 199, 85, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-outline:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(26, 29, 36, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Input Fields */
        .input-field {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .input-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1);
        }
        
        /* Modal */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* Tag */
        .tag {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid var(--border);
        }
        
        /* Admin Panel */
        .admin-panel {
            background: linear-gradient(135deg, rgba(6, 199, 85, 0.1), rgba(0, 163, 68, 0.05));
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
        }
        
        /* Stat Card */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--primary);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 modal-overlay z-[9999] hidden items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p id="loadingMessage" class="text-white text-lg">กำลังโหลดข้อมูล...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 glass z-50 px-4 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#06c755] to-[#00a344] flex items-center justify-center">
                    <i class="fab fa-line text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">LINE MiniApp</h1>
                    <p class="text-xs text-gray-400">โดย ครบเครื่องเรื่องไอที</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Admin Button -->
                <button id="adminBtn" class="hidden p-2 rounded-xl hover:bg-white/10 transition">
                    <i class="fas fa-cog text-gray-300"></i>
                </button>
                
                <!-- Notifications -->
                <button id="notificationsBtn" class="relative p-2 rounded-xl hover:bg-white/10 transition">
                    <i class="fas fa-bell text-gray-300"></i>
                    <span id="notificationBadge" class="absolute -top-1 -right-1 min-w-[20px] h-5 bg-[#06c755] text-white text-xs rounded-full hidden items-center justify-center px-1"></span>
                </button>
                
                <!-- Profile -->
                <div id="profileSection" class="hidden items-center gap-3">
                    <div class="text-right">
                        <p id="profileName" class="text-sm font-medium text-white"></p>
                        <p id="profileEmail" class="text-xs text-gray-400"></p>
                    </div>
                    <img id="profileImage" src="" class="w-10 h-10 rounded-full border-2 border-[#06c755] object-cover">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="pt-24 pb-10 px-4 max-w-7xl mx-auto">
        <!-- Welcome Banner -->
        <div id="welcomeBanner" class="hidden mb-8 p-6 rounded-2xl bg-gradient-to-r from-[#06c75520] to-[#00a34420] border border-[#06c75540]">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl bg-[#06c755] flex items-center justify-center">
                    <i class="fas fa-hand-peace text-white text-3xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white">สวัสดี, <span id="welcomeName" class="text-[#06c755]"></span></h2>
                    <p class="text-gray-400">ยินดีต้อนรับสู่ระบบจัดการกิจกรรม</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">กิจกรรมทั้งหมด</span>
                    <i class="fas fa-calendar-alt text-[#06c755]"></i>
                </div>
                <p id="statTotalActivities" class="text-3xl font-bold text-white">-</p>
            </div>
            <div class="stat-card">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">เปิดรับสมัคร</span>
                    <i class="fas fa-door-open text-[#06c755]"></i>
                </div>
                <p id="statOpenActivities" class="text-3xl font-bold text-[#06c755]">-</p>
            </div>
            <div class="stat-card">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">ผู้เข้าร่วม</span>
                    <i class="fas fa-users text-blue-400"></i>
                </div>
                <p id="statTotalParticipants" class="text-3xl font-bold text-blue-400">-</p>
            </div>
            <div class="stat-card cursor-pointer" onclick="showMyRegistrations()">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">ลงทะเบียนแล้ว</span>
                    <i class="fas fa-check-circle text-purple-400"></i>
                </div>
                <p id="statMyRegistrations" class="text-3xl font-bold text-purple-400">-</p>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden admin-panel mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">
                    <i class="fas fa-crown text-[#06c755] mr-2"></i>แผงควบคุมแอดมิน
                </h3>
                <div class="flex gap-2">
                    <button onclick="refreshAdminStats()" class="btn-outline px-4 py-2 text-sm">
                        <i class="fas fa-sync-alt mr-2"></i>รีเฟรช
                    </button>
                    <button onclick="showCreateActivityModal()" class="btn-primary px-4 py-2 text-sm">
                        <i class="fas fa-plus mr-2"></i>สร้างกิจกรรม
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                <div class="bg-[#111317] p-4 rounded-xl border border-[#2a2e36]">
                    <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
                    <p id="adminTotalUsers" class="text-2xl font-bold text-white">0</p>
                </div>
                <div class="bg-[#111317] p-4 rounded-xl border border-[#2a2e36]">
                    <p class="text-xs text-gray-500">กิจกรรม</p>
                    <p id="adminTotalActivities" class="text-2xl font-bold text-white">0</p>
                </div>
                <div class="bg-[#111317] p-4 rounded-xl border border-[#2a2e36]">
                    <p class="text-xs text-gray-500">การลงทะเบียน</p>
                    <p id="adminTotalRegistrations" class="text-2xl font-bold text-white">0</p>
                </div>
                <div class="bg-[#111317] p-4 rounded-xl border border-[#2a2e36]">
                    <p class="text-xs text-gray-500">วันนี้</p>
                    <p id="adminTodayRegistrations" class="text-2xl font-bold text-[#06c755]">0</p>
                </div>
                <div class="bg-[#111317] p-4 rounded-xl border border-[#2a2e36]">
                    <p class="text-xs text-gray-500">รายได้</p>
                    <p id="adminRevenue" class="text-2xl font-bold text-yellow-500">฿0</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex flex-wrap gap-2">
                <button onclick="showManageActivities()" class="btn-outline px-4 py-2 text-sm flex-1">
                    <i class="fas fa-edit mr-2"></i>จัดการกิจกรรม
                </button>
                <button onclick="showManageUsers()" class="btn-outline px-4 py-2 text-sm flex-1">
                    <i class="fas fa-users mr-2"></i>จัดการผู้ใช้
                </button>
                <button onclick="backupData()" class="btn-outline px-4 py-2 text-sm flex-1">
                    <i class="fas fa-database mr-2"></i>สำรองข้อมูล
                </button>
                <button onclick="showSystemSettings()" class="btn-outline px-4 py-2 text-sm flex-1">
                    <i class="fas fa-sliders-h mr-2"></i>ตั้งค่าระบบ
                </button>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 relative">
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
                    <input type="text" id="searchInput" placeholder="ค้นหากิจกรรม..." 
                           class="input-field pl-12">
                </div>
                <select id="statusFilter" class="input-field md:w-48">
                    <option value="all">ทั้งหมด</option>
                    <option value="open">เปิดรับสมัคร</option>
                    <option value="closed">ปิดรับสมัคร</option>
                    <option value="full">เต็มแล้ว</option>
                </select>
                <select id="categoryFilter" class="input-field md:w-48">
                    <option value="all">ทุกหมวดหมู่</option>
                </select>
            </div>
        </div>

        <!-- Activities Grid -->
        <div id="activitiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Skeleton Loading -->
            <div class="activity-card rounded-2xl p-4 animate-pulse" style="height: 400px;"></div>
            <div class="activity-card rounded-2xl p-4 animate-pulse" style="height: 400px;"></div>
            <div class="activity-card rounded-2xl p-4 animate-pulse" style="height: 400px;"></div>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center bg-[#1a1d24] rounded-xl p-4 border border-[#2a2e36]">
            <button id="prevPage" class="btn-outline px-6 py-2 disabled:opacity-50" disabled>
                <i class="fas fa-chevron-left mr-2"></i>ก่อนหน้า
            </button>
            <span id="pageInfo" class="text-gray-400">หน้า 1 / 1</span>
            <button id="nextPage" class="btn-outline px-6 py-2 disabled:opacity-50" disabled>
                ถัดไป<i class="fas fa-chevron-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="fixed inset-0 modal-overlay z-[100] hidden items-center justify-center p-4">
        <div class="modal-content max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold text-white"></h3>
                <button onclick="closeModal()" class="p-2 hover:bg-white/10 rounded-xl">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <div id="modalContent" class="space-y-6"></div>
            <div class="mt-6 flex gap-3">
                <button id="registerBtn" class="btn-primary flex-1">ลงทะเบียน</button>
                <button onclick="closeModal()" class="btn-outline px-6">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Activity Modal -->
    <div id="createActivityModal" class="fixed inset-0 modal-overlay z-[100] hidden items-center justify-center p-4">
        <div class="modal-content max-w-3xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="activityModalTitle" class="text-2xl font-bold text-white">สร้างกิจกรรมใหม่</h3>
                <button onclick="closeCreateActivityModal()" class="p-2 hover:bg-white/10 rounded-xl">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            
            <form id="activityForm" class="space-y-4" onsubmit="saveActivity(event)">
                <input type="hidden" id="activityId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">ชื่อกิจกรรม *</label>
                        <input type="text" id="activityTitle" class="input-field" required>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">คำอธิบาย *</label>
                        <textarea id="activityDescription" rows="3" class="input-field" required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">หมวดหมู่ *</label>
                        <select id="activityCategory" class="input-field" required>
                            <option value="">เลือกหมวดหมู่</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">สถานที่ *</label>
                        <input type="text" id="activityLocation" class="input-field" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">วันที่เริ่ม *</label>
                        <input type="datetime-local" id="activityStartDate" class="input-field" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">วันที่สิ้นสุด *</label>
                        <input type="datetime-local" id="activityEndDate" class="input-field" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">จำนวนผู้เข้าร่วมสูงสุด *</label>
                        <input type="number" id="activityMaxParticipants" class="input-field" min="1" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">จำนวนขั้นต่ำ</label>
                        <input type="number" id="activityMinParticipants" class="input-field" min="0" value="1">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">ราคา (0 = ฟรี)</label>
                        <input type="number" id="activityPrice" class="input-field" min="0" value="0">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">สถานะ</label>
                        <select id="activityStatus" class="input-field">
                            <option value="draft">ร่าง</option>
                            <option value="open" selected>เปิดรับสมัคร</option>
                            <option value="closed">ปิดรับสมัคร</option>
                        </select>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">รูปภาพหลัก (URL)</label>
                        <input type="url" id="activityImageUrl" class="input-field" placeholder="https://...">
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">แท็ก (คั่นด้วยเครื่องหมาย ,)</label>
                        <input type="text" id="activityTags" class="input-field" placeholder="เทคโนโลยี, AI, สัมมนา">
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">คุณสมบัติผู้สมัคร (บรรทัดละ 1 รายการ)</label>
                        <textarea id="activityRequirements" rows="3" class="input-field" placeholder="อายุ 15 ปีขึ้นไป"></textarea>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">สิทธิประโยชน์ (บรรทัดละ 1 รายการ)</label>
                        <textarea id="activityBenefits" rows="3" class="input-field" placeholder="ได้รับประกาศนียบัตร"></textarea>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">ข้อมูลติดต่อ</label>
                        <input type="text" id="activityContact" class="input-field" placeholder="เบอร์โทรศัพท์, อีเมล">
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn-primary flex-1">บันทึกกิจกรรม</button>
                    <button type="button" onclick="closeCreateActivityModal()" class="btn-outline px-6">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Activities Modal -->
    <div id="manageActivitiesModal" class="fixed inset-0 modal-overlay z-[100] hidden items-center justify-center p-4">
        <div class="modal-content max-w-4xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white">จัดการกิจกรรม</h3>
                <button onclick="closeManageActivitiesModal()" class="p-2 hover:bg-white/10 rounded-xl">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <input type="text" id="manageSearch" placeholder="ค้นหากิจกรรม..." class="input-field">
            </div>
            
            <div id="manageActivitiesList" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Activities list will be loaded here -->
            </div>
        </div>
    </div>

    <!-- My Registrations Modal -->
    <div id="registrationsModal" class="fixed inset-0 modal-overlay z-[100] hidden items-center justify-center p-4">
        <div class="modal-content max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white">กิจกรรมที่ฉันลงทะเบียน</h3>
                <button onclick="closeRegistrationsModal()" class="p-2 hover:bg-white/10 rounded-xl">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <div id="registrationsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="fixed inset-0 modal-overlay z-[100] hidden items-center justify-center p-4">
        <div class="modal-content max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white">การแจ้งเตือน</h3>
                <button onclick="closeNotificationsModal()" class="p-2 hover:bg-white/10 rounded-xl">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <div id="notificationsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
            <div class="mt-4 text-center">
                <button onclick="markAllNotificationsRead()" class="text-sm text-[#06c755] hover:underline">
                    <i class="fas fa-check-double mr-1"></i>อ่านทั้งหมด
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // LINE MiniApp Frontend
        // พัฒนาโดย ครบเครื่องเรื่องไอที
        // ============================================
        
        // Configuration
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwSz6Y_fpvB0qN52eS6QD2RFJD-bJA369B6b86W1ZGVCOrbPXGGbpBIS3hDO8h6awKzkw/exec',
            LIFF_ID: '2008904120-T7I0VPZf',
            PAGE_SIZE: 9,
            MAX_RETRIES: 3
        };
        
        // State
        const state = {
            currentUser: null,
            activities: [],
            myRegistrations: [],
            notifications: [],
            categories: [],
            currentPage: 1,
            totalPages: 1,
            currentFilter: 'all',
            currentCategory: 'all',
            searchKeyword: '',
            isAdmin: false
        };
        
        // DOM Elements
        const elements = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            activitiesContainer: document.getElementById('activitiesContainer'),
            profileSection: document.getElementById('profileSection'),
            profileName: document.getElementById('profileName'),
            profileEmail: document.getElementById('profileEmail'),
            profileImage: document.getElementById('profileImage'),
            welcomeBanner: document.getElementById('welcomeBanner'),
            welcomeName: document.getElementById('welcomeName'),
            statTotalActivities: document.getElementById('statTotalActivities'),
            statOpenActivities: document.getElementById('statOpenActivities'),
            statTotalParticipants: document.getElementById('statTotalParticipants'),
            statMyRegistrations: document.getElementById('statMyRegistrations'),
            pageInfo: document.getElementById('pageInfo'),
            prevPage: document.getElementById('prevPage'),
            nextPage: document.getElementById('nextPage'),
            searchInput: document.getElementById('searchInput'),
            statusFilter: document.getElementById('statusFilter'),
            categoryFilter: document.getElementById('categoryFilter'),
            notificationBadge: document.getElementById('notificationBadge'),
            adminBtn: document.getElementById('adminBtn'),
            adminPanel: document.getElementById('adminPanel')
        };
        
        // ========== Utility Functions ==========
        function showLoading(message = 'กำลังโหลด...') {
            document.getElementById('loadingMessage').textContent = message;
            elements.loadingOverlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
        }
        
        function showToast(message, type = 'success') {
            const colors = {
                success: '#06c755',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = colors[type];
            toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}" style="color: ${colors[type]}"></i><span class="text-white">${message}</span></div>`;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        // ========== API Calls ==========
        async function callGAS(path, data = {}) {
            const formData = new FormData();
            formData.append('path', path);
            
            if (state.currentUser?.userId) {
                formData.append('lineUserId', state.currentUser.userId);
            }
            
            Object.keys(data).forEach(key => {
                if (data[key] !== undefined && data[key] !== null) {
                    formData.append(key, data[key]);
                }
            });
            
            for (let i = 0; i < CONFIG.MAX_RETRIES; i++) {
                try {
                    const response = await fetch(CONFIG.GAS_URL, { method: 'POST', body: formData });
                    return await response.json();
                } catch (error) {
                    if (i === CONFIG.MAX_RETRIES - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
        
        // ========== Initialization ==========
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('กำลังเริ่มต้นระบบ...');
            
            try {
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK not loaded');
                }
                
                await new Promise((resolve, reject) => {
                    liff.init({ liffId: CONFIG.LIFF_ID }, resolve, reject);
                });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                await loadUserProfile();
                hideLoading();
                
            } catch (error) {
                console.error('Init error:', error);
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อกับ LINE ได้',
                    confirmButtonColor: '#06c755'
                });
            }
        });
        
        // ========== User Profile ==========
        async function loadUserProfile() {
            try {
                const profile = await liff.getProfile();
                const idToken = liff.getDecodedIDToken();
                
                const result = await callGAS('user/profile', {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    email: idToken?.email || ''
                });
                
                if (!result.success) throw new Error(result.message);
                
                state.currentUser = result.data;
                state.isAdmin = state.currentUser.role === 'admin' || state.currentUser.role === 'org';
                
                updateProfileUI();
                
                await Promise.all([
                    loadCategories(),
                    loadMyRegistrations(),
                    loadHomeData()
                ]);
                
            } catch (error) {
                console.error('Load profile error:', error);
                showToast('ไม่สามารถโหลดโปรไฟล์ได้', 'error');
            }
        }
        
        function updateProfileUI() {
            if (!state.currentUser) return;
            
            elements.profileSection.classList.remove('hidden');
            elements.profileName.textContent = state.currentUser.displayName;
            elements.profileEmail.textContent = state.currentUser.email || 'ไม่มีอีเมล';
            elements.profileImage.src = state.currentUser.pictureUrl || 'https://via.placeholder.com/100/06c755/ffffff?text=LINE';
            elements.welcomeBanner.classList.remove('hidden');
            elements.welcomeName.textContent = state.currentUser.displayName.split(' ')[0];
            
            if (state.isAdmin) {
                elements.adminBtn.classList.remove('hidden');
                elements.adminBtn.onclick = toggleAdminPanel;
            }
        }
        
        // ========== Categories ==========
        async function loadCategories() {
            try {
                const categories = [
                    { id: 'CAT001', name: 'อบรม' },
                    { id: 'CAT002', name: 'สัมมนา' },
                    { id: 'CAT003', name: 'workshop' },
                    { id: 'CAT004', name: 'กีฬา' },
                    { id: 'CAT005', name: 'ดนตรี' },
                    { id: 'CAT006', name: 'ศิลปะ' },
                    { id: 'CAT007', name: 'ท่องเที่ยว' }
                ];
                
                state.categories = categories;
                
                // Update category filter
                let options = '<option value="all">ทุกหมวดหมู่</option>';
                categories.forEach(cat => {
                    options += `<option value="${cat.id}">${cat.name}</option>`;
                });
                elements.categoryFilter.innerHTML = options;
                
                // Update activity form category select
                document.getElementById('activityCategory').innerHTML = 
                    '<option value="">เลือกหมวดหมู่</option>' + options.replace(/<option value="all">.*?<\/option>/, '');
                
            } catch (error) {
                console.error('Load categories error:', error);
            }
        }
        
        // ========== Activities ==========
        async function loadHomeData() {
            try {
                const result = await callGAS('home');
                
                if (result.success && result.data) {
                    elements.statTotalActivities.textContent = result.data.totalActivities || 0;
                    elements.statOpenActivities.textContent = result.data.openActivities || 0;
                    elements.statTotalParticipants.textContent = result.data.totalParticipants || 0;
                }
                
                await loadActivities();
                
            } catch (error) {
                console.error('Load home error:', error);
            }
        }
        
        async function loadActivities() {
            try {
                const result = await callGAS('activities', {
                    page: state.currentPage,
                    status: state.currentFilter,
                    category: state.currentCategory,
                    search: state.searchKeyword,
                    pageSize: CONFIG.PAGE_SIZE
                });
                
                if (!result.success) throw new Error(result.message);
                
                state.activities = result.data.activities || [];
                state.totalPages = result.data.totalPages || 1;
                
                displayActivities();
                updatePagination();
                
            } catch (error) {
                console.error('Load activities error:', error);
                elements.activitiesContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-exclamation-circle text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">ไม่สามารถโหลดข้อมูลกิจกรรมได้</p>
                    </div>
                `;
            }
        }
        
        function displayActivities() {
            if (!state.activities.length) {
                elements.activitiesContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-calendar-times text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">ไม่พบกิจกรรม</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            state.activities.forEach(activity => {
                const isRegistered = state.myRegistrations.some(r => r.activityId === activity.activityId);
                const participantsPercent = (activity.currentParticipants / activity.maxParticipants) * 100;
                
                // Parse tags
                let tags = [];
                try { tags = JSON.parse(activity.tags || '[]'); } catch { tags = (activity.tags || '').split(',').map(t => t.trim()); }
                
                html += `
                    <div class="activity-card rounded-2xl overflow-hidden cursor-pointer" onclick="showActivityDetail('${activity.activityId}')">
                        <div class="relative h-48">
                            ${activity.imageUrl ? 
                                `<img src="${activity.imageUrl}" class="w-full h-full object-cover">` : 
                                `<div class="w-full h-full bg-gradient-to-br from-[#06c755] to-[#00a344] flex items-center justify-center">
                                    <i class="fas fa-calendar-alt text-white text-5xl opacity-50"></i>
                                </div>`
                            }
                            <div class="absolute top-4 right-4">
                                <span class="badge badge-${activity.status}">
                                    <i class="fas fa-${activity.status === 'open' ? 'door-open' : activity.status === 'closed' ? 'lock' : 'users'}"></i>
                                    ${activity.status === 'open' ? 'เปิดรับสมัคร' : activity.status === 'closed' ? 'ปิดรับสมัคร' : 'เต็มแล้ว'}
                                </span>
                            </div>
                            ${state.isAdmin ? `
                                <div class="absolute top-4 left-4 flex gap-2">
                                    <span class="badge bg-blue-500 text-white" onclick="event.stopPropagation(); editActivity('${activity.activityId}')">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                    <span class="badge bg-red-500 text-white" onclick="event.stopPropagation(); deleteActivityConfirm('${activity.activityId}')">
                                        <i class="fas fa-trash"></i>
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="p-5">
                            <div class="flex gap-2 mb-2">
                                ${tags.slice(0, 2).map(tag => `<span class="tag">#${tag}</span>`).join('')}
                            </div>
                            
                            <h3 class="font-semibold text-lg text-white mb-2">${activity.title}</h3>
                            <p class="text-sm text-gray-400 mb-4 line-clamp-2">${activity.description}</p>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm text-gray-300">
                                    <i class="fas fa-calendar w-5 text-[#06c755]"></i>
                                    <span>${formatDate(activity.startDate)}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-300">
                                    <i class="fas fa-map-marker-alt w-5 text-[#06c755]"></i>
                                    <span>${activity.location}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-300">
                                    <i class="fas fa-users w-5 text-[#06c755]"></i>
                                    <span>${activity.currentParticipants}/${activity.maxParticipants} คน</span>
                                </div>
                            </div>
                            
                            <div class="progress-bar mb-4">
                                <div class="progress-fill" style="width: ${participantsPercent}%"></div>
                            </div>
                            
                            ${isRegistered ? 
                                '<div class="text-center py-2 bg-[#06c755]/10 text-[#06c755] rounded-xl text-sm">✅ ลงทะเบียนแล้ว</div>' : 
                                activity.status === 'open' ?
                                `<button class="w-full py-3 bg-[#06c755] text-white rounded-xl text-sm hover:bg-[#05b34a]" onclick="event.stopPropagation(); registerActivity('${activity.activityId}')">
                                    ลงทะเบียน
                                </button>` :
                                `<button class="w-full py-3 bg-[#2a2e36] text-gray-500 rounded-xl text-sm cursor-not-allowed" disabled>
                                    ${activity.status === 'closed' ? 'ปิดรับสมัครแล้ว' : 'เต็มแล้ว'}
                                </button>`
                            }
                        </div>
                    </div>
                `;
            });
            
            elements.activitiesContainer.innerHTML = html;
        }
        
        function updatePagination() {
            elements.pageInfo.textContent = `หน้า ${state.currentPage} / ${state.totalPages}`;
            elements.prevPage.disabled = state.currentPage === 1;
            elements.nextPage.disabled = state.currentPage === state.totalPages;
        }
        
        // ========== Activity Detail ==========
        window.showActivityDetail = async function(activityId) {
            showLoading('กำลังโหลดรายละเอียด...');
            
            try {
                const result = await callGAS('activity', { activityId });
                
                if (!result.success) throw new Error(result.message);
                
                const activity = result.data;
                const isRegistered = state.myRegistrations.some(r => r.activityId === activity.activityId);
                
                // Parse JSON fields
                let requirements = [], benefits = [], tags = [], galleryUrls = [];
                try { requirements = JSON.parse(activity.requirements || '[]'); } catch { requirements = []; }
                try { benefits = JSON.parse(activity.benefits || '[]'); } catch { benefits = []; }
                try { tags = JSON.parse(activity.tags || '[]'); } catch { tags = []; }
                try { galleryUrls = JSON.parse(activity.galleryUrls || '[]'); } catch { galleryUrls = []; }
                
                document.getElementById('modalTitle').textContent = activity.title;
                
                document.getElementById('modalContent').innerHTML = `
                    ${galleryUrls.length ? `
                        <div class="grid grid-cols-3 gap-2">
                            ${galleryUrls.slice(0, 3).map(url => `<img src="${url}" class="h-24 w-full object-cover rounded-lg">`).join('')}
                        </div>
                    ` : activity.imageUrl ? `<img src="${activity.imageUrl}" class="w-full h-64 object-cover rounded-xl">` : ''}
                    
                    <div class="flex gap-2">
                        <span class="badge badge-${activity.status}">
                            <i class="fas fa-${activity.status === 'open' ? 'door-open' : 'lock'}"></i>
                            ${activity.status === 'open' ? 'เปิดรับสมัคร' : 'ปิดรับสมัคร'}
                        </span>
                        ${tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                    </div>
                    
                    <p class="text-gray-400">${activity.description}</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-[#111317] rounded-xl">
                            <p class="text-xs text-gray-500">วันที่เริ่ม</p>
                            <p class="text-white">${formatDate(activity.startDate)}</p>
                        </div>
                        <div class="p-4 bg-[#111317] rounded-xl">
                            <p class="text-xs text-gray-500">วันที่สิ้นสุด</p>
                            <p class="text-white">${formatDate(activity.endDate)}</p>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-[#111317] rounded-xl">
                        <p class="text-xs text-gray-500">สถานที่</p>
                        <p class="text-white">${activity.location}</p>
                    </div>
                    
                    <div class="p-4 bg-[#111317] rounded-xl">
                        <div class="flex justify-between mb-2">
                            <span class="text-white">ผู้เข้าร่วม</span>
                            <span class="text-[#06c755]">${activity.currentParticipants}/${activity.maxParticipants}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(activity.currentParticipants/activity.maxParticipants)*100}%"></div>
                        </div>
                    </div>
                    
                    ${requirements.length ? `
                        <div class="p-4 bg-[#111317] rounded-xl">
                            <p class="text-white mb-2">📋 คุณสมบัติ</p>
                            <ul class="space-y-1">
                                ${requirements.map(r => `<li class="text-sm text-gray-400">• ${r}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${benefits.length ? `
                        <div class="p-4 bg-[#111317] rounded-xl">
                            <p class="text-white mb-2">🎁 สิทธิประโยชน์</p>
                            <ul class="space-y-1">
                                ${benefits.map(b => `<li class="text-sm text-gray-400">• ${b}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="p-4 bg-[#111317] rounded-xl">
                        <p class="text-white mb-2">📞 ติดต่อ</p>
                        <p class="text-sm text-gray-400">${activity.contact || 'ไม่ระบุ'}</p>
                    </div>
                `;
                
                const registerBtn = document.getElementById('registerBtn');
                if (isRegistered) {
                    registerBtn.disabled = true;
                    registerBtn.className = 'btn-primary flex-1 opacity-50 cursor-not-allowed';
                    registerBtn.innerHTML = 'ลงทะเบียนแล้ว';
                } else if (activity.status !== 'open') {
                    registerBtn.disabled = true;
                    registerBtn.className = 'btn-primary flex-1 opacity-50 cursor-not-allowed';
                    registerBtn.innerHTML = 'ไม่สามารถลงทะเบียนได้';
                } else {
                    registerBtn.disabled = false;
                    registerBtn.className = 'btn-primary flex-1';
                    registerBtn.innerHTML = 'ลงทะเบียน';
                    registerBtn.onclick = () => registerActivity(activity.activityId);
                }
                
                document.getElementById('activityModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Load detail error:', error);
                showToast('ไม่สามารถโหลดรายละเอียดได้', 'error');
            }
            
            hideLoading();
        };
        
        // ========== Registration ==========
        window.registerActivity = async function(activityId) {
            const result = await Swal.fire({
                title: 'ยืนยันการลงทะเบียน',
                text: 'คุณต้องการลงทะเบียนกิจกรรมนี้ใช่หรือไม่?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#06c755',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (!result.isConfirmed) return;
            
            showLoading('กำลังดำเนินการ...');
            
            try {
                const response = await callGAS('register', { 
                    activityId,
                    displayName: state.currentUser.displayName,
                    email: state.currentUser.email || '',
                    phone: state.currentUser.phone || ''
                });
                
                if (!response.success) throw new Error(response.message);
                
                await loadMyRegistrations();
                await loadActivities();
                
                closeModal();
                
                Swal.fire({
                    icon: 'success',
                    title: 'ลงทะเบียนสำเร็จ',
                    text: response.data?.status === 'waiting' ? `อยู่ในคิวรอ ลำดับที่ ${response.data.queuePosition}` : 'คุณได้ลงทะเบียนกิจกรรมเรียบร้อยแล้ว',
                    confirmButtonColor: '#06c755'
                });
                
            } catch (error) {
                console.error('Register error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สำเร็จ',
                    text: error.message || 'กรุณาลองอีกครั้ง',
                    confirmButtonColor: '#06c755'
                });
            }
            
            hideLoading();
        };
        
        async function loadMyRegistrations() {
            try {
                const result = await callGAS('user/registrations');
                
                if (result.success) {
                    state.myRegistrations = result.data || [];
                    elements.statMyRegistrations.textContent = state.myRegistrations.length;
                }
                
            } catch (error) {
                console.error('Load registrations error:', error);
            }
        }
        
        window.showMyRegistrations = function() {
            const modal = document.getElementById('registrationsModal');
            const list = document.getElementById('registrationsList');
            
            if (!state.myRegistrations.length) {
                list.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-ticket-alt text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">ยังไม่มีการลงทะเบียน</p>
                    </div>
                `;
            } else {
                list.innerHTML = state.myRegistrations.map(reg => `
                    <div class="p-4 bg-[#111317] rounded-xl border border-[#2a2e36]">
                        <div class="flex justify-between mb-2">
                            <h4 class="font-medium text-white">${reg.activity?.title || 'กิจกรรม'}</h4>
                            <span class="text-sm ${reg.status === 'confirmed' ? 'text-[#06c755]' : 'text-yellow-500'}">
                                <i class="fas fa-${reg.status === 'confirmed' ? 'check-circle' : 'clock'}"></i>
                                ${reg.status === 'confirmed' ? 'ยืนยันแล้ว' : 'รอคิว'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-400">ลงทะเบียน: ${formatDate(reg.registrationDate)}</p>
                        ${reg.status === 'confirmed' ? `
                            <button class="mt-2 text-sm text-red-500" onclick="cancelRegistration('${reg.regId}')">
                                <i class="fas fa-times mr-1"></i>ยกเลิก
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            }
            
            modal.classList.remove('hidden');
        };
        
        window.cancelRegistration = async function(registrationId) {
            const result = await Swal.fire({
                title: 'ยืนยันการยกเลิก',
                text: 'ต้องการยกเลิกการลงทะเบียนใช่หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'กลับ'
            });
            
            if (!result.isConfirmed) return;
            
            showLoading('กำลังดำเนินการ...');
            
            try {
                const response = await callGAS('cancel', { registrationId });
                
                if (!response.success) throw new Error(response.message);
                
                await loadMyRegistrations();
                await loadActivities();
                closeRegistrationsModal();
                
                Swal.fire({
                    icon: 'success',
                    title: 'ยกเลิกสำเร็จ',
                    text: 'ยกเลิกการลงทะเบียนเรียบร้อย',
                    confirmButtonColor: '#06c755'
                });
                
            } catch (error) {
                console.error('Cancel error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สำเร็จ',
                    text: error.message,
                    confirmButtonColor: '#06c755'
                });
            }
            
            hideLoading();
        };
        
        // ========== Admin Functions ==========
        function toggleAdminPanel() {
            elements.adminPanel.classList.toggle('hidden');
            if (!elements.adminPanel.classList.contains('hidden')) {
                loadAdminStats();
            }
        }
        
        async function loadAdminStats() {
            try {
                const result = await callGAS('admin/stats');
                
                if (result.success) {
                    document.getElementById('adminTotalUsers').textContent = result.data.users || 0;
                    document.getElementById('adminTotalActivities').textContent = result.data.activities || 0;
                    document.getElementById('adminTotalRegistrations').textContent = result.data.registrations || 0;
                    document.getElementById('adminTodayRegistrations').textContent = result.data.todayRegistrations || 0;
                    document.getElementById('adminRevenue').textContent = `฿${(result.data.revenue || 0).toLocaleString()}`;
                }
                
            } catch (error) {
                console.error('Load admin stats error:', error);
            }
        }
        
        function refreshAdminStats() {
            loadAdminStats();
            showToast('รีเฟรชข้อมูลสำเร็จ');
        }
        
        // ========== Create/Edit Activity ==========
        window.showCreateActivityModal = function() {
            resetActivityForm();
            document.getElementById('activityModalTitle').textContent = 'สร้างกิจกรรมใหม่';
            document.getElementById('createActivityModal').classList.remove('hidden');
        };
        
        function resetActivityForm() {
            document.getElementById('activityId').value = '';
            document.getElementById('activityTitle').value = '';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityCategory').value = '';
            document.getElementById('activityLocation').value = '';
            document.getElementById('activityStartDate').value = '';
            document.getElementById('activityEndDate').value = '';
            document.getElementById('activityMaxParticipants').value = '100';
            document.getElementById('activityMinParticipants').value = '1';
            document.getElementById('activityPrice').value = '0';
            document.getElementById('activityStatus').value = 'open';
            document.getElementById('activityImageUrl').value = '';
            document.getElementById('activityTags').value = '';
            document.getElementById('activityRequirements').value = '';
            document.getElementById('activityBenefits').value = '';
            document.getElementById('activityContact').value = '';
        }
        
        window.saveActivity = async function(event) {
            event.preventDefault();
            
            if (!state.isAdmin) {
                showToast('คุณไม่มีสิทธิ์', 'error');
                return;
            }
            
            const activityData = {
                title: document.getElementById('activityTitle').value,
                description: document.getElementById('activityDescription').value,
                category: document.getElementById('activityCategory').value,
                location: document.getElementById('activityLocation').value,
                startDate: document.getElementById('activityStartDate').value,
                endDate: document.getElementById('activityEndDate').value,
                maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value),
                minParticipants: parseInt(document.getElementById('activityMinParticipants').value) || 1,
                price: parseInt(document.getElementById('activityPrice').value) || 0,
                status: document.getElementById('activityStatus').value,
                imageUrl: document.getElementById('activityImageUrl').value,
                tags: JSON.stringify(document.getElementById('activityTags').value.split(',').map(t => t.trim()).filter(t => t)),
                requirements: JSON.stringify(document.getElementById('activityRequirements').value.split('\n').filter(r => r.trim())),
                benefits: JSON.stringify(document.getElementById('activityBenefits').value.split('\n').filter(b => b.trim())),
                contact: document.getElementById('activityContact').value
            };
            
            const activityId = document.getElementById('activityId').value;
            const isEdit = !!activityId;
            
            showLoading('กำลังบันทึก...');
            
            try {
                const path = isEdit ? 'activities/update' : 'activities/create';
                const data = isEdit ? { activityId, ...activityData } : activityData;
                
                const result = await callGAS(path, data);
                
                if (!result.success) throw new Error(result.message);
                
                closeCreateActivityModal();
                await loadActivities();
                
                Swal.fire({
                    icon: 'success',
                    title: 'สำเร็จ',
                    text: isEdit ? 'แก้ไขกิจกรรมเรียบร้อย' : 'สร้างกิจกรรมเรียบร้อย',
                    confirmButtonColor: '#06c755'
                });
                
            } catch (error) {
                console.error('Save activity error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สำเร็จ',
                    text: error.message,
                    confirmButtonColor: '#06c755'
                });
            }
            
            hideLoading();
        };
        
        window.editActivity = async function(activityId) {
            showLoading('กำลังโหลดข้อมูล...');
            
            try {
                const result = await callGAS('activity', { activityId });
                
                if (!result.success) throw new Error(result.message);
                
                const activity = result.data;
                
                document.getElementById('activityId').value = activity.activityId;
                document.getElementById('activityTitle').value = activity.title || '';
                document.getElementById('activityDescription').value = activity.description || '';
                document.getElementById('activityCategory').value = activity.category || '';
                document.getElementById('activityLocation').value = activity.location || '';
                document.getElementById('activityStartDate').value = activity.startDate ? activity.startDate.slice(0, 16) : '';
                document.getElementById('activityEndDate').value = activity.endDate ? activity.endDate.slice(0, 16) : '';
                document.getElementById('activityMaxParticipants').value = activity.maxParticipants || 100;
                document.getElementById('activityMinParticipants').value = activity.minParticipants || 1;
                document.getElementById('activityPrice').value = activity.price || 0;
                document.getElementById('activityStatus').value = activity.status || 'draft';
                document.getElementById('activityImageUrl').value = activity.imageUrl || '';
                
                // Parse tags
                let tags = [];
                try { tags = JSON.parse(activity.tags || '[]'); } catch { tags = (activity.tags || '').split(','); }
                document.getElementById('activityTags').value = tags.join(', ');
                
                // Parse requirements
                let requirements = [];
                try { requirements = JSON.parse(activity.requirements || '[]'); } catch { requirements = []; }
                document.getElementById('activityRequirements').value = requirements.join('\n');
                
                // Parse benefits
                let benefits = [];
                try { benefits = JSON.parse(activity.benefits || '[]'); } catch { benefits = []; }
                document.getElementById('activityBenefits').value = benefits.join('\n');
                
                document.getElementById('activityContact').value = activity.contact || '';
                
                document.getElementById('activityModalTitle').textContent = 'แก้ไขกิจกรรม';
                closeModal();
                document.getElementById('createActivityModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Edit activity error:', error);
                showToast('ไม่สามารถโหลดข้อมูลได้', 'error');
            }
            
            hideLoading();
        };
        
        window.deleteActivityConfirm = async function(activityId) {
            const result = await Swal.fire({
                title: 'ลบกิจกรรม',
                text: 'คุณแน่ใจหรือไม่? การดำเนินการนี้ไม่สามารถยกเลิกได้',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (!result.isConfirmed) return;
            
            showLoading('กำลังลบ...');
            
            try {
                const response = await callGAS('activities/delete', { activityId });
                
                if (!response.success) throw new Error(response.message);
                
                await loadActivities();
                
                Swal.fire({
                    icon: 'success',
                    title: 'ลบสำเร็จ',
                    text: 'ลบกิจกรรมเรียบร้อย',
                    confirmButtonColor: '#06c755'
                });
                
            } catch (error) {
                console.error('Delete error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สำเร็จ',
                    text: error.message,
                    confirmButtonColor: '#06c755'
                });
            }
            
            hideLoading();
        };
        
        window.showManageActivities = function() {
            const modal = document.getElementById('manageActivitiesModal');
            const list = document.getElementById('manageActivitiesList');
            
            list.innerHTML = '<p class="text-center text-gray-400">กำลังโหลด...</p>';
            modal.classList.remove('hidden');
            
            loadManageActivities();
        };
        
        async function loadManageActivities(search = '') {
            try {
                const result = await callGAS('activities', { 
                    page: 1, 
                    pageSize: 100,
                    search 
                });
                
                if (!result.success) throw new Error(result.message);
                
                const activities = result.data.activities || [];
                const list = document.getElementById('manageActivitiesList');
                
                if (!activities.length) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-8">ไม่พบกิจกรรม</p>';
                    return;
                }
                
                list.innerHTML = activities.map(activity => `
                    <div class="p-4 bg-[#111317] rounded-xl border border-[#2a2e36]">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium text-white">${activity.title}</h4>
                                <p class="text-sm text-gray-400">${activity.location} | ${formatDate(activity.startDate)}</p>
                                <p class="text-xs text-gray-500">ผู้เข้าร่วม: ${activity.currentParticipants}/${activity.maxParticipants}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="text-blue-400 hover:text-blue-300" onclick="editActivity('${activity.activityId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-400 hover:text-red-300" onclick="deleteActivityConfirm('${activity.activityId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Load manage activities error:', error);
                document.getElementById('manageActivitiesList').innerHTML = 
                    '<p class="text-center text-red-400 py-8">เกิดข้อผิดพลาด</p>';
            }
        }
        
        document.getElementById('manageSearch')?.addEventListener('input', (e) => {
            loadManageActivities(e.target.value);
        });
        
        function closeCreateActivityModal() {
            document.getElementById('createActivityModal').classList.add('hidden');
        }
        
        function closeManageActivitiesModal() {
            document.getElementById('manageActivitiesModal').classList.add('hidden');
        }
        
        window.showManageUsers = function() {
            showToast('กำลังพัฒนา...', 'info');
        };
        
        window.backupData = async function() {
            const result = await Swal.fire({
                title: 'สำรองข้อมูล',
                text: 'ต้องการสำรองข้อมูลตอนนี้หรือไม่?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#06c755',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (!result.isConfirmed) return;
            
            showLoading('กำลังสำรองข้อมูล...');
            
            try {
                const response = await callGAS('admin/backup');
                
                if (!response.success) throw new Error(response.message);
                
                Swal.fire({
                    icon: 'success',
                    title: 'สำรองข้อมูลสำเร็จ',
                    html: response.data?.fileUrl ? 
                        `<a href="${response.data.fileUrl}" target="_blank" class="text-[#06c755]">คลิกเพื่อดาวน์โหลด</a>` : 
                        'สำรองข้อมูลเรียบร้อย',
                    confirmButtonColor: '#06c755'
                });
                
            } catch (error) {
                console.error('Backup error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สำเร็จ',
                    text: error.message,
                    confirmButtonColor: '#06c755'
                });
            }
            
            hideLoading();
        };
        
        window.showSystemSettings = function() {
            showToast('กำลังพัฒนา...', 'info');
        };
        
        // ========== Notifications ==========
        async function loadNotifications() {
            try {
                const result = await callGAS('user/notifications', { unreadOnly: 'true' });
                
                if (result.success) {
                    state.notifications = result.data?.notifications || [];
                    const unreadCount = result.data?.unreadCount || 0;
                    
                    if (unreadCount > 0) {
                        elements.notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        elements.notificationBadge.classList.remove('hidden');
                    } else {
                        elements.notificationBadge.classList.add('hidden');
                    }
                }
                
            } catch (error) {
                console.error('Load notifications error:', error);
            }
        }
        
        window.showNotifications = async function() {
            const modal = document.getElementById('notificationsModal');
            const list = document.getElementById('notificationsList');
            
            await loadNotifications();
            
            if (!state.notifications.length) {
                list.innerHTML = '<p class="text-center text-gray-400 py-8">ไม่มีการแจ้งเตือน</p>';
            } else {
                list.innerHTML = state.notifications.map(notif => `
                    <div class="p-4 bg-[#111317] rounded-xl border border-[#2a2e36]">
                        <div class="flex gap-3">
                            <i class="fas fa-${notif.icon || 'bell'} text-[#06c755]"></i>
                            <div>
                                <h4 class="text-white">${notif.title}</h4>
                                <p class="text-sm text-gray-400">${notif.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${formatDate(notif.createdAt)}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            modal.classList.remove('hidden');
        };
        
        window.markAllNotificationsRead = async function() {
            try {
                const result = await callGAS('notifications/mark-read', { markAll: 'true' });
                
                if (result.success) {
                    elements.notificationBadge.classList.add('hidden');
                    showToast('ทำเครื่องหมายว่าอ่านทั้งหมดแล้ว');
                }
                
            } catch (error) {
                console.error('Mark all read error:', error);
            }
        };
        
        // ========== Modal Controls ==========
        function closeModal() {
            document.getElementById('activityModal').classList.add('hidden');
        }
        
        function closeRegistrationsModal() {
            document.getElementById('registrationsModal').classList.add('hidden');
        }
        
        function closeNotificationsModal() {
            document.getElementById('notificationsModal').classList.add('hidden');
        }
        
        window.closeModal = closeModal;
        window.closeRegistrationsModal = closeRegistrationsModal;
        window.closeNotificationsModal = closeNotificationsModal;
        window.closeCreateActivityModal = closeCreateActivityModal;
        window.closeManageActivitiesModal = closeManageActivitiesModal;
        
        // ========== Event Listeners ==========
        elements.prevPage.addEventListener('click', () => {
            if (state.currentPage > 1) {
                state.currentPage--;
                loadActivities();
            }
        });
        
        elements.nextPage.addEventListener('click', () => {
            if (state.currentPage < state.totalPages) {
                state.currentPage++;
                loadActivities();
            }
        });
        
        let searchTimeout;
        elements.searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                state.searchKeyword = e.target.value;
                state.currentPage = 1;
                loadActivities();
            }, 500);
        });
        
        elements.statusFilter.addEventListener('change', (e) => {
            state.currentFilter = e.target.value;
            state.currentPage = 1;
            loadActivities();
        });
        
        elements.categoryFilter.addEventListener('change', (e) => {
            state.currentCategory = e.target.value;
            state.currentPage = 1;
            loadActivities();
        });
        
        elements.notificationsBtn.addEventListener('click', showNotifications);
        
        // Close modals on outside click
        window.onclick = function(event) {
            const modals = [
                'activityModal', 'registrationsModal', 'notificationsModal',
                'createActivityModal', 'manageActivitiesModal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        };
    </script>
</body>
</html>
