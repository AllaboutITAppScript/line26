<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title id="page-title">iTNews ¬∑ LINE</title>
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>">
    
    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://static.line-scdn.net">
    
    <!-- Critical CSS - Inline for fastest render -->
    <style>
        /* Reset & Base */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'IBM Plex Sans Thai',sans-serif}
        body{background:#0a0a0f;color:#fff;padding-bottom:70px}
        
        /* Core Variables */
        :root{--primary:#06c755;--bg:#0a0a0f;--bg-card:#1a1d24;--border:#2a2e36}
        
        /* Layout */
        .navbar{position:sticky;top:0;z-index:40;background:rgba(10,10,15,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:12px 16px}
        .navbar-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
        .navbar-logo{display:flex;align-items:center;gap:8px;cursor:pointer}
        .navbar-logo i{color:var(--primary);font-size:24px}
        .navbar-logo span{font-size:18px;font-weight:600;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(26,29,36,.95);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0;z-index:50;backdrop-filter:blur(10px)}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;color:#9ca3af;font-size:12px;cursor:pointer}
        .nav-item.active{color:var(--primary)}
        .nav-item i{font-size:20px}
        .tab-content{display:none}
        .tab-content.active{display:block}
        
        /* Loading States */
        .initial-loading{position:fixed;inset:0;background:var(--bg);z-index:2000;display:flex;align-items:center;justify-content:center;transition:opacity .15s}
        .initial-loading.hide{opacity:0;pointer-events:none}
        .loading-spinner{width:60px;height:60px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
        .skeleton-card{background:linear-gradient(90deg,#1a1d24 25%,#252930 50%,#1a1d24 75%);background-size:200% 100%;animation:loading 1s infinite;border-radius:20px;height:300px}
        @keyframes spin{to{transform:rotate(360deg)}}
        @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
        
        /* Profile */
        .profile-header{background:var(--bg-card);border-radius:20px;padding:16px;margin:16px;display:flex;align-items:center;gap:16px;border:1px solid var(--border);cursor:pointer;max-width:1200px;margin-left:auto;margin-right:auto}
        .profile-avatar{width:60px;height:60px;border-radius:30px;border:3px solid var(--primary);object-fit:cover}
        
        /* Grid */
        .posts-grid{display:grid;gap:16px;padding:0 16px;max-width:1200px;margin:0 auto}
        @media (min-width:1024px){.posts-grid{grid-template-columns:repeat(3,1fr)}}
        @media (max-width:1023px){.posts-grid{grid-template-columns:1fr}}
        
        /* Cards */
        .news-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;overflow:hidden;cursor:pointer}
        .news-image{width:100%;height:200px;object-fit:cover;background:#2a2e36}
        .news-content{padding:16px}
        
        /* Badges */
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;display:inline-block}
        .badge-news{background:rgba(6,199,85,.15);color:var(--primary);border:1px solid rgba(6,199,85,.3)}
        .badge-event{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}
        .badge-urgent{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
        .badge-pending{background:rgba(255,193,7,.15);color:#ffc107;border:1px solid rgba(255,193,7,.3)}
        
        /* Buttons */
        .btn-primary{background:var(--primary);color:white;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
        .btn-primary.loading{color:transparent;pointer-events:none;position:relative}
        .btn-primary.loading::after{content:'';position:absolute;width:20px;height:20px;top:50%;left:50%;margin:-10px 0 0 -10px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite}
        
        .btn-outline{background:transparent;border:1px solid var(--border);color:#fff;padding:12px 24px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px}
        .btn-danger{background:#ef4444;color:#fff;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer}
        .btn-share{background:#00B900;color:#fff;padding:12px 24px;border-radius:12px;font-weight:500;border:none;cursor:pointer}
        
        /* Search & Filters */
        .search-box{position:relative;max-width:1200px;margin:0 auto 16px;padding:0 16px}
        .search-box input{width:100%;padding:12px 12px 12px 44px;background:var(--bg-card);border:1px solid var(--border);border-radius:30px;color:#fff}
        .search-box input:focus{outline:none;border-color:var(--primary)}
        .search-box i{position:absolute;left:28px;top:50%;transform:translateY(-50%);color:#9ca3af}
        
        .filter-container{display:flex;gap:8px;overflow-x:auto;padding:0 16px 8px;max-width:1200px;margin:0 auto 16px}
        .filter-btn{padding:8px 16px;border-radius:30px;font-size:14px;white-space:nowrap;background:var(--bg-card);border:1px solid var(--border);color:#9ca3af;cursor:pointer}
        .filter-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        
        /* Modal */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.98);z-index:1000;display:none}
        .modal.active{display:flex}
        .modal-content{background:var(--bg-card);width:100%;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
        @media (min-width:768px){.modal-content{width:90%;max-width:800px;height:90vh;margin:20px auto;border-radius:24px}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--border)}
        .modal-close{color:#9ca3af;font-size:24px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.05)}
        
        /* Utilities */
        .hidden{display:none!important}
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .floating-create-btn{position:fixed;bottom:90px;right:20px;background:var(--primary);color:#fff;width:60px;height:60px;border-radius:30px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(6,199,85,.3);cursor:pointer;z-index:100}
        
        /* Admin */
        .admin-section{background:linear-gradient(135deg,rgba(6,199,85,.1),transparent);border:1px solid var(--primary);border-radius:16px;padding:16px;margin-bottom:16px}
        .admin-tab-btn{padding:12px;border-bottom:2px solid transparent;cursor:pointer}
        .admin-tab-btn.active{border-bottom-color:var(--primary);color:var(--primary);font-weight:600}
        .user-row{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;margin-bottom:8px}
        
        /* Comments */
        .modal-comment-input-area{display:flex;gap:8px;margin-bottom:16px}
        .modal-comment-input{flex:1;background:#0a0a0f;border:1px solid var(--border);border-radius:20px;padding:10px 14px;color:#fff;resize:none;min-height:60px}
        .modal-comment-item{display:flex;gap:10px;padding:12px;background:#0a0a0f;border-radius:12px;margin-bottom:8px}
        .modal-comment-avatar{width:32px;height:32px;border-radius:16px;object-fit:cover}
    </style>
    
    <!-- Defer non-critical CSS -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </noscript>
    
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js" async></script>
</head>
<body>
    <!-- Initial Loading -->
    <div class="initial-loading" id="initial-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text mt-4 text-[#06c755]">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    
    <!-- Floating Create Button -->
    <div id="floating-create-btn" class="floating-create-btn hidden" onclick="showCreatePostModal()">
        <i class="fas fa-plus text-2xl"></i>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-logo" onclick="goHome()">
                <i class="fas fa-newspaper"></i>
                <span id="navbar-app-name">iTNews</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Tab: Home -->
        <div id="tab-home" class="tab-content active">
            <!-- Profile Header -->
            <div class="profile-header" id="profile-header">
                <img id="profile-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Ccircle cx='30' cy='30' r='30' fill='%232a2e36'/%3E%3Ctext x='30' y='38' font-size='20' text-anchor='middle' fill='%2306c755' font-family='Arial'%3Eüë§%3C/text%3E%3C/svg%3E" alt="avatar" class="profile-avatar">
                <div class="flex-1">
                    <h2 id="profile-name" class="text-lg font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
                    <p id="profile-email" class="text-sm text-gray-400"></p>
                    <p id="profile-role" class="text-xs text-[#06c755] mt-1"></p>
                </div>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-2 max-w-7xl mx-auto px-4 mb-4">
                <div class="stat-card bg-[#1a1d24] p-4 rounded-xl text-center border border-[#2a2e36]">
                    <p class="text-xs text-gray-400">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</p>
                    <p id="stat-news" class="text-xl font-bold text-[#06c755]">0</p>
                </div>
                <div class="stat-card bg-[#1a1d24] p-4 rounded-xl text-center border border-[#2a2e36]">
                    <p class="text-xs text-gray-400">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                    <p id="stat-events" class="text-xl font-bold text-[#06c755]">0</p>
                </div>
                <div class="stat-card bg-[#1a1d24] p-4 rounded-xl text-center border border-[#2a2e36]">
                    <p class="text-xs text-gray-400">‡∏î‡πà‡∏ß‡∏ô</p>
                    <p id="stat-urgent" class="text-xl font-bold text-[#06c755]">0</p>
                </div>
            </div>

            <!-- Hero Slider -->
            <div class="swiper hero-swiper max-w-7xl mx-auto px-4 mb-4" style="height:220px;background:#1a1d24;border-radius:20px;position:relative;overflow:hidden">
                <div class="swiper-wrapper" id="hero-slider-wrapper">
                    <div class="swiper-slide">
                        <div style="width:100%;height:220px;background:#1a1d24;display:flex;align-items:center;justify-content:center;color:#06c755">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                </div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." autocomplete="off">
            </div>

            <!-- Filter -->
            <div class="filter-container">
                <button class="filter-btn active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" data-filter="news">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</button>
                <button class="filter-btn" data-filter="event">üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                <button class="filter-btn" data-filter="urgent">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</button>
            </div>

            <!-- Posts List -->
            <div id="posts-list" class="posts-grid">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
            
            <!-- Pagination -->
            <div id="pagination-container" class="flex justify-center items-center gap-2 mt-6 mb-4 hidden">
                <button class="btn-pagination bg-[#1a1d24] border border-[#2a2e36] text-white px-3 py-2 rounded-lg" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="page-info" class="text-gray-400 text-sm">‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏à‡∏≤‡∏Å 1</span>
                <button class="btn-pagination bg-[#1a1d24] border border-[#2a2e36] text-white px-3 py-2 rounded-lg" id="next-page" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab: My Posts -->
        <div id="tab-my" class="tab-content">
            <div class="flex justify-between items-center max-w-7xl mx-auto px-4 mb-4">
                <h2 class="text-xl font-bold text-[#06c755]">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button id="create-post-btn" class="bg-[#06c755] text-white px-4 py-2 rounded-xl text-sm hidden" onclick="showCreatePostModal()">
                    <i class="fas fa-plus mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á
                </button>
            </div>
            <div id="my-posts-list" class="posts-grid"></div>
        </div>

        <!-- Tab: Admin -->
        <div id="tab-admin" class="tab-content">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-[#06c755]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <button id="refresh-admin" class="text-[#06c755] text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>

                <!-- Admin Stats -->
                <div class="admin-section">
                    <h3 class="font-semibold mb-3">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-[#1a1d24] p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-400">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                            <p id="admin-users" class="text-xl font-bold text-[#06c755]">0</p>
                        </div>
                        <div class="bg-[#1a1d24] p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-400">‡πÇ‡∏û‡∏™‡∏ï‡πå</p>
                            <p id="admin-posts" class="text-xl font-bold text-[#06c755]">0</p>
                        </div>
                        <div class="bg-[#1a1d24] p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                            <p id="admin-today" class="text-xl font-bold text-[#06c755]">0</p>
                        </div>
                        <div class="bg-[#1a1d24] p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-400">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                            <p id="admin-pending" class="text-xl font-bold text-yellow-500">0</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div class="flex border-b border-[#2a2e36] mb-4 overflow-x-auto">
                    <button class="admin-tab-btn flex-1 py-2 text-center active" data-admin-tab="posts">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="pending">
                        ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <span id="pending-badge" class="ml-1 bg-yellow-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden">0</span>
                    </button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="users">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="comments">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</button>
                    <button class="admin-tab-btn flex-1 py-2 text-center" data-admin-tab="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>

                <!-- Admin: Posts -->
                <div id="admin-posts-tab" class="admin-tab">
                    <button class="btn-primary mb-4" onclick="showCreatePostModal()">
                        <i class="fas fa-plus mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <div id="admin-posts-list" class="space-y-2"></div>
                </div>

                <!-- Admin: Pending -->
                <div id="admin-pending-tab" class="admin-tab hidden">
                    <h3 class="font-semibold mb-3">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                    <div id="pending-posts-list" class="space-y-3"></div>
                </div>

                <!-- Admin: Users -->
                <div id="admin-users-tab" class="admin-tab hidden">
                    <div class="search-box px-0 mb-4">
                        <i class="fas fa-search"></i>
                        <input type="text" id="user-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..." autocomplete="off">
                    </div>
                    <div id="users-list" class="space-y-2"></div>
                </div>

                <!-- Admin: Comments -->
                <div id="admin-comments-tab" class="admin-tab hidden">
                    <h3 class="font-semibold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h3>
                    <div class="search-box px-0 mb-4">
                        <i class="fas fa-search"></i>
                        <input type="text" id="admin-comment-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
                    </div>
                    <div id="admin-comments-list" class="space-y-2"></div>
                </div>

                <!-- Admin: Settings -->
                <div id="admin-settings-tab" class="admin-tab hidden">
                    <div class="admin-section">
                        <h3 class="font-semibold mb-3">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <form id="settings-form" onsubmit="saveSettings(event)">
                            <label class="block text-sm text-gray-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</label>
                            <input type="text" id="setting-app-name" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3 mb-3" value="iTNews" required>
                            
                            <label class="block text-sm text-gray-400 mb-1">Google Drive Folder ID</label>
                            <input type="text" id="setting-drive-folder" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3 mb-3" value="18V_3SzGvCIfwbRqIpIEwRSVdA88T8mcE" required>
                            
                            <div class="mb-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="setting-require-approval" class="w-4 h-4 text-[#06c755] rounded border-gray-600">
                                    <span class="text-sm text-gray-400 select-none">‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</span>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn-primary" id="settings-save-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Detail Modal -->
        <div class="modal" id="post-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title text-lg font-semibold pr-4" id="modal-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body flex-1 overflow-y-auto p-4" id="modal-body">
                    <div class="flex justify-center items-center py-10">
                        <div class="loading-spinner w-10 h-10"></div>
                    </div>
                </div>
                <div class="modal-footer flex gap-2 p-4 border-t border-[#2a2e36]">
                    <button class="btn-share flex-1" onclick="shareAsFlexMessage()" disabled id="modal-share-btn">
                        <i class="fab fa-line mr-2"></i> ‡πÅ‡∏ä‡∏£‡πå
                    </button>
                    <button class="btn-outline flex-1" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
                </div>
                <div id="modal-admin-controls" class="px-4 pb-4 hidden">
                    <p class="text-sm text-gray-400 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå</p>
                    <div class="flex gap-2">
                        <button id="modal-edit-btn" class="btn-outline flex-1 text-sm" onclick="editCurrentPost()" disabled>
                            <i class="fas fa-edit mr-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button id="modal-delete-btn" class="btn-danger flex-1 text-sm" onclick="deleteCurrentPost()" disabled>
                            <i class="fas fa-trash mr-2"></i>‡∏•‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create/Edit Post Modal -->
        <div class="modal" id="create-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title text-lg font-semibold" id="create-modal-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</h3>
                    <button class="modal-close" onclick="closeCreateModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body flex-1 overflow-y-auto p-4">
                    <form id="post-form" onsubmit="savePost(event)">
                        <input type="hidden" id="edit-post-id">
                        <select id="post-type" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3 mb-3" required>
                            <option value="news">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</option>
                            <option value="event">üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
                            <option value="urgent">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</option>
                        </select>
                        <input type="text" id="post-title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3 mb-3" required maxlength="100">
                        <textarea id="post-content" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3 mb-3" rows="5" required maxlength="5000"></textarea>
                        <div class="upload-area border-2 border-dashed border-[#2a2e36] rounded-xl p-5 text-center mb-3 cursor-pointer" onclick="document.getElementById('post-image-file').click()">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                        </div>
                        <input type="file" id="post-image-file" accept="image/*" style="display: none" onchange="previewImage(this)">
                        <img id="image-preview" class="w-full max-h-48 object-cover rounded-xl mt-3 hidden">
                        <input type="hidden" id="post-image">
                        <input type="text" id="post-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3">
                    </form>
                </div>
                <div class="modal-footer flex gap-2 p-4 border-t border-[#2a2e36]">
                    <button type="submit" form="post-form" class="btn-primary flex-1" id="save-post-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn-outline flex-1" onclick="closeCreateModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Profile Settings Modal -->
        <div class="modal" id="profile-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title text-lg font-semibold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
                    <button class="modal-close" onclick="closeProfileModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body flex-1 overflow-y-auto p-4">
                    <form id="profile-form" onsubmit="saveProfile(event)">
                        <input type="text" id="profile-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3 mb-3" maxlength="10">
                        <input type="text" id="profile-department" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3" maxlength="50">
                    </form>
                </div>
                <div class="modal-footer flex gap-2 p-4 border-t border-[#2a2e36]">
                    <button type="submit" form="profile-form" class="btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn-outline flex-1" onclick="closeProfileModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Role Modal -->
        <div class="modal" id="role-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title text-lg font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                    <button class="modal-close" onclick="closeRoleModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body flex-1 overflow-y-auto p-4">
                    <form id="role-form" onsubmit="saveUserRole(event)">
                        <input type="hidden" id="role-user-id">
                        <p id="role-user-name" class="text-white mb-4"></p>
                        <select id="user-role" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3">
                            <option value="user">üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="editor">‚úèÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</option>
                            <option value="admin">üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                        </select>
                    </form>
                </div>
                <div class="modal-footer flex gap-2 p-4 border-t border-[#2a2e36]">
                    <button type="submit" form="role-form" class="btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn-outline flex-1" onclick="closeRoleModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Edit Comment Modal -->
        <div class="modal" id="edit-comment-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title text-lg font-semibold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h3>
                    <button class="modal-close" onclick="closeEditCommentModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body flex-1 overflow-y-auto p-4">
                    <form id="edit-comment-form" onsubmit="saveEditedComment(event)">
                        <input type="hidden" id="edit-comment-id">
                        <textarea id="edit-comment-content" class="w-full bg-[#1a1d24] border border-[#2a2e36] text-white rounded-xl p-3" rows="4" required maxlength="500"></textarea>
                    </form>
                </div>
                <div class="modal-footer flex gap-2 p-4 border-t border-[#2a2e36]">
                    <button type="submit" form="edit-comment-form" class="btn-primary flex-1" id="edit-comment-save-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn-outline flex-1" onclick="closeEditCommentModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home">
            <i class="fas fa-home"></i>
            <span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </div>
        <div class="nav-item" data-tab="my">
            <i class="fas fa-pen-fancy"></i>
            <span>‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
        </div>
        <div class="nav-item hidden admin-only" data-tab="admin">
            <i class="fas fa-cog"></i>
            <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
        </div>
    </div>

    <!-- Core Script - Optimized for speed -->
    <script>
        (function() {
            // ========== CONFIG ==========
            const CONFIG = {
                GAS_URL: 'https://script.google.com/macros/s/AKfycbwSz6Y_fpvB0qN52eS6QD2RFJD-bJA369B6b86W1ZGVCOrbPXGGbpBIS3hDO8h6awKzkw/exec',
                LIFF_ID: '2008904120-T7I0VPZf',
                PAGE_SIZE: 9,
                DRIVE_FOLDER_ID: '18V_3SzGvCIfwbRqIpIEwRSVdA88T8mcE'
            };

            // ========== STATE ==========
            const state = {
                user: null,
                posts: [],
                myPosts: [],
                pendingPosts: [],
                users: [],
                comments: {},
                allComments: [],
                currentFilter: 'all',
                searchTerm: '',
                isAdmin: false,
                isEditor: false,
                currentPage: 1,
                totalPages: 1,
                currentPost: null,
                settings: { appName: 'iTNews' },
                urgentPosts: [],
                initialized: false,
                loading: false
            };

            // ========== DOM Cache ==========
            const $ = {};

            // ========== UTILS ==========
            function showToast(msg, type = 'success') {
                const toast = document.createElement('div');
                toast.style.cssText = `position:fixed;bottom:80px;left:16px;right:16px;background:#1a1d24;border-left:4px solid ${type === 'success' ? '#06c755' : '#ef4444'};border-radius:12px;padding:12px 16px;color:white;z-index:2000;max-width:400px;margin:0 auto;box-shadow:0 4px 12px rgba(0,0,0,0.5);animation:slideUp 0.3s ease`;
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }

            function formatDate(dateStr) {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
            }

            function formatDateTime(dateStr) {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleString('th-TH');
            }

            // ========== DOM Cache Init ==========
            function initDOMCache() {
                const ids = [
                    'initial-loading', 'page-title', 'navbar-app-name', 'tab-home', 'tab-my', 'tab-admin',
                    'posts-list', 'my-posts-list', 'admin-posts-list', 'pending-posts-list', 'users-list',
                    'admin-comments-list', 'profile-name', 'profile-email', 'profile-avatar', 'profile-role',
                    'stat-news', 'stat-events', 'stat-urgent', 'search-input', 'post-modal', 'modal-body',
                    'modal-title', 'modal-share-btn', 'modal-edit-btn', 'modal-delete-btn', 'modal-admin-controls',
                    'floating-create-btn', 'create-post-btn', 'hero-slider-wrapper', 'pagination-container',
                    'page-info', 'prev-page', 'next-page', 'refresh-admin', 'admin-users', 'admin-posts',
                    'admin-today', 'admin-pending', 'pending-badge', 'user-search', 'admin-comment-search',
                    'settings-save-btn', 'setting-require-approval'
                ];
                
                ids.forEach(id => {
                    $[id] = document.getElementById(id);
                });
                
                $.filterBtns = document.querySelectorAll('.filter-btn');
                $.navItems = document.querySelectorAll('.nav-item');
                $.adminOnly = document.querySelectorAll('.admin-only');
            }

            // ========== API CALL ==========
            async function callGAS(path, data = {}) {
                try {
                    const formData = new FormData();
                    formData.append('path', path);
                    if (state.user?.lineUserId) formData.append('lineUserId', state.user.lineUserId);
                    
                    Object.keys(data).forEach(key => {
                        if (data[key] !== undefined && data[key] !== null) {
                            formData.append(key, data[key]);
                        }
                    });

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);

                    const res = await fetch(CONFIG.GAS_URL, { 
                        method: 'POST', 
                        body: formData,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const text = await res.text();
                    return JSON.parse(text);
                } catch (error) {
                    return { success: false, message: 'connection error' };
                }
            }

            // ========== UPDATE APP NAME ==========
            function updateAppName(name) {
                if ($['page-title']) $['page-title'].textContent = (name || 'iTNews') + ' ¬∑ LINE';
                if ($['navbar-app-name']) $['navbar-app-name'].textContent = name || 'iTNews';
            }

            // ========== LIFF INIT ==========
            async function initLIFF() {
                try {
                    initDOMCache();
                    
                    // Load settings first
                    await loadSettings();
                    
                    // Show cached user if available
                    const cachedUser = localStorage.getItem('user_cache');
                    if (cachedUser) {
                        try {
                            state.user = JSON.parse(cachedUser);
                            state.isAdmin = state.user.role === 'admin';
                            state.isEditor = state.isAdmin || state.user.role === 'editor';
                            updateUIWithUser();
                        } catch (e) {}
                    }

                    // Initialize LIFF
                    await liff.init({ liffId: CONFIG.LIFF_ID });
                    
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }

                    // Get profile
                    const profile = await liff.getProfile();
                    const idToken = liff.getDecodedIDToken();

                    const result = await callGAS('user/profile', {
                        lineUserId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl || '',
                        email: idToken?.email || ''
                    });

                    if (result.success) {
                        state.user = result.data;
                        state.isAdmin = state.user.role === 'admin';
                        state.isEditor = state.isAdmin || state.user.role === 'editor';
                        
                        localStorage.setItem('user_cache', JSON.stringify(state.user));
                        
                        updateUIWithUser();

                        // Load data
                        await Promise.all([
                            loadPosts(),
                            loadUrgentPosts(),
                            loadMyPosts()
                        ]);

                        if (state.isAdmin) {
                            loadUsers();
                            loadAdminStats();
                            loadPendingPosts();
                            loadAllComments();
                        }
                    }

                    if ($['initial-loading']) $['initial-loading'].classList.add('hide');
                    state.initialized = true;

                } catch (error) {
                    console.error('LIFF error:', error);
                    if ($['initial-loading']) $['initial-loading'].classList.add('hide');
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ', 'error');
                }
            }

            function updateUIWithUser() {
                if (!state.user) return;
                
                if ($['profile-name']) $['profile-name'].textContent = state.user.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                if ($['profile-email']) $['profile-email'].textContent = state.user.email || '';
                if ($['profile-avatar']) $['profile-avatar'].src = state.user.pictureUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\' viewBox=\'0 0 60 60\'%3E%3Ccircle cx=\'30\' cy=\'30\' r=\'30\' fill=\'%232a2e36\'/%3E%3Ctext x=\'30\' y=\'38\' font-size=\'20\' text-anchor=\'middle\' fill=\'%2306c755\' font-family=\'Arial\'%3Eüë§%3C/text%3E%3C/svg%3E';
                if ($['profile-role']) {
                    $['profile-role'].textContent = {
                        admin: 'üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                        editor: '‚úèÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô',
                        user: 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'
                    }[state.user.role] || '';
                }

                $.adminOnly.forEach(el => {
                    if (state.isAdmin) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                });

                if (state.isEditor) {
                    if ($['floating-create-btn']) $['floating-create-btn'].classList.remove('hidden');
                    if ($['create-post-btn']) $['create-post-btn'].classList.remove('hidden');
                }
            }

            // ========== POSTS ==========
            async function loadPosts() {
                if (state.loading) return;
                state.loading = true;

                const result = await callGAS('posts', {
                    page: state.currentPage,
                    filter: state.currentFilter,
                    search: state.searchTerm,
                    pageSize: CONFIG.PAGE_SIZE,
                    includePending: state.isAdmin
                });

                if (result.success) {
                    state.posts = result.data.posts || [];
                    state.totalPages = Math.ceil((result.data.total || 0) / CONFIG.PAGE_SIZE) || 1;

                    if ($['stat-news']) $['stat-news'].textContent = result.data.stats?.news || 0;
                    if ($['stat-events']) $['stat-events'].textContent = result.data.stats?.events || 0;
                    if ($['stat-urgent']) $['stat-urgent'].textContent = result.data.stats?.urgent || 0;

                    renderPosts();
                    updatePagination();
                }

                state.loading = false;
            }

            function renderPosts() {
                if (!$['posts-list']) return;
                
                let filtered = state.posts;
                if (!state.isAdmin) {
                    filtered = state.posts.filter(p => p.approvalStatus === 'approved');
                }

                if (!filtered.length) {
                    $['posts-list'].innerHTML = '<div class="col-span-full text-center py-10 text-gray-400"><i class="fas fa-newspaper text-3xl mb-3"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p></div>';
                    return;
                }

                $['posts-list'].innerHTML = filtered.map(p => `
                    <div class="news-card" onclick="showPostDetail('${p.postId}')">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="news-image" loading="lazy" onerror="this.style.display='none'">` : ''}
                        <div class="news-content">
                            <div class="flex justify-between items-start mb-2">
                                <span class="badge badge-${p.type}">${{news:'üì∞', event:'üéâ', urgent:'‚ö†Ô∏è'}[p.type]}</span>
                                <span class="text-xs text-gray-500">${formatDate(p.createdAt)}</span>
                            </div>
                            <h3 class="font-semibold text-base mb-2 line-clamp-2">${p.title}</h3>
                            <p class="text-sm text-gray-400 line-clamp-2">${p.content}</p>
                            <div class="flex items-center justify-between mt-3 text-xs text-gray-500">
                                <span><i class="fas fa-user mr-1"></i> ${p.authorName || ''}</span>
                                <span><i class="far fa-comment mr-1"></i> ${p.commentCount || 0}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function updatePagination() {
                if (!$['pagination-container'] || !$['page-info'] || !$['prev-page'] || !$['next-page']) return;
                
                if (state.totalPages > 1) {
                    $['pagination-container'].classList.remove('hidden');
                    $['page-info'].textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${state.currentPage} ‡∏à‡∏≤‡∏Å ${state.totalPages}`;
                    $['prev-page'].disabled = state.currentPage <= 1;
                    $['next-page'].disabled = state.currentPage >= state.totalPages;
                } else {
                    $['pagination-container'].classList.add('hidden');
                }
            }

            window.changePage = function(direction) {
                if (direction === 'prev' && state.currentPage > 1) {
                    state.currentPage--;
                    loadPosts();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (direction === 'next' && state.currentPage < state.totalPages) {
                    state.currentPage++;
                    loadPosts();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            // ========== URGENT POSTS ==========
            async function loadUrgentPosts() {
                const result = await callGAS('posts', {
                    filter: 'urgent',
                    pageSize: 5,
                    includePending: false
                });

                if (result.success) {
                    state.urgentPosts = result.data.posts?.filter(p => p.approvalStatus === 'approved') || [];
                    renderHeroSlider();
                }
            }

            function renderHeroSlider() {
                if (!$['hero-slider-wrapper']) return;
                
                const urgent = state.urgentPosts.slice(0, 5);
                
                if (!urgent.length) {
                    $['hero-slider-wrapper'].innerHTML = `
                        <div class="swiper-slide">
                            <div style="width:100%;height:220px;background:#1a1d24;display:flex;align-items:center;justify-content:center;color:#06c755">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</div>
                        </div>
                    `;
                    return;
                }

                $['hero-slider-wrapper'].innerHTML = urgent.map(p => `
                    <div class="swiper-slide cursor-pointer" onclick="showPostDetail('${p.postId}')">
                        <img src="${p.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'220\' viewBox=\'0 0 400 220\'%3E%3Crect width=\'400\' height=\'220\' fill=\'%232a2e36\'/%3E%3Ctext x=\'200\' y=\'110\' font-size=\'20\' text-anchor=\'middle\' fill=\'%23ef4444\' font-family=\'Arial\'%3E‚ö†Ô∏è URGENT%3C/text%3E%3C/svg%3E'}" class="w-full h-full object-cover" loading="lazy">
                        <span class="absolute top-3 right-3 bg-red-500 text-white px-2 py-1 rounded-full text-xs">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</span>
                        <div class="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-black to-transparent">
                            <h3 class="font-bold text-white line-clamp-2">${p.title}</h3>
                            <p class="text-xs text-gray-300 mt-1">${formatDate(p.createdAt)}</p>
                        </div>
                    </div>
                `).join('');
            }

            // ========== MY POSTS ==========
            async function loadMyPosts() {
                const result = await callGAS('user/posts', {
                    lineUserId: state.user?.lineUserId,
                    pageSize: 20
                });

                if (result.success) {
                    state.myPosts = result.data.posts || result.data || [];
                    renderMyPosts();
                }
            }

            function renderMyPosts() {
                if (!$['my-posts-list']) return;
                
                if (!state.myPosts.length) {
                    $['my-posts-list'].innerHTML = '<div class="col-span-full text-center py-10 text-gray-400"><i class="fas fa-pen-fancy text-3xl mb-3"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p></div>';
                    return;
                }

                $['my-posts-list'].innerHTML = state.myPosts.map(p => `
                    <div class="news-card" onclick="showPostDetail('${p.postId}')">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="news-image" loading="lazy">` : ''}
                        <div class="news-content">
                            <div class="flex justify-between items-start mb-2">
                                <span class="badge badge-${p.type}">${{news:'üì∞', event:'üéâ', urgent:'‚ö†Ô∏è'}[p.type]}</span>
                                <span class="text-xs ${p.approvalStatus === 'approved' ? 'text-green-500' : 'text-yellow-500'}">
                                    ${p.approvalStatus === 'approved' ? '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
                                </span>
                            </div>
                            <h3 class="font-semibold text-base mb-2 line-clamp-2">${p.title}</h3>
                            <p class="text-sm text-gray-400 line-clamp-2">${p.content}</p>
                            <div class="text-xs text-gray-500 mt-2">${formatDate(p.createdAt)}</div>
                        </div>
                    </div>
                `).join('');
            }

            // ========== POST DETAIL ==========
            window.showPostDetail = async function(postId) {
                if (!$['post-modal'] || !$['modal-body'] || !$['modal-title']) return;
                
                $['post-modal'].classList.add('active');
                $['modal-body'].innerHTML = '<div class="flex justify-center py-10"><div class="loading-spinner w-10 h-10"></div></div>';
                
                const result = await callGAS('post', { postId });
                
                if (result.success) {
                    const p = result.data;
                    state.currentPost = p;
                    $['modal-title'].textContent = p.title;

                    const canEdit = state.isAdmin || (state.isEditor && p.authorId === state.user?.lineUserId);
                    const canDelete = state.isAdmin || (state.isEditor && p.authorId === state.user?.lineUserId);

                    $['modal-body'].innerHTML = `
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full max-h-80 object-cover rounded-xl mb-4" loading="lazy">` : ''}
                        <div class="flex gap-2 mb-4">
                            <span class="badge badge-${p.type}">${{news:'üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£', event:'üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', urgent:'‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô'}[p.type]}</span>
                            ${p.approvalStatus !== 'approved' ? '<span class="badge badge-pending">‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>' : ''}
                        </div>
                        <p class="whitespace-pre-wrap mb-6 leading-relaxed">${p.content}</p>
                        ${p.link ? `<a href="${p.link}" target="_blank" class="block text-center bg-gradient-to-r from-[#2a2e36] to-[#1a1d24] text-[#06c755] p-4 rounded-xl border-2 border-[#06c755] mb-6 no-underline">üîó ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>` : ''}
                        <div class="text-xs text-gray-400 border-t border-[#2a2e36] pt-4">
                            <p>‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢: ${p.authorName || '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'}</p>
                            <p class="mt-1">${formatDateTime(p.createdAt)}</p>
                        </div>
                    `;

                    if ($['modal-share-btn']) $['modal-share-btn'].disabled = false;

                    if (canEdit || canDelete) {
                        if ($['modal-admin-controls']) $['modal-admin-controls'].classList.remove('hidden');
                        if ($['modal-edit-btn']) {
                            $['modal-edit-btn'].style.display = canEdit ? 'flex' : 'none';
                            $['modal-edit-btn'].disabled = false;
                        }
                        if ($['modal-delete-btn']) {
                            $['modal-delete-btn'].style.display = canDelete ? 'flex' : 'none';
                            $['modal-delete-btn'].disabled = false;
                        }
                    } else {
                        if ($['modal-admin-controls']) $['modal-admin-controls'].classList.add('hidden');
                    }

                    loadComments(postId);
                }
            };

            window.closeModal = function() {
                if ($['post-modal']) $['post-modal'].classList.remove('active');
                state.currentPost = null;
            };

            // ========== COMMENTS ==========
            async function loadComments(postId) {
                const result = await callGAS('post/comments', { postId });
                if (result.success) {
                    state.comments[postId] = result.data || [];
                    renderComments(postId);
                }
            }

            function renderComments(postId) {
                const comments = state.comments[postId] || [];
                
                let commentsSection = document.getElementById(`comments-section-${postId}`);
                if (!commentsSection && $['modal-body']) {
                    commentsSection = document.createElement('div');
                    commentsSection.id = `comments-section-${postId}`;
                    commentsSection.className = 'mt-5 pt-4 border-t border-[#2a2e36]';
                    $['modal-body'].appendChild(commentsSection);
                }

                if (!commentsSection) return;

                if (!comments.length) {
                    commentsSection.innerHTML = `
                        <div class="flex items-center gap-2 mb-4">
                            <i class="far fa-comment-dots text-[#06c755]"></i>
                            <span class="font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (0)</span>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <textarea id="comment-input-${postId}" class="flex-1 bg-[#0a0a0f] border border-[#2a2e36] rounded-2xl p-3 text-white resize-none min-h-[60px]" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."></textarea>
                            <button class="bg-[#06c755] text-white border-none rounded-2xl px-4 font-semibold cursor-pointer h-[60px]" onclick="addComment('${postId}')">‡∏™‡πà‡∏á</button>
                        </div>
                        <div class="text-center py-5 text-gray-400 bg-[#0a0a0f] rounded-xl">
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>
                            <p class="text-xs mt-1">‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>
                        </div>
                    `;
                    return;
                }

                commentsSection.innerHTML = `
                    <div class="flex items-center gap-2 mb-4">
                        <i class="far fa-comment-dots text-[#06c755]"></i>
                        <span class="font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (${comments.length})</span>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <textarea id="comment-input-${postId}" class="flex-1 bg-[#0a0a0f] border border-[#2a2e36] rounded-2xl p-3 text-white resize-none min-h-[60px]" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."></textarea>
                        <button class="bg-[#06c755] text-white border-none rounded-2xl px-4 font-semibold cursor-pointer h-[60px]" onclick="addComment('${postId}')">‡∏™‡πà‡∏á</button>
                    </div>
                    <div class="max-h-80 overflow-y-auto pr-1">
                        ${comments.map(c => {
                            const isOwner = c.userId === state.user?.lineUserId;
                            const isAdmin = state.isAdmin;
                            const timeAgo = formatDate(c.createdAt);
                            const isDeleted = c.status === 'deleted' || c.status === 'deleted_by_admin';
                            
                            return `<div class="flex gap-3 p-3 bg-[#0a0a0f] rounded-xl mb-2 ${isDeleted ? 'opacity-70 border-l-4 border-red-500' : ''}">
                                <img src="${c.userPicture || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'32\' height=\'32\' viewBox=\'0 0 32 32\'%3E%3Ccircle cx=\'16\' cy=\'16\' r=\'16\' fill=\'%232a2e36\'/%3E%3Ctext x=\'16\' y=\'20\' font-size=\'12\' text-anchor=\'middle\' fill=\'%2306c755\'%3Eüë§%3C/text%3E%3C/svg%3E'}" class="w-8 h-8 rounded-full object-cover">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 flex-wrap mb-1">
                                        <span class="font-semibold text-xs text-[#06c755]">${c.userName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</span>
                                        <span class="text-xs text-gray-500">${timeAgo}</span>
                                        ${isDeleted ? '<span class="text-xs bg-red-500/20 text-red-500 px-2 py-0.5 rounded-full">‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>' : ''}
                                    </div>
                                    <div class="text-sm">${isDeleted ? '<em class="text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß</em>' : c.content}</div>
                                    ${!isDeleted && (isOwner || isAdmin) ? `
                                        <div class="flex gap-2 mt-2">
                                            ${isOwner ? `<button class="text-xs text-gray-400 hover:text-[#06c755] transition-colors" onclick="showEditCommentModal('${c.commentId}')"><i class="fas fa-edit mr-1"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                                            <button class="text-xs text-gray-400 hover:text-red-500 transition-colors" onclick="deleteComment('${c.commentId}')"><i class="fas fa-trash mr-1"></i>‡∏•‡∏ö</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                `;
            }

            window.addComment = async function(postId) {
                const input = document.getElementById(`comment-input-${postId}`);
                const content = input?.value.trim();
                
                if (!content) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'error');
                    return;
                }

                const submitBtn = input?.nextElementSibling;
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('loading');
                }

                const result = await callGAS('post/comment/add', {
                    postId,
                    userId: state.user.lineUserId,
                    userName: state.user.displayName,
                    userPicture: state.user.pictureUrl,
                    content
                });

                if (result.success) {
                    if (input) input.value = '';
                    await loadComments(postId);
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    showToast(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                }

                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                }
            };

            window.showEditCommentModal = function(commentId) {
                const comment = findCommentById(commentId);
                if (!comment) return;
                
                if (comment.status === 'deleted' || comment.status === 'deleted_by_admin') {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    return;
                }
                
                document.getElementById('edit-comment-id').value = comment.commentId;
                document.getElementById('edit-comment-content').value = comment.content;
                document.getElementById('edit-comment-modal').classList.add('active');
            };

            window.closeEditCommentModal = function() {
                document.getElementById('edit-comment-modal').classList.remove('active');
            };

            window.saveEditedComment = async function(e) {
                e.preventDefault();
                
                const commentId = document.getElementById('edit-comment-id').value;
                const content = document.getElementById('edit-comment-content').value.trim();
                
                if (!content) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'error');
                    return;
                }
                
                const saveBtn = document.getElementById('edit-comment-save-btn');
                saveBtn.disabled = true;
                saveBtn.classList.add('loading');
                
                const result = await callGAS('post/comment/update', {
                    commentId,
                    content,
                    userId: state.user.lineUserId
                });
                
                if (result.success) {
                    closeEditCommentModal();
                    
                    for (let pid in state.comments) {
                        const comment = state.comments[pid].find(c => c.commentId === commentId);
                        if (comment) {
                            comment.content = content;
                            break;
                        }
                    }
                    
                    if (state.currentPost) {
                        renderComments(state.currentPost.postId);
                    }
                    
                    showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    showToast(result.message || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
                
                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
            };

            window.deleteComment = async function(commentId) {
                const comment = findCommentById(commentId);
                if (!comment) return;
                
                if (comment.status === 'deleted' || comment.status === 'deleted_by_admin') {
                    showToast('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    return;
                }

                if (!confirm('‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ?')) return;

                const result = await callGAS('post/comment/delete', {
                    commentId,
                    userId: state.user.lineUserId
                });
                
                if (result.success) {
                    for (let pid in state.comments) {
                        const idx = state.comments[pid].findIndex(c => c.commentId === commentId);
                        if (idx !== -1) {
                            state.comments[pid][idx].status = 'deleted';
                            break;
                        }
                    }
                    
                    if (state.currentPost) {
                        renderComments(state.currentPost.postId);
                    }
                    
                    showToast('‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    showToast(result.message || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
            };

            function findCommentById(commentId) {
                for (let pid in state.comments) {
                    const comment = state.comments[pid].find(c => c.commentId === commentId);
                    if (comment) return comment;
                }
                return null;
            }

            // ========== SHARE ==========
            window.shareAsFlexMessage = async function() {
                if (!state.currentPost || !liff.isInClient()) {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
                    return;
                }

                const shareBtn = $['modal-share-btn'];
                shareBtn.disabled = true;
                shareBtn.classList.add('loading');

                const p = state.currentPost;

                try {
                    await liff.shareTargetPicker([{
                        type: 'text',
                        text: `${p.title}\n\n${p.content.substring(0, 200)}${p.content.length > 200 ? '...' : ''}\n\n‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${p.link || '‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ iTNews'}`
                    }]);
                    showToast('‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } catch (error) {
                    showToast('‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                } finally {
                    shareBtn.disabled = false;
                    shareBtn.classList.remove('loading');
                }
            };

            // ========== CREATE/EDIT POST ==========
            window.showCreatePostModal = function() {
                if (!state.isEditor) {
                    showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå', 'error');
                    return;
                }

                document.getElementById('create-modal-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('edit-post-id').value = '';
                document.getElementById('post-type').value = 'news';
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('post-image').value = '';
                document.getElementById('post-link').value = '';
                document.getElementById('image-preview').style.display = 'none';
                document.getElementById('create-modal').classList.add('active');
            };

            window.closeCreateModal = function() {
                document.getElementById('create-modal').classList.remove('active');
            };

            window.previewImage = function(input) {
                const preview = document.getElementById('image-preview');
                if (input.files?.[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            };

            async function uploadImageToDrive(file) {
                try {
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });

                    const result = await callGAS('uploadImage', {
                        fileName: file.name,
                        fileType: file.type,
                        fileData: base64,
                        folderId: CONFIG.DRIVE_FOLDER_ID
                    });

                    if (result.success) {
                        return `https://lh5.googleusercontent.com/d/${result.data.fileId}=s0`;
                    }
                    return null;
                } catch {
                    return null;
                }
            }

            window.savePost = async function(e) {
                e.preventDefault();
                
                const btn = document.getElementById('save-post-btn');
                btn.disabled = true;
                btn.classList.add('loading');

                try {
                    const id = document.getElementById('edit-post-id').value;
                    let imageUrl = document.getElementById('post-image').value;
                    const file = document.getElementById('post-image-file').files[0];

                    if (file) {
                        const uploaded = await uploadImageToDrive(file);
                        if (uploaded) imageUrl = uploaded;
                    }

                    const data = {
                        type: document.getElementById('post-type').value,
                        title: document.getElementById('post-title').value,
                        content: document.getElementById('post-content').value,
                        imageUrl,
                        link: document.getElementById('post-link').value,
                        lineUserId: state.user.lineUserId
                    };

                    if (id) data.postId = id;

                    const result = await callGAS(id ? 'post/update' : 'post/create', data);

                    if (result.success) {
                        showToast(id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        closeCreateModal();
                        await Promise.all([loadPosts(), loadMyPosts(), loadUrgentPosts()]);
                    } else {
                        showToast(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                    }
                } catch {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('loading');
                }
            };

            window.editCurrentPost = function() {
                if (!state.currentPost) return;
                
                const p = state.currentPost;
                document.getElementById('create-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå';
                document.getElementById('edit-post-id').value = p.postId;
                document.getElementById('post-type').value = p.type;
                document.getElementById('post-title').value = p.title;
                document.getElementById('post-content').value = p.content;
                document.getElementById('post-image').value = p.imageUrl || '';
                document.getElementById('post-link').value = p.link || '';
                
                const preview = document.getElementById('image-preview');
                if (p.imageUrl) {
                    preview.src = p.imageUrl;
                    preview.style.display = 'block';
                }
                
                closeModal();
                document.getElementById('create-modal').classList.add('active');
            };

            window.deleteCurrentPost = async function() {
                if (!state.currentPost) return;

                if (!confirm('‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ?')) return;

                const deleteBtn = $['modal-delete-btn'];
                deleteBtn.disabled = true;
                deleteBtn.classList.add('loading');

                const result = await callGAS('post/delete', { 
                    postId: state.currentPost.postId,
                    lineUserId: state.user.lineUserId
                });

                if (result.success) {
                    showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    closeModal();
                    await Promise.all([loadPosts(), loadMyPosts(), loadUrgentPosts()]);
                } else {
                    showToast(result.message || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }

                deleteBtn.disabled = false;
                deleteBtn.classList.remove('loading');
            };

            // ========== ADMIN FUNCTIONS ==========
            async function loadAdminStats() {
                const result = await callGAS('admin/stats');
                if (result.success) {
                    if ($['admin-users']) $['admin-users'].textContent = result.data.users || 0;
                    if ($['admin-posts']) $['admin-posts'].textContent = result.data.posts || 0;
                    if ($['admin-today']) $['admin-today'].textContent = result.data.today || 0;
                    if ($['admin-pending']) $['admin-pending'].textContent = result.data.pending || 0;
                }
            }

            async function loadPendingPosts() {
                const result = await callGAS('admin/posts/pending');
                if (result.success) {
                    state.pendingPosts = result.data || [];
                    renderPendingPosts();
                    
                    const count = state.pendingPosts.length;
                    if ($['pending-badge']) {
                        if (count > 0) {
                            $['pending-badge'].textContent = count > 9 ? '9+' : count;
                            $['pending-badge'].classList.remove('hidden');
                        } else {
                            $['pending-badge'].classList.add('hidden');
                        }
                    }
                }
            }

            function renderPendingPosts() {
                if (!$['pending-posts-list']) return;
                
                if (!state.pendingPosts.length) {
                    $['pending-posts-list'].innerHTML = '<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
                    return;
                }

                $['pending-posts-list'].innerHTML = state.pendingPosts.map(p => `
                    <div class="bg-[#1a1d24] p-4 rounded-xl border border-yellow-500/30">
                        <div class="flex justify-between mb-2">
                            <span class="badge badge-pending">‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                            <span class="text-xs text-gray-500">${formatDate(p.createdAt)}</span>
                        </div>
                        <h3 class="font-semibold mb-2">${p.title}</h3>
                        <p class="text-sm text-gray-400 mb-3 line-clamp-2">${p.content}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${p.authorName}</span>
                            <div class="flex gap-2">
                                <button class="bg-green-600 text-white text-xs py-2 px-3 rounded-xl border-none cursor-pointer" onclick="approvePost('${p.postId}', this)">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="bg-red-500 text-white text-xs py-2 px-3 rounded-xl border-none cursor-pointer" onclick="rejectPost('${p.postId}', this)">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            window.approvePost = async function(postId, btn) {
                btn.disabled = true;
                btn.classList.add('loading');
                
                const result = await callGAS('admin/post/approve', { postId });
                
                if (result.success) {
                    showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    await Promise.all([loadPosts(), loadPendingPosts(), loadUrgentPosts(), loadAdminStats()]);
                } else {
                    showToast(result.message || '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
                
                btn.disabled = false;
                btn.classList.remove('loading');
            };

            window.rejectPost = async function(postId, btn) {
                btn.disabled = true;
                btn.classList.add('loading');
                
                const result = await callGAS('admin/post/reject', { postId });
                
                if (result.success) {
                    showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    await Promise.all([loadPosts(), loadPendingPosts(), loadUrgentPosts(), loadAdminStats()]);
                } else {
                    showToast(result.message || '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
                
                btn.disabled = false;
                btn.classList.remove('loading');
            };

            async function loadUsers() {
                const result = await callGAS('admin/users');
                if (result.success) {
                    state.users = result.data || [];
                    renderUsers();
                }
            }

            function renderUsers() {
                if (!$['users-list']) return;
                
                const search = $['user-search']?.value.toLowerCase() || '';
                const filtered = state.users.filter(u => 
                    u.displayName?.toLowerCase().includes(search) || 
                    u.email?.toLowerCase().includes(search)
                );

                if (!filtered.length) {
                    $['users-list'].innerHTML = '<p class="text-center text-gray-400 py-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>';
                    return;
                }

                $['users-list'].innerHTML = filtered.map(u => `
                    <div class="user-row">
                        <img src="${u.pictureUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'20\' fill=\'%232a2e36\'/%3E%3Ctext x=\'20\' y=\'25\' font-size=\'16\' text-anchor=\'middle\' fill=\'%2306c755\'%3Eüë§%3C/text%3E%3C/svg%3E'}" class="w-10 h-10 rounded-full object-cover">
                        <div class="flex-1">
                            <p class="font-semibold text-sm">${u.displayName || ''}</p>
                            <p class="text-xs text-gray-400">${u.email || ''}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${u.role === 'admin' ? 'bg-red-500/20 text-red-500' : u.role === 'editor' ? 'bg-yellow-500/20 text-yellow-500' : 'bg-gray-500/20 text-gray-400'}">
                            ${u.role === 'admin' ? 'üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' : u.role === 'editor' ? '‚úèÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô' : 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}
                        </span>
                        <button class="text-[#06c755] text-xs" onclick="showRoleModal('${u.lineUserId}', '${u.displayName}', '${u.role}')">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                `).join('');
            }

            window.showRoleModal = function(userId, userName, currentRole) {
                document.getElementById('role-user-id').value = userId;
                document.getElementById('role-user-name').textContent = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${userName}`;
                document.getElementById('user-role').value = currentRole;
                document.getElementById('role-modal').classList.add('active');
            };

            window.closeRoleModal = function() {
                document.getElementById('role-modal').classList.remove('active');
            };

            window.saveUserRole = async function(e) {
                e.preventDefault();
                
                const userId = document.getElementById('role-user-id').value;
                const role = document.getElementById('user-role').value;

                const saveBtn = e.submitter;
                saveBtn.disabled = true;
                saveBtn.classList.add('loading');

                const result = await callGAS('admin/user/role', {
                    targetUserId: userId,
                    role,
                    lineUserId: state.user.lineUserId
                });

                if (result.success) {
                    showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    closeRoleModal();
                    await loadUsers();
                    
                    if (userId === state.user?.lineUserId) {
                        const userResult = await callGAS('user/profile', {
                            lineUserId: state.user.lineUserId
                        });
                        if (userResult.success) {
                            state.user = userResult.data;
                            state.isAdmin = state.user.role === 'admin';
                            state.isEditor = state.isAdmin || state.user.role === 'editor';
                            
                            if ($['profile-role']) {
                                $['profile-role'].textContent = {
                                    admin: 'üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                                    editor: '‚úèÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô',
                                    user: 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'
                                }[state.user.role] || '';
                            }
                            
                            $.adminOnly.forEach(el => {
                                if (state.isAdmin) el.classList.remove('hidden');
                                else el.classList.add('hidden');
                            });
                        }
                    }
                } else {
                    showToast(result.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }

                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
            };

            async function loadAllComments() {
                const result = await callGAS('admin/comments');
                if (result.success) {
                    state.allComments = result.data || [];
                    renderAdminComments();
                }
            }

            function renderAdminComments() {
                if (!$['admin-comments-list']) return;
                
                const search = $['admin-comment-search']?.value.toLowerCase() || '';
                const filtered = state.allComments.filter(c => 
                    c.content?.toLowerCase().includes(search) || 
                    c.userName?.toLowerCase().includes(search)
                );

                if (!filtered.length) {
                    $['admin-comments-list'].innerHTML = '<p class="text-center text-gray-400 py-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>';
                    return;
                }

                $['admin-comments-list'].innerHTML = filtered.map(c => {
                    const statusText = c.status === 'deleted' ? ' (‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß)' : (c.status === 'deleted_by_admin' ? ' (‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)' : '');
                    
                    return `<div class="bg-[#1a1d24] p-3 rounded-lg border border-[#2a2e36]">
                        <div class="flex items-center gap-2 mb-2">
                            <img src="${c.userPicture || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\'%3E%3Ccircle cx=\'12\' cy=\'12\' r=\'12\' fill=\'%232a2e36\'/%3E%3Ctext x=\'12\' y=\'15\' font-size=\'8\' text-anchor=\'middle\' fill=\'%2306c755\'%3Eüë§%3C/text%3E%3C/svg%3E'}" class="w-6 h-6 rounded-full">
                            <span class="font-semibold text-xs text-[#06c755]">${c.userName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}${statusText}</span>
                            <span class="text-xs text-gray-500">${formatDateTime(c.createdAt)}</span>
                            ${c.status !== 'active' ? `<span class="text-xs bg-red-500/20 text-red-500 px-2 py-0.5 rounded-full">${c.status === 'deleted' ? '‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'}</span>` : ''}
                        </div>
                        <p class="text-sm mb-2">${c.status === 'active' ? c.content : '<em class="text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß</em>'}</p>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-400">‡πÇ‡∏û‡∏™‡∏ï‡πå: ${c.postId}</span>
                            ${c.status === 'active' ? `<button class="bg-red-500 text-white text-xs py-1 px-2 rounded-lg border-none cursor-pointer" onclick="adminDeleteComment('${c.commentId}', this)"><i class="fas fa-trash mr-1"></i>‡∏•‡∏ö</button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }

            window.adminDeleteComment = async function(commentId, btn) {
                if (!confirm('‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ?')) return;

                btn.disabled = true;
                btn.classList.add('loading');

                const result = await callGAS('admin/comment/delete', { 
                    commentId,
                    lineUserId: state.user.lineUserId
                });

                if (result.success) {
                    showToast('‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    await loadAllComments();
                } else {
                    showToast(result.message || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }

                btn.disabled = false;
                btn.classList.remove('loading');
            };

            async function loadSettings() {
                const result = await callGAS('settings');
                if (result.success) {
                    state.settings = result.data || { appName: 'iTNews', driveFolderId: CONFIG.DRIVE_FOLDER_ID, requireApproval: 'false' };
                    
                    document.getElementById('setting-app-name').value = state.settings.appName || 'iTNews';
                    document.getElementById('setting-drive-folder').value = state.settings.driveFolderId || CONFIG.DRIVE_FOLDER_ID;
                    
                    if ($['setting-require-approval']) {
                        const val = state.settings.requireApproval;
                        $['setting-require-approval'].checked = val === true || val === 'true' || val === '1';
                    }
                    
                    updateAppName(state.settings.appName);
                }
            }

            window.saveSettings = async function(e) {
                e.preventDefault();
                
                const appName = document.getElementById('setting-app-name').value.trim() || 'iTNews';
                const driveFolderId = document.getElementById('setting-drive-folder').value.trim() || CONFIG.DRIVE_FOLDER_ID;
                const requireApproval = $['setting-require-approval']?.checked || false;

                const saveBtn = $['settings-save-btn'];
                saveBtn.disabled = true;
                saveBtn.classList.add('loading');

                const result = await callGAS('admin/settings/update', {
                    appName,
                    driveFolderId,
                    requireApproval: requireApproval ? 'true' : 'false',
                    lineUserId: state.user.lineUserId
                });
                
                if (result.success) {
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    Object.assign(state.settings, { appName, driveFolderId, requireApproval });
                    updateAppName(appName);
                } else {
                    showToast(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }

                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
            };

            // ========== PROFILE ==========
            window.showProfileSettings = function() {
                document.getElementById('profile-phone').value = state.user?.phone || '';
                document.getElementById('profile-department').value = state.user?.department || '';
                document.getElementById('profile-modal').classList.add('active');
            };

            window.closeProfileModal = function() {
                document.getElementById('profile-modal').classList.remove('active');
            };

            window.saveProfile = async function(e) {
                e.preventDefault();
                
                const saveBtn = e.submitter;
                saveBtn.disabled = true;
                saveBtn.classList.add('loading');

                const data = {
                    phone: document.getElementById('profile-phone').value,
                    department: document.getElementById('profile-department').value,
                    lineUserId: state.user.lineUserId
                };

                const result = await callGAS('user/update', data);
                if (result.success) {
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    Object.assign(state.user, data);
                    closeProfileModal();
                } else {
                    showToast(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }

                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
            };

            window.logout = function() {
                if (liff.isLoggedIn()) liff.logout();
                localStorage.removeItem('user_cache');
                location.reload();
            };

            // ========== TAB SWITCHING ==========
            window.switchTab = function(tab) {
                $.navItems.forEach(i => i.classList.remove('active'));
                document.querySelectorAll(`[data-tab="${tab}"]`).forEach(i => i.classList.add('active'));
                
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');

                if (tab === 'my') loadMyPosts();
                if (tab === 'admin' && state.isAdmin) {
                    loadAdminStats();
                    loadUsers();
                    loadPendingPosts();
                    loadAllComments();
                }
            };

            window.goHome = function() {
                switchTab('home');
            };

            // ========== EVENT LISTENERS ==========
            function initEventListeners() {
                // Filter buttons
                $.filterBtns?.forEach(btn => {
                    btn.addEventListener('click', () => {
                        $.filterBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        state.currentFilter = btn.dataset.filter;
                        state.currentPage = 1;
                        loadPosts();
                    });
                });

                // Search debounce
                let searchTimer;
                $['search-input']?.addEventListener('input', () => {
                    clearTimeout(searchTimer);
                    searchTimer = setTimeout(() => {
                        state.searchTerm = $['search-input'].value;
                        state.currentPage = 1;
                        loadPosts();
                    }, 300);
                });

                // User search
                $['user-search']?.addEventListener('input', renderUsers);
                
                // Admin comment search
                $['admin-comment-search']?.addEventListener('input', renderAdminComments);

                // Refresh admin
                $['refresh-admin']?.addEventListener('click', () => {
                    if (state.isAdmin) {
                        loadAdminStats();
                        loadUsers();
                        loadPendingPosts();
                        loadAllComments();
                    }
                });

                // Admin tabs
                document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
                        const targetTab = document.getElementById(`admin-${btn.dataset.adminTab}-tab`);
                        if (targetTab) targetTab.classList.remove('hidden');
                        
                        if (btn.dataset.adminTab === 'comments') loadAllComments();
                    });
                });

                // Navigation
                $.navItems?.forEach(item => {
                    item.addEventListener('click', () => switchTab(item.dataset.tab));
                });

                // Profile header
                document.getElementById('profile-header')?.addEventListener('click', () => {
                    if (!state.user) return;
                    if (confirm('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå?')) showProfileSettings();
                    else if (confirm('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) logout();
                });

                // Pagination
                $['prev-page']?.addEventListener('click', () => changePage('prev'));
                $['next-page']?.addEventListener('click', () => changePage('next'));
            }

            // Start
            initEventListeners();
            initLIFF();
        })();
    </script>
</body>
</html>
