<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE MiniApp ¬∑ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏≠‡∏ó‡∏µ</title>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            font-family: 'IBM Plex Sans Thai', sans-serif;
        }
        
        :root {
            --primary: #06c755;
            --primary-dark: #05b34a;
            --bg-primary: #0a0a0f;
            --bg-secondary: #111317;
            --bg-card: #1a1d24;
            --border: #2a2e36;
        }
        
        body {
            background-color: var(--bg-primary);
            color: white;
        }
        
        /* Navigation */
        .navbar {
            background: rgba(26, 29, 36, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            padding: 12px 16px;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* Buttons */
        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-outline:hover {
            background: #252930;
            border-color: var(--primary);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* Input fields */
        .input-field {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            width: 100%;
        }
        
        .input-field:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        /* Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .badge-open {
            background: rgba(6, 199, 85, 0.15);
            color: var(--primary);
            border: 1px solid rgba(6, 199, 85, 0.3);
        }
        
        .badge-closed {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .badge-full {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        /* Modal */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
        }
        
        /* Loading */
        .loading-overlay {
            background: rgba(0, 0, 0, 0.9);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-card);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            padding: 16px 24px;
            color: white;
            box-shadow: 0 10px 30px -5px black;
            z-index: 10000;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .mt-20 {
            margin-top: 80px;
        }

        /* Admin Panel */
        .admin-panel {
            background: linear-gradient(135deg, rgba(6, 199, 85, 0.1), transparent);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p id="loadingMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#06c755] to-[#00a344] flex items-center justify-center">
                    <i class="fab fa-line text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">LINE MiniApp</h1>
                    <p class="text-xs text-gray-400">‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏≠‡∏ó‡∏µ</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Admin Button -->
                <button id="adminBtn" class="hidden p-2 rounded-xl hover:bg-white/10">
                    <i class="fas fa-cog text-gray-300"></i>
                </button>
                
                <!-- Profile -->
                <div id="profileSection" class="hidden items-center gap-3">
                    <div class="text-right">
                        <p id="profileName" class="text-sm font-medium"></p>
                        <p id="profileEmail" class="text-xs text-gray-400"></p>
                    </div>
                    <img id="profileImage" src="" class="w-10 h-10 rounded-full border-2 border-[#06c755] object-cover">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-20 pb-10">
        <!-- Welcome Banner -->
        <div id="welcomeBanner" class="hidden mb-8 p-6 rounded-2xl bg-gradient-to-r from-[#06c75520] to-[#00a34420] border border-[#06c75540]">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl bg-[#06c755] flex items-center justify-center">
                    <i class="fas fa-hand-peace text-white text-3xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="welcomeName" class="text-[#06c755]"></span></h2>
                    <p class="text-gray-400">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="card p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    <i class="fas fa-calendar-alt text-[#06c755]"></i>
                </div>
                <p id="statTotalActivities" class="text-3xl font-bold">-</p>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                    <i class="fas fa-door-open text-[#06c755]"></i>
                </div>
                <p id="statOpenActivities" class="text-3xl font-bold text-[#06c755]">-</p>
            </div>
            <div class="card p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</span>
                    <i class="fas fa-users text-blue-400"></i>
                </div>
                <p id="statTotalParticipants" class="text-3xl font-bold text-blue-400">-</p>
            </div>
            <div class="card p-4 cursor-pointer" onclick="showMyRegistrations()">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                    <i class="fas fa-check-circle text-purple-400"></i>
                </div>
                <p id="statMyRegistrations" class="text-3xl font-bold text-purple-400">-</p>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden admin-panel mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">
                    <i class="fas fa-crown text-[#06c755] mr-2"></i>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                </h3>
                <button onclick="showCreateActivityModal()" class="btn-primary px-4 py-2 text-sm">
                    <i class="fas fa-plus mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                </button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-[#111317] p-4 rounded-xl">
                    <p class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="adminTotalUsers" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-[#111317] p-4 rounded-xl">
                    <p class="text-xs text-gray-500">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                    <p id="adminTotalActivities" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-[#111317] p-4 rounded-xl">
                    <p class="text-xs text-gray-500">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                    <p id="adminTotalRegistrations" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-[#111317] p-4 rounded-xl">
                    <p class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>
                    <p id="adminRevenue" class="text-2xl font-bold text-yellow-500">‡∏ø0</p>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="mb-8">
            <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." 
                   class="input-field">
        </div>

        <!-- Activities Grid -->
        <div id="activitiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Loading skeleton -->
            <div class="card p-4 animate-pulse h-64"></div>
            <div class="card p-4 animate-pulse h-64"></div>
            <div class="card p-4 animate-pulse h-64"></div>
        </div>
    </div>

    <!-- Create/Edit Activity Modal -->
    <div id="activityModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="activityModalTitle" class="text-2xl font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeActivityModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="activityForm" onsubmit="saveActivity(event)">
                <input type="hidden" id="activityId">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° *</label>
                        <input type="text" id="activityTitle" class="input-field" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ *</label>
                        <textarea id="activityDescription" rows="3" class="input-field" required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà *</label>
                        <input type="text" id="activityLocation" class="input-field" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° *</label>
                            <input type="datetime-local" id="activityStartDate" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î *</label>
                            <input type="datetime-local" id="activityEndDate" class="input-field" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö *</label>
                            <input type="number" id="activityMaxParticipants" class="input-field" min="1" value="50" required>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (0 = ‡∏ü‡∏£‡∏µ)</label>
                            <input type="number" id="activityPrice" class="input-field" min="0" value="0">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</label>
                        <input type="url" id="activityImageUrl" class="input-field" placeholder="https://...">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                        <input type="text" id="activityContact" class="input-field">
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" onclick="closeActivityModal()" class="btn-outline flex-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Detail Modal -->
    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="detailTitle" class="text-2xl font-bold"></h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="detailContent" class="space-y-4"></div>
            
            <div class="flex gap-3 mt-6">
                <button id="registerBtn" class="btn-primary flex-1" onclick="registerActivity()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <button onclick="closeDetailModal()" class="btn-outline flex-1">‡∏õ‡∏¥‡∏î</button>
            </div>
            
            <!-- Admin Controls -->
            <div id="adminActivityControls" class="hidden mt-4 pt-4 border-t border-[#2a2e36]">
                <p class="text-sm text-gray-400 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                <div class="flex gap-2">
                    <button onclick="editCurrentActivity()" class="btn-outline flex-1 py-2 text-sm">
                        <i class="fas fa-edit mr-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button onclick="deleteCurrentActivity()" class="btn-danger flex-1 py-2 text-sm">
                        <i class="fas fa-trash mr-2"></i>‡∏•‡∏ö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Registrations Modal -->
    <div id="registrationsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                <button onclick="closeRegistrationsModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="registrationsList" class="space-y-3"></div>
        </div>
    </div>

    <script>
        // ============================================
        // LINE MiniApp Frontend - ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö GS ‡∏à‡∏£‡∏¥‡∏á
        // ============================================
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwSz6Y_fpvB0qN52eS6QD2RFJD-bJA369B6b86W1ZGVCOrbPXGGbpBIS3hDO8h6awKzkw/exec';
        const LIFF_ID = '2008904120-T7I0VPZf';
        
        // State
        let currentUser = null;
        let activities = [];
        let myRegistrations = [];
        let currentActivity = null;
        let isAdmin = false;
        
        // ========== Utility ==========
        function showLoading(msg = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            document.getElementById('loadingMessage').textContent = msg;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function formatDate(date) {
            if (!date) return '-';
            const d = new Date(date);
            return d.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        // ========== API Call ==========
        async function callGAS(path, data = {}) {
            const formData = new FormData();
            formData.append('path', path);
            
            if (currentUser?.userId) {
                formData.append('lineUserId', currentUser.userId);
            }
            
            Object.keys(data).forEach(key => {
                formData.append(key, data[key]);
            });
            
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: formData });
                return await res.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // ========== Initialize ==========
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...');
            
            try {
                await new Promise((resolve, reject) => {
                    liff.init({ liffId: LIFF_ID }, resolve, reject);
                });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                await loadUserProfile();
                await loadActivities();
                await loadMyRegistrations();
                
                hideLoading();
                
            } catch (error) {
                console.error('Init error:', error);
                hideLoading();
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ');
            }
        });
        
        // ========== User Profile ==========
        async function loadUserProfile() {
            try {
                const profile = await liff.getProfile();
                const idToken = liff.getDecodedIDToken();
                
                const result = await callGAS('user/profile', {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    email: idToken?.email || ''
                });
                
                if (result.success) {
                    currentUser = result.data;
                    isAdmin = currentUser.role === 'admin';
                    
                    // Update UI
                    document.getElementById('profileSection').classList.remove('hidden');
                    document.getElementById('profileName').textContent = currentUser.displayName;
                    document.getElementById('profileEmail').textContent = currentUser.email || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                    document.getElementById('profileImage').src = currentUser.pictureUrl || 'https://via.placeholder.com/100/06c755/ffffff?text=LINE';
                    
                    document.getElementById('welcomeBanner').classList.remove('hidden');
                    document.getElementById('welcomeName').textContent = currentUser.displayName.split(' ')[0];
                    
                    if (isAdmin) {
                        document.getElementById('adminBtn').classList.remove('hidden');
                        document.getElementById('adminBtn').onclick = toggleAdminPanel;
                        await loadAdminStats();
                    }
                }
                
            } catch (error) {
                console.error('Profile error:', error);
            }
        }
        
        // ========== Activities ==========
        async function loadActivities() {
            try {
                const result = await callGAS('activities', {
                    search: document.getElementById('searchInput').value
                });
                
                if (result.success) {
                    activities = result.data.activities || [];
                    displayActivities();
                    
                    // Update stats
                    document.getElementById('statTotalActivities').textContent = activities.length;
                    document.getElementById('statOpenActivities').textContent = 
                        activities.filter(a => a.status === 'open').length;
                    document.getElementById('statTotalParticipants').textContent = 
                        activities.reduce((sum, a) => sum + (a.currentParticipants || 0), 0);
                }
                
            } catch (error) {
                console.error('Load activities error:', error);
            }
        }
        
        function displayActivities() {
            const container = document.getElementById('activitiesContainer');
            
            if (!activities.length) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-calendar-times text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                        ${isAdmin ? `
                            <button onclick="showCreateActivityModal()" class="btn-primary mt-4">
                                <i class="fas fa-plus mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏£‡∏Å
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            let html = '';
            activities.forEach(activity => {
                const isRegistered = myRegistrations.some(r => r.activityId === activity.activityId);
                const percent = ((activity.currentParticipants || 0) / activity.maxParticipants) * 100;
                
                html += `
                    <div class="card cursor-pointer" onclick="showActivityDetail('${activity.activityId}')">
                        <div class="relative h-48">
                            ${activity.imageUrl ? 
                                `<img src="${activity.imageUrl}" class="w-full h-full object-cover">` : 
                                `<div class="w-full h-full bg-gradient-to-br from-[#06c755] to-[#00a344] flex items-center justify-center">
                                    <i class="fas fa-calendar-alt text-white text-5xl opacity-50"></i>
                                </div>`
                            }
                            <div class="absolute top-4 right-4">
                                <span class="badge badge-${activity.status}">
                                    <i class="fas fa-${activity.status === 'open' ? 'door-open' : 'lock'}"></i>
                                    ${activity.status === 'open' ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£'}
                                </span>
                            </div>
                            ${isAdmin ? `
                                <div class="absolute top-4 left-4 flex gap-2">
                                    <span class="badge bg-blue-500 text-white cursor-pointer" onclick="event.stopPropagation(); editActivity('${activity.activityId}')">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                    <span class="badge bg-red-500 text-white cursor-pointer" onclick="event.stopPropagation(); deleteActivity('${activity.activityId}')">
                                        <i class="fas fa-trash"></i>
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="p-4">
                            <h3 class="font-semibold text-lg mb-2">${activity.title}</h3>
                            <p class="text-sm text-gray-400 mb-4 line-clamp-2">${activity.description || ''}</p>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm text-gray-300">
                                    <i class="fas fa-calendar w-5 text-[#06c755]"></i>
                                    <span>${formatDate(activity.startDate)}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-300">
                                    <i class="fas fa-map-marker-alt w-5 text-[#06c755]"></i>
                                    <span>${activity.location || ''}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-300">
                                    <i class="fas fa-users w-5 text-[#06c755]"></i>
                                    <span>${activity.currentParticipants || 0}/${activity.maxParticipants} ‡∏Ñ‡∏ô</span>
                                </div>
                            </div>
                            
                            <div class="progress-bar mb-4">
                                <div class="progress-fill" style="width: ${percent}%"></div>
                            </div>
                            
                            ${isRegistered ? 
                                '<div class="text-center py-2 bg-[#06c755]/10 text-[#06c755] rounded-xl text-sm">‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>' : 
                                activity.status === 'open' ?
                                `<button class="w-full py-3 bg-[#06c755] text-white rounded-xl text-sm hover:bg-[#05b34a]" onclick="event.stopPropagation(); registerActivity('${activity.activityId}')">
                                    ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                                </button>` :
                                `<button class="w-full py-3 bg-[#2a2e36] text-gray-500 rounded-xl text-sm cursor-not-allowed" disabled>
                                    ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                                </button>`
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ========== Activity Detail ==========
        async function showActivityDetail(activityId) {
            showLoading();
            
            try {
                const result = await callGAS('activity', { activityId });
                
                if (result.success) {
                    currentActivity = result.data;
                    
                    document.getElementById('detailTitle').textContent = currentActivity.title;
                    
                    const isRegistered = myRegistrations.some(r => r.activityId === activityId);
                    const percent = ((currentActivity.currentParticipants || 0) / currentActivity.maxParticipants) * 100;
                    
                    document.getElementById('detailContent').innerHTML = `
                        ${currentActivity.imageUrl ? 
                            `<img src="${currentActivity.imageUrl}" class="w-full h-64 object-cover rounded-xl">` : ''
                        }
                        
                        <p class="text-gray-400">${currentActivity.description || ''}</p>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-[#111317] rounded-xl">
                                <p class="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</p>
                                <p class="font-medium">${formatDate(currentActivity.startDate)}</p>
                            </div>
                            <div class="p-4 bg-[#111317] rounded-xl">
                                <p class="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</p>
                                <p class="font-medium">${formatDate(currentActivity.endDate)}</p>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-[#111317] rounded-xl">
                            <p class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
                            <p class="font-medium">${currentActivity.location || ''}</p>
                        </div>
                        
                        <div class="p-4 bg-[#111317] rounded-xl">
                            <div class="flex justify-between mb-2">
                                <span>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</span>
                                <span class="text-[#06c755]">${currentActivity.currentParticipants || 0}/${currentActivity.maxParticipants}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percent}%"></div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-[#111317] rounded-xl">
                            <p class="mb-2">üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>
                            <p class="text-sm text-gray-400">${currentActivity.contact || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                        </div>
                    `;
                    
                    const registerBtn = document.getElementById('registerBtn');
                    if (isRegistered) {
                        registerBtn.disabled = true;
                        registerBtn.className = 'btn-primary flex-1 opacity-50 cursor-not-allowed';
                        registerBtn.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (currentActivity.status !== 'open') {
                        registerBtn.disabled = true;
                        registerBtn.className = 'btn-primary flex-1 opacity-50 cursor-not-allowed';
                        registerBtn.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ';
                    } else {
                        registerBtn.disabled = false;
                        registerBtn.className = 'btn-primary flex-1';
                        registerBtn.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                    }
                    
                    // Admin controls
                    document.getElementById('adminActivityControls').style.display = isAdmin ? 'block' : 'none';
                    
                    document.getElementById('detailModal').style.display = 'flex';
                }
                
            } catch (error) {
                console.error('Detail error:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ');
            }
            
            hideLoading();
        }
        
        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        // ========== Registration ==========
        async function registerActivity(activityId) {
            const id = activityId || currentActivity?.activityId;
            if (!id) return;
            
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            showLoading();
            
            try {
                const result = await callGAS('register', { 
                    activityId: id,
                    displayName: currentUser.displayName,
                    email: currentUser.email || ''
                });
                
                if (result.success) {
                    await loadMyRegistrations();
                    await loadActivities();
                    closeDetailModal();
                    showToast('‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    alert(result.message || '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                
            } catch (error) {
                console.error('Register error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
            
            hideLoading();
        }
        
        // ========== My Registrations ==========
        async function loadMyRegistrations() {
            try {
                const result = await callGAS('user/registrations');
                
                if (result.success) {
                    myRegistrations = result.data || [];
                    document.getElementById('statMyRegistrations').textContent = myRegistrations.length;
                }
                
            } catch (error) {
                console.error('Load registrations error:', error);
            }
        }
        
        function showMyRegistrations() {
            const modal = document.getElementById('registrationsModal');
            const list = document.getElementById('registrationsList');
            
            if (!myRegistrations.length) {
                list.innerHTML = '<p class="text-center text-gray-400 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>';
            } else {
                list.innerHTML = myRegistrations.map(reg => `
                    <div class="p-4 bg-[#111317] rounded-xl border border-[#2a2e36]">
                        <div class="flex justify-between mb-2">
                            <h4 class="font-medium">${reg.activity?.title || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'}</h4>
                            <span class="text-sm ${reg.status === 'confirmed' ? 'text-[#06c755]' : 'text-yellow-500'}">
                                ${reg.status === 'confirmed' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-400">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${formatDate(reg.registrationDate)}</p>
                        ${reg.status === 'confirmed' ? `
                            <button class="mt-2 text-sm text-red-500" onclick="cancelRegistration('${reg.regId}')">
                                <i class="fas fa-times mr-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            }
            
            modal.style.display = 'flex';
        }
        
        async function cancelRegistration(registrationId) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            showLoading();
            
            try {
                const result = await callGAS('cancel', { registrationId });
                
                if (result.success) {
                    await loadMyRegistrations();
                    await loadActivities();
                    closeRegistrationsModal();
                    showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    alert(result.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                
            } catch (error) {
                console.error('Cancel error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
            
            hideLoading();
        }
        
        function closeRegistrationsModal() {
            document.getElementById('registrationsModal').style.display = 'none';
        }
        
        // ========== Admin Functions ==========
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('hidden');
        }
        
        async function loadAdminStats() {
            try {
                const result = await callGAS('admin/stats');
                
                if (result.success) {
                    document.getElementById('adminTotalUsers').textContent = result.data.users || 0;
                    document.getElementById('adminTotalActivities').textContent = result.data.activities || 0;
                    document.getElementById('adminTotalRegistrations').textContent = result.data.registrations || 0;
                    document.getElementById('adminRevenue').textContent = `‡∏ø${(result.data.revenue || 0).toLocaleString()}`;
                }
                
            } catch (error) {
                console.error('Load admin stats error:', error);
            }
        }
        
        // ========== Create/Edit Activity ==========
        function showCreateActivityModal() {
            if (!isAdmin) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå');
                return;
            }
            
            document.getElementById('activityId').value = '';
            document.getElementById('activityTitle').value = '';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityLocation').value = '';
            document.getElementById('activityStartDate').value = '';
            document.getElementById('activityEndDate').value = '';
            document.getElementById('activityMaxParticipants').value = '50';
            document.getElementById('activityPrice').value = '0';
            document.getElementById('activityImageUrl').value = '';
            document.getElementById('activityContact').value = '';
            
            document.getElementById('activityModalTitle').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('activityModal').style.display = 'flex';
        }
        
        async function saveActivity(event) {
            event.preventDefault();
            
            if (!isAdmin) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå');
                return;
            }
            
            const activityData = {
                title: document.getElementById('activityTitle').value,
                description: document.getElementById('activityDescription').value,
                location: document.getElementById('activityLocation').value,
                startDate: document.getElementById('activityStartDate').value,
                endDate: document.getElementById('activityEndDate').value,
                maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value),
                price: parseInt(document.getElementById('activityPrice').value) || 0,
                imageUrl: document.getElementById('activityImageUrl').value,
                contact: document.getElementById('activityContact').value
            };
            
            const activityId = document.getElementById('activityId').value;
            const isEdit = !!activityId;
            
            showLoading();
            
            try {
                const path = isEdit ? 'activities/update' : 'activities/create';
                const data = isEdit ? { activityId, ...activityData } : activityData;
                
                const result = await callGAS(path, data);
                
                if (result.success) {
                    closeActivityModal();
                    await loadActivities();
                    await loadAdminStats();
                    showToast(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    alert(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
            
            hideLoading();
        }
        
        async function editActivity(activityId) {
            showLoading();
            
            try {
                const result = await callGAS('activity', { activityId });
                
                if (result.success) {
                    const activity = result.data;
                    
                    document.getElementById('activityId').value = activity.activityId;
                    document.getElementById('activityTitle').value = activity.title || '';
                    document.getElementById('activityDescription').value = activity.description || '';
                    document.getElementById('activityLocation').value = activity.location || '';
                    document.getElementById('activityStartDate').value = activity.startDate?.slice(0, 16) || '';
                    document.getElementById('activityEndDate').value = activity.endDate?.slice(0, 16) || '';
                    document.getElementById('activityMaxParticipants').value = activity.maxParticipants || 50;
                    document.getElementById('activityPrice').value = activity.price || 0;
                    document.getElementById('activityImageUrl').value = activity.imageUrl || '';
                    document.getElementById('activityContact').value = activity.contact || '';
                    
                    document.getElementById('activityModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                    closeDetailModal();
                    document.getElementById('activityModal').style.display = 'flex';
                }
                
            } catch (error) {
                console.error('Edit error:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            }
            
            hideLoading();
        }
        
        function editCurrentActivity() {
            if (currentActivity) {
                editActivity(currentActivity.activityId);
            }
        }
        
        async function deleteActivity(activityId) {
            if (!confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
            
            showLoading();
            
            try {
                const result = await callGAS('activities/delete', { activityId });
                
                if (result.success) {
                    await loadActivities();
                    await loadAdminStats();
                    closeDetailModal();
                    showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    alert(result.message || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
            
            hideLoading();
        }
        
        function deleteCurrentActivity() {
            if (currentActivity) {
                deleteActivity(currentActivity.activityId);
            }
        }
        
        function closeActivityModal() {
            document.getElementById('activityModal').style.display = 'none';
        }
        
        // ========== Event Listeners ==========
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(loadActivities, 500);
        });
        
        // Close modals on outside click
        window.onclick = function(event) {
            const modals = ['activityModal', 'detailModal', 'registrationsModal'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>
