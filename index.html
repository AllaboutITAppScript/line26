<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE NEWS ¬∑ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</title>
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/653/653021.png">
    <!-- Tailwind (lightweight) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Inter + IBM Plex Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LINE LIFF -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js" async></script>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <style>
        /* (‡πÇ‡∏Ñ‡πâ‡∏î CSS ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0f1214;
            --bg-card: #1a1e24;
            --bg-card-hover: #242a32;
            --border-subtle: #2a313c;
            --text-primary: #f0f4f8;
            --text-secondary: #a0b3c9;
            --text-muted: #6c7a8a;
            --accent: #06c755;
            --accent-glow: rgba(6,199,85,0.25);
            --danger: #f85149;
            --warning: #f7b731;
            --info: #3b82f6;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', 'IBM Plex Sans Thai', sans-serif;
            padding-bottom: 80px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-card);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 20px;
        }

        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20, 26, 32, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 8px;
            z-index: 50;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .nav-item i {
            font-size: 22px;
            transition: transform 0.2s;
        }
        .nav-item.active {
            color: var(--accent);
        }
        .nav-item.active i {
            text-shadow: 0 0 10px var(--accent-glow);
        }
        .nav-item .badge {
            position: absolute;
            top: -2px;
            right: 20px;
            background: var(--danger);
            color: white;
            font-size: 9px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            box-shadow: 0 0 10px rgba(248,81,73,0.5);
            border: 1.5px solid var(--bg-dark);
        }

        /* Header */
        .news-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: transparent;
        }
        .logo-area {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .logo-icon {
            background: var(--accent);
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: black;
            font-weight: 700;
        }
        .logo-text {
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.3px;
            background: linear-gradient(135deg, #ffffff 0%, #c0d4f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profile-icon {
            width: 44px;
            height: 44px;
            border-radius: 44px;
            border: 2px solid var(--accent);
            object-fit: cover;
            cursor: pointer;
            transition: 0.2s;
        }
        .profile-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* Profile dropdown */
        .profile-dropdown {
            position: absolute;
            top: 70px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            width: 180px;
            z-index: 100;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6);
            overflow: hidden;
            display: none;
        }
        .profile-dropdown.show {
            display: block;
        }
        .dropdown-item {
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }
        .dropdown-item:hover {
            background: var(--bg-card-hover);
        }
        .dropdown-item i {
            width: 20px;
            color: var(--accent);
        }

        /* Stats cards (compact) */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 20px 20px;
        }
        .stat-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 14px 10px;
            text-align: center;
            transition: 0.2s;
        }
        .stat-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .stat-number {
            font-size: 26px;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #fff, #b0d0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Hero slider */
        .swiper {
            width: 100%;
            height: 230px;
            margin-bottom: 20px;
        }
        .swiper-slide {
            border-radius: 0;
            overflow: hidden;
            position: relative;
        }
        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 20px 20px;
            background: linear-gradient(to top, #000000e0, #00000000);
        }
        .slide-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 5px 14px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .slide-badge.urgent { background: var(--danger); }
        .slide-badge.event { background: var(--warning); color: black; }
        .slide-badge.news { background: var(--accent); color: black; }

        /* Search & filter */
        .search-section {
            padding: 0 20px 20px;
        }
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }
        .search-box input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 40px;
            color: var(--text-primary);
            font-size: 15px;
            transition: 0.2s;
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 18px;
        }
        .filter-row {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 6px;
            scrollbar-width: none;
        }
        .filter-row::-webkit-scrollbar {
            display: none;
        }
        .filter-btn {
            padding: 10px 20px;
            border-radius: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.2s;
        }
        .filter-btn.active {
            background: var(--accent);
            color: black;
            border-color: var(--accent);
            font-weight: 600;
        }

        /* News card (modern) */
        .news-grid {
            padding: 0 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .news-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: 0.25s ease;
            position: relative;
        }
        .news-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.7), 0 0 0 1px var(--accent-glow);
        }
        .news-card.pending {
            border-left: 4px solid var(--warning);
        }
        .news-card.rejected {
            border-left: 4px solid var(--danger);
            opacity: 0.8;
        }
        .news-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.5s;
        }
        .news-card:hover .news-card-image {
            transform: scale(1.02);
        }
        .news-card-content {
            padding: 18px;
        }
        .meta-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .type-badge {
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
        }
        .type-badge.news {
            background: rgba(6,199,85,0.15);
            color: var(--accent);
            border: 1px solid rgba(6,199,85,0.3);
        }
        .type-badge.event {
            background: rgba(247,183,49,0.15);
            color: var(--warning);
            border: 1px solid rgba(247,183,49,0.3);
        }
        .type-badge.urgent {
            background: rgba(248,81,73,0.15);
            color: var(--danger);
            border: 1px solid rgba(248,81,73,0.3);
        }
        .date {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .news-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .news-excerpt {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
            font-size: 12px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 16px;
        }
        .author {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stats {
            display: flex;
            gap: 12px;
        }
        .share-button {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            width: 40px;
            height: 40px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 5;
            cursor: pointer;
        }
        .share-button:hover {
            background: var(--accent);
            color: black;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-pending {
            background: rgba(247,183,49,0.2);
            color: var(--warning);
        }
        .status-approved {
            background: rgba(6,199,85,0.2);
            color: var(--accent);
        }
        .status-rejected {
            background: rgba(248,81,73,0.2);
            color: var(--danger);
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(12px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
            animation: modalUp 0.3s;
        }
        @keyframes modalUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px dashed var(--border-subtle);
        }

        /* Toast & loading (keep original) */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: var(--bg-card);
            border-left: 4px solid var(--accent);
            border-radius: 16px;
            padding: 16px 20px;
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { display: block; }
        .toast.success { border-left-color: var(--accent); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--info); }
        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .loading {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .loading.active { display: flex; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hidden class */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text text-gray-400 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-content">
            <i class="fas fa-info-circle toast-icon" id="toast-icon"></i>
            <span class="toast-message" id="toast-message"></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Header (new) -->
        <div class="news-header">
            <div class="logo-area">
                <div class="logo-icon">N</div>
                <span class="logo-text">LINE NEWS</span>
            </div>
            <img id="profile-avatar" src="" alt="me" class="profile-icon" loading="lazy">
        </div>

        <!-- Profile dropdown -->
        <div id="profile-dropdown" class="profile-dropdown">
            <div class="dropdown-item" onclick="showProfileSettings()">
                <i class="fas fa-user"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="dropdown-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </div>
        </div>

        <!-- Stats -->
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-label">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</div>
                <div class="stat-number" id="stat-news">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
                <div class="stat-number" id="stat-events">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</div>
                <div class="stat-number" id="stat-urgent">-</div>
            </div>
        </div>

        <!-- Hero slider -->
        <div class="swiper hero-swiper">
            <div class="swiper-wrapper" id="hero-slider-wrapper"></div>
            <div class="swiper-pagination"></div>
        </div>

        <!-- Search & filter -->
        <div class="search-section">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...">
            </div>
            <div class="filter-row" id="filter-row">
                <button class="filter-btn active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" data-filter="news">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</button>
                <button class="filter-btn" data-filter="event">üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                <button class="filter-btn" data-filter="urgent">‚ö†Ô∏è ‡∏î‡πà‡∏ß‡∏ô</button>
            </div>
        </div>

        <!-- Tab: Home -->
        <div id="tab-home" class="tab-content active">
            <div id="posts-list" class="news-grid"></div>
            <!-- Loading skeleton (hidden by default) -->
            <div id="loading-skeleton" class="hidden">
                <div class="skeleton h-[280px] rounded-2xl mb-4"></div>
                <div class="skeleton h-[280px] rounded-2xl mb-4"></div>
            </div>
        </div>

        <!-- Tab: My Posts -->
        <div id="tab-my" class="tab-content">
            <div class="flex justify-between items-center px-5 mb-4">
                <h2 class="text-xl font-bold text-white">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button id="create-post-btn" class="bg-[#06c755] text-black px-5 py-2 rounded-full text-sm font-bold shadow-lg hidden admin-editor-only" onclick="showCreatePostModal()">
                    <i class="fas fa-plus mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á
                </button>
            </div>
            <div id="my-posts-list" class="news-grid"></div>
        </div>

        <!-- Tab: Notifications -->
        <div id="tab-notifications" class="tab-content">
            <div class="flex justify-between items-center px-5 mb-4">
                <h2 class="text-xl font-bold text-white">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
                <button class="text-sm text-[#06c755]" onclick="markAllNotificationsAsRead()">
                    <i class="fas fa-check-double mr-1"></i>‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
            <div id="notifications-list" class="news-grid"></div>
        </div>

        <!-- Tab: Admin (only visible for admin) -->
        <div id="tab-admin" class="tab-content">
            <div class="flex justify-between items-center px-5 mb-4">
                <h2 class="text-xl font-bold text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <button id="refresh-admin" class="text-[#06c755] text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>
            <!-- Admin Stats -->
            <div class="admin-section bg-[#1a1e24] border border-[#2a313c] rounded-2xl p-5 mx-5 mb-5">
                <h3 class="font-semibold mb-4 text-lg">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="admin-stat bg-black/20 p-4 rounded-xl text-center">
                        <p class="text-xs text-gray-400">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                        <p id="admin-users" class="text-xl font-bold text-[#06c755]">-</p>
                    </div>
                    <div class="admin-stat bg-black/20 p-4 rounded-xl text-center">
                        <p class="text-xs text-gray-400">‡πÇ‡∏û‡∏™‡∏ï‡πå</p>
                        <p id="admin-posts" class="text-xl font-bold text-[#06c755]">-</p>
                    </div>
                    <div class="admin-stat bg-black/20 p-4 rounded-xl text-center">
                        <p class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                        <p id="admin-today" class="text-xl font-bold text-[#06c755]">-</p>
                    </div>
                    <div class="admin-stat bg-black/20 p-4 rounded-xl text-center">
                        <p class="text-xs text-gray-400">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                        <p id="admin-pending" class="text-xl font-bold text-yellow-500">-</p>
                    </div>
                </div>
            </div>

            <!-- Pending Posts Section -->
            <div id="pending-posts-section" class="pending-section hidden border border-yellow-500/30 bg-yellow-500/5 rounded-2xl p-5 mx-5 mb-5">
                <h3 class="font-semibold mb-4 flex items-center text-lg">
                    <i class="fas fa-clock text-yellow-500 mr-2 animate-pulse"></i>
                    ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    <span id="pending-count" class="ml-3 bg-yellow-500 text-white text-xs px-2.5 py-1 rounded-full">0</span>
                </h3>
                <div id="pending-posts-list" class="space-y-4"></div>
            </div>

            <!-- Admin Tabs -->
            <div class="flex border-b border-[#2a313c] mb-5 px-5">
                <button class="admin-tab-btn flex-1 py-3 text-center text-gray-400 font-medium active" data-admin-tab="posts">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                <button class="admin-tab-btn flex-1 py-3 text-center text-gray-400 font-medium" data-admin-tab="users">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                <button class="admin-tab-btn flex-1 py-3 text-center text-gray-400 font-medium" data-admin-tab="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>

            <!-- Admin: Posts Management -->
            <div id="admin-posts-tab" class="admin-tab px-5">
                <button class="w-full bg-[#06c755] text-black py-3 rounded-full font-bold mb-5 shadow-lg" onclick="showCreatePostModal()">
                    <i class="fas fa-plus mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà
                </button>
                <div id="admin-posts-list" class="space-y-3"></div>
            </div>

            <!-- Admin: Users Management -->
            <div id="admin-users-tab" class="admin-tab hidden px-5">
                <div class="search-box mb-5">
                    <i class="fas fa-search"></i>
                    <input type="text" id="user-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...">
                </div>
                <div id="users-list" class="space-y-2"></div>
            </div>

            <!-- Admin: Settings -->
            <div id="admin-settings-tab" class="admin-tab hidden px-5">
                <div class="bg-[#1a1e24] border border-[#2a313c] rounded-2xl p-5">
                    <h3 class="font-semibold mb-4 text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <form id="settings-form" onsubmit="saveSettings(event)">
                        <label class="block text-sm text-gray-400 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</label>
                        <input type="text" id="setting-app-name" class="input-field w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white" required>
                        
                        <label class="block text-sm text-gray-400 mb-2">Google Drive Folder ID</label>
                        <input type="text" id="setting-drive-folder" class="input-field w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white" required>
                        
                        <label class="block text-sm text-gray-400 mb-2">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå</label>
                        <select id="setting-allow-user-posts" class="input-field w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white">
                            <option value="true">‡πÉ‡∏ä‡πà</option>
                            <option value="false">‡πÑ‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô/‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô)</option>
                        </select>
                        
                        <button type="submit" class="w-full bg-[#06c755] text-black py-3 rounded-full font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home"><i class="fas fa-home"></i><span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span></div>
        <div class="nav-item" data-tab="my"><i class="fas fa-pen-fancy"></i><span>‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span><span id="my-posts-badge" class="badge hidden">0</span></div>
        <div class="nav-item" data-tab="notifications"><i class="fas fa-bell"></i><span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span><span id="notif-badge" class="badge hidden">0</span></div>
        <div class="nav-item hidden admin-only" data-tab="admin"><i class="fas fa-cog"></i><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span><span id="admin-pending-badge" class="badge hidden">0</span></div>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal" id="post-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h3 id="modal-title" class="text-2xl font-bold"></h3>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-[#2a313c] hover:bg-[#3a4250] transition-colors flex items-center justify-center">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <div id="modal-body" class="space-y-5"></div>
            
            <div id="modal-approval-banner" class="hidden approval-banner p-4 rounded-2xl mb-4"></div>
            
            <div class="flex gap-3 mt-6">
                <button class="flex-1 bg-[#06c755] text-black py-3 rounded-full font-bold shadow-lg" onclick="shareAsFlexMessage()" id="modal-share-btn">
                    <i class="fab fa-line mr-2"></i> ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏õ LINE
                </button>
                <button class="flex-1 bg-transparent border border-[#2a313c] text-white py-3 rounded-full" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
            </div>
            
            <div id="modal-owner-controls" class="hidden mt-6 pt-6 border-t border-[#2a313c]">
                <p class="text-sm text-gray-400 mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</p>
                <div class="flex gap-3">
                    <button class="flex-1 bg-transparent border border-[#2a313c] text-white py-3 rounded-full text-sm" onclick="editCurrentPost()"><i class="fas fa-edit mr-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="flex-1 bg-[#f85149] text-white py-3 rounded-full text-sm" onclick="deleteCurrentPost()"><i class="fas fa-trash mr-2"></i>‡∏•‡∏ö</button>
                </div>
            </div>
            
            <div id="modal-admin-controls" class="hidden mt-6 pt-6 border-t border-[#2a313c]">
                <p class="text-sm text-gray-400 mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</p>
                <div id="modal-approval-buttons" class="hidden mb-4">
                    <div class="flex gap-3">
                        <button class="flex-1 bg-[#06c755] text-black py-3 rounded-full text-sm" onclick="approveCurrentPost()"><i class="fas fa-check mr-2"></i>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button class="flex-1 bg-[#f85149] text-white py-3 rounded-full text-sm" onclick="showRejectModal()"><i class="fas fa-times mr-2"></i>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button class="flex-1 bg-transparent border border-[#2a313c] text-white py-3 rounded-full text-sm" onclick="editCurrentPost()"><i class="fas fa-edit mr-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="flex-1 bg-[#f85149] text-white py-3 rounded-full text-sm" onclick="deleteCurrentPost()"><i class="fas fa-trash mr-2"></i>‡∏•‡∏ö</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div class="modal" id="reject-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏û‡∏™‡∏ï‡πå</h3>
                <button onclick="closeRejectModal()" class="w-10 h-10 rounded-full bg-[#2a313c] hover:bg-[#3a4250] flex items-center justify-center">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <form id="reject-form" onsubmit="rejectPost(event)">
                <textarea id="reject-reason" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò..." class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 text-white" rows="5" required></textarea>
                <div class="flex gap-3 mt-5">
                    <button type="submit" class="flex-1 bg-[#f85149] text-white py-3 rounded-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button type="button" class="flex-1 bg-transparent border border-[#2a313c] text-white py-3 rounded-full" onclick="closeRejectModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit Post Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h3 id="create-modal-title" class="text-2xl font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeCreateModal()" class="w-10 h-10 rounded-full bg-[#2a313c] hover:bg-[#3a4250] flex items-center justify-center">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            
            <div id="post-status-info" class="mb-5 p-4 rounded-2xl hidden">
                <i class="fas fa-info-circle mr-2"></i>
                <span id="post-status-text"></span>
            </div>
            
            <form id="post-form" onsubmit="savePost(event)">
                <input type="hidden" id="edit-post-id">
                
                <select id="post-type" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white" required>
                    <option value="news">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</option>
                    <option value="event">üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
                    <option value="urgent">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</option>
                </select>
                
                <input type="text" id="post-title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white" required maxlength="100">
                
                <textarea id="post-content" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white" rows="6" required maxlength="5000"></textarea>
                
                <!-- Image Upload -->
                <div class="upload-area border-2 border-dashed border-[#2a313c] rounded-xl p-5 text-center mb-4 cursor-pointer hover:border-[#06c755]" onclick="document.getElementById('post-image-file').click()">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-500 mb-2"></i>
                    <p class="text-sm text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                    <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, GIF (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)</p>
                </div>
                <input type="file" id="post-image-file" accept="image/*" style="display: none" onchange="previewImage(this)">
                <img id="image-preview" class="image-preview w-full max-h-52 object-cover rounded-xl mb-4 hidden border-2 border-[#06c755]" src="">
                <input type="hidden" id="post-image" value="">
                
                <input type="text" id="post-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white">
                
                <!-- Status - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin -->
                <div id="post-status-container" class="hidden mb-4">
                    <label class="block text-sm text-gray-400 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="post-status" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 text-white">
                        <option value="published">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
                        <option value="draft">‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á</option>
                    </select>
                </div>
                
                <div class="flex gap-3 mt-5">
                    <button type="submit" class="flex-1 bg-[#06c755] text-black py-3 rounded-full font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="flex-1 bg-transparent border border-[#2a313c] text-white py-3 rounded-full" onclick="closeCreateModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
                <button onclick="closeProfileModal()" class="w-10 h-10 rounded-full bg-[#2a313c] hover:bg-[#3a4250] flex items-center justify-center">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <input type="text" id="profile-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white" maxlength="10">
                <input type="text" id="profile-department" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white" maxlength="50">
                
                <div class="flex gap-3 mt-5">
                    <button type="submit" class="flex-1 bg-[#06c755] text-black py-3 rounded-full font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="flex-1 bg-transparent border border-[#2a313c] text-white py-3 rounded-full" onclick="closeProfileModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Role Modal -->
    <div class="modal" id="role-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                <button onclick="closeRoleModal()" class="w-10 h-10 rounded-full bg-[#2a313c] hover:bg-[#3a4250] flex items-center justify-center">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <form id="role-form" onsubmit="saveUserRole(event)">
                <input type="hidden" id="role-user-id">
                <p id="role-user-name" class="text-white mb-4 text-lg"></p>
                
                <select id="user-role" class="w-full bg-black/30 border border-[#2a313c] rounded-xl p-3 mb-4 text-white">
                    <option value="user">üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    <option value="editor">‚úèÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
                    <option value="admin">üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                </select>
                
                <div class="flex gap-3 mt-5">
                    <button type="submit" class="flex-1 bg-[#06c755] text-black py-3 rounded-full font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="flex-1 bg-transparent border border-[#2a313c] text-white py-3 rounded-full" onclick="closeRoleModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- AOS Animation -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        // ========== INIT AOS ==========
        AOS.init({ duration: 600, once: true });

        // ========== CONFIG ==========
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwSz6Y_fpvB0qN52eS6QD2RFJD-bJA369B6b86W1ZGVCOrbPXGGbpBIS3hDO8h6awKzkw/exec',
            LIFF_ID: '2008904120-T7I0VPZf',
            PAGE_SIZE: 20,
            DRIVE_FOLDER_ID: '18V_3SzGvCIfwbRqIpIEwRSVdA88T8mcE'
        };

        // ========== STATE ==========
        const state = {
            user: null,
            posts: [],
            allPosts: [],
            myPosts: [],
            pendingPosts: [],
            notifications: [],
            users: [],
            currentFilter: 'all',
            searchTerm: '',
            isAdmin: false,
            isEditor: false,
            currentPage: 1,
            currentPost: null,
            settings: {},
            isLoading: false
        };

        // ========== DOM Elements ==========
        const loading = document.getElementById('loading');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');

        // ========== CUSTOM ALERT (same as original) ==========
        function showAlert(options) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'alert-overlay fixed inset-0 bg-black/80 backdrop-blur-sm z-999';
                const alert = document.createElement('div');
                alert.className = 'custom-alert fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-[#1a1e24] border border-[#2a313c] rounded-3xl p-6 max-w-xs w-11/12 z-1000 shadow-2xl';
                const iconMap = { warning: 'fa-exclamation-triangle', success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
                alert.innerHTML = `
                    <div class="alert-icon w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl ${options.type || 'info'}" style="background:rgba(6,199,85,0.2); color:var(--accent); border:2px solid var(--accent);">
                        <i class="fas ${iconMap[options.type] || 'fa-info-circle'}"></i>
                    </div>
                    <div class="alert-title text-lg font-bold text-center mb-2">${options.title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'}</div>
                    <div class="alert-message text-sm text-gray-400 text-center mb-5">${options.message || ''}</div>
                    <div class="alert-buttons flex gap-3">
                        ${options.showCancel ? '<button class="alert-btn cancel flex-1 bg-transparent border border-[#2a313c] py-3 rounded-full text-sm" id="alert-cancel">' + (options.cancelText || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') + '</button>' : ''}
                        <button class="alert-btn confirm flex-1 bg-[#06c755] text-black py-3 rounded-full text-sm font-bold" id="alert-confirm">${options.confirmText || '‡∏ï‡∏Å‡∏•‡∏á'}</button>
                    </div>
                `;
                document.body.appendChild(overlay);
                document.body.appendChild(alert);
                document.getElementById('alert-confirm').addEventListener('click', () => { document.body.removeChild(overlay); document.body.removeChild(alert); resolve(true); });
                if (options.showCancel) {
                    document.getElementById('alert-cancel').addEventListener('click', () => { document.body.removeChild(overlay); document.body.removeChild(alert); resolve(false); });
                }
            });
        }

        // ========== UTILS ==========
        function showLoading() { loading.classList.add('active'); state.isLoading = true; }
        function hideLoading() { loading.classList.remove('active'); state.isLoading = false; }
        function showToast(msg, type = 'success') {
            toastMessage.textContent = msg;
            toast.className = 'toast';
            toast.classList.add(type);
            const iconMap = { success: 'fa-check-circle', warning: 'fa-exclamation-triangle', error: 'fa-times-circle', info: 'fa-info-circle' };
            toastIcon.className = `fas ${iconMap[type]} toast-icon`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        function getApprovalStatusText(status) {
            const map = { 'pending': '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'approved': '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', 'rejected': '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
            return map[status] || status;
        }
        function getApprovalStatusClass(status) {
            const map = { 'pending': 'status-pending', 'approved': 'status-approved', 'rejected': 'status-rejected' };
            return map[status] || '';
        }

        // ========== API CALL ==========
        async function callGAS(path, data = {}) {
            if (!state.isLoading) showLoading();
            try {
                const formData = new FormData();
                formData.append('path', path);
                if (state.user?.lineUserId) formData.append('lineUserId', state.user.lineUserId);
                Object.keys(data).forEach(key => { if (data[key] !== undefined && data[key] !== null) formData.append(key, data[key]); });
                console.log('Calling GAS:', path, data);
                const response = await fetch(CONFIG.GAS_URL, { method: 'POST', body: formData });
                const text = await response.text();
                console.log('GAS Response:', text);
                try { return JSON.parse(text); } catch (e) { throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
            } catch (error) {
                console.error('API call error:', error);
                showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
                return { success: false, message: error.message };
            } finally { hideLoading(); }
        }

        // ========== IMAGE UPLOAD ==========
        async function uploadImageToDrive(file) {
            showLoading();
            try {
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                const result = await callGAS('uploadImage', {
                    fileName: file.name,
                    fileType: file.type,
                    fileData: base64,
                    folderId: CONFIG.DRIVE_FOLDER_ID
                });
                if (result.success) {
                    const fileId = result.data.fileId;
                    return `https://lh5.googleusercontent.com/d/${fileId}=s0`;
                } else throw new Error(result.message);
            } catch (error) {
                console.error('Upload error:', error);
                showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                return null;
            } finally { hideLoading(); }
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ========== LIFF INIT ==========
        async function initLIFF() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const idToken = liff.getDecodedIDToken();
                const result = await callGAS('user/profile', {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    email: idToken?.email || ''
                });
                if (result.success) {
                    state.user = result.data;
                    state.isAdmin = state.user.role === 'admin';
                    state.isEditor = state.user.role === 'editor';
                    await loadSettings();
                    await Promise.all([
                        loadPosts(),
                        loadMyPosts(),
                        loadNotifications(),
                        state.isAdmin ? loadPendingPosts() : Promise.resolve(),
                        state.isAdmin ? loadAllPosts() : Promise.resolve(),
                        state.isAdmin ? loadUsers() : Promise.resolve(),
                        state.isAdmin ? loadAdminStats() : Promise.resolve()
                    ]);
                    updateUI();
                    const urlParams = new URLSearchParams(window.location.search);
                    const postId = urlParams.get('post');
                    if (postId) await showPostDetail(postId);
                } else showToast(result.message, 'error');
            } catch (err) {
                console.error('LIFF init error:', err);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // ========== UPDATE UI ==========
        function updateUI() {
            document.getElementById('profile-avatar').src = state.user?.pictureUrl || 'https://via.placeholder.com/100/06c755/ffffff?text=LINE';
            const roleText = { 'admin': 'üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'editor': '‚úèÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', 'user': 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' }[state.user?.role] || '';
            // no need to show role in header now, but keep for other places
            const adminNav = document.querySelector('.admin-only');
            if (state.isAdmin) adminNav.classList.remove('hidden'); else adminNav.classList.add('hidden');

            const createBtn = document.getElementById('create-post-btn');
            if (createBtn) {
                if (state.isAdmin || state.isEditor) createBtn.classList.remove('hidden');
                else createBtn.classList.add('hidden');
            }

            const statusInfo = document.getElementById('post-status-info');
            const statusText = document.getElementById('post-status-text');
            if (statusInfo && statusText) {
                if (state.isAdmin) {
                    statusInfo.className = 'mb-5 p-4 rounded-2xl bg-[#06c755]/10 border border-[#06c755] text-[#06c755]';
                    statusText.innerHTML = '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏∞‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ <i class="fas fa-check-circle ml-1"></i>';
                } else if (state.isEditor) {
                    statusInfo.className = 'mb-5 p-4 rounded-2xl bg-yellow-500/10 border border-yellow-500 text-yellow-500';
                    statusText.innerHTML = '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <i class="fas fa-clock ml-1"></i>';
                } else statusInfo.classList.add('hidden');
            }

            const statusContainer = document.getElementById('post-status-container');
            if (statusContainer) {
                if (state.isAdmin) statusContainer.classList.remove('hidden');
                else statusContainer.classList.add('hidden');
            }
            updateMyPostsBadge();
        }

        function updateMyPostsBadge() {
            const pendingCount = state.myPosts.filter(p => p.approvalStatus === 'pending').length;
            const badge = document.getElementById('my-posts-badge');
            if (pendingCount > 0) { badge.textContent = pendingCount > 9 ? '9+' : pendingCount; badge.classList.remove('hidden'); } 
            else badge.classList.add('hidden');
        }

        // ========== LOAD SETTINGS ==========
        async function loadSettings() {
            const result = await callGAS('settings');
            if (result.success) {
                state.settings = result.data || {};
                document.getElementById('setting-app-name').value = state.settings.appName || 'LINE ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£';
                document.getElementById('setting-drive-folder').value = state.settings.driveFolderId || CONFIG.DRIVE_FOLDER_ID;
                document.getElementById('setting-allow-user-posts').value = state.settings.allowUserPosts || 'false';
            }
        }

        // ========== POSTS ==========
        async function loadPosts() {
            const result = await callGAS('posts', {
                page: state.currentPage,
                filter: state.currentFilter,
                search: state.searchTerm,
                pageSize: CONFIG.PAGE_SIZE
            });
            if (result.success) {
                state.posts = result.data.posts || [];
                document.getElementById('stat-news').textContent = result.data.stats?.news || 0;
                document.getElementById('stat-events').textContent = result.data.stats?.events || 0;
                document.getElementById('stat-urgent').textContent = result.data.stats?.urgent || 0;
                renderHeroSlider();
                renderPosts();
            }
        }

        async function loadAllPosts() {
            if (!state.isAdmin) return;
            const result = await callGAS('admin/posts', { pageSize: 50 });
            if (result.success) { state.allPosts = result.data || []; renderAdminPosts(); }
        }

        function renderHeroSlider() {
            const wrapper = document.getElementById('hero-slider-wrapper');
            if (!wrapper) return;
            const featured = state.posts.filter(p => p.approvalStatus === 'approved').slice(0, 5);
            if (featured.length === 0) { wrapper.innerHTML = ''; return; }
            wrapper.innerHTML = featured.map(post => {
                const typeText = { 'news': 'üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£', 'event': 'üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'urgent': '‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô' }[post.type] || post.type;
                const badgeClass = { 'news': 'news', 'event': 'event', 'urgent': 'urgent' }[post.type] || 'news';
                return `
                    <div class="swiper-slide cursor-pointer" onclick="showPostDetail('${post.postId}')">
                        <img src="${post.imageUrl || 'https://via.placeholder.com/400/2a313c/ffffff?text=LINE'}" class="w-full h-full object-cover" loading="lazy">
                        <span class="slide-badge ${badgeClass}">${typeText}</span>
                        <div class="slide-content">
                            <h3 class="font-bold text-lg line-clamp-2">${post.title}</h3>
                            <p class="text-xs text-gray-300 mt-1">${formatDateShort(post.createdAt)}</p>
                        </div>
                    </div>
                `;
            }).join('');
            new Swiper('.hero-swiper', { autoplay: { delay: 3000, disableOnInteraction: false }, pagination: { el: '.swiper-pagination', clickable: true }, loop: true, speed: 500 });
        }

        function renderPosts() {
            const list = document.getElementById('posts-list');
            if (state.posts.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-newspaper text-4xl text-gray-600 mb-3"></i><p class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p></div>';
                return;
            }
            list.innerHTML = state.posts.map(post => {
                const typeClass = { 'news': 'news', 'event': 'event', 'urgent': 'urgent' }[post.type] || 'news';
                const typeText = { 'news': 'üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£', 'event': 'üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'urgent': '‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô' }[post.type] || post.type;
                return `
                    <div class="news-card approved" onclick="showPostDetail('${post.postId}')" data-aos="fade-up">
                        <button class="share-button" onclick="event.stopPropagation(); sharePost('${post.postId}')"><i class="fab fa-line"></i></button>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" class="news-card-image" loading="lazy">` : ''}
                        <div class="news-card-content">
                            <div class="meta-row">
                                <span class="type-badge ${typeClass}">${typeText}</span>
                                <span class="date"><i class="far fa-calendar-alt mr-1"></i>${formatDateShort(post.createdAt)}</span>
                            </div>
                            <h3 class="news-title">${post.title}</h3>
                            <p class="news-excerpt">${post.content}</p>
                            <div class="card-footer">
                                <span class="author"><i class="fas fa-user-circle"></i> ${post.authorName || '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'}</span>
                                <span class="stats"><span><i class="far fa-eye"></i> ${post.viewCount || 0}</span></span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAdminPosts() {
            const list = document.getElementById('admin-posts-list');
            if (!list) return;
            if (state.allPosts.length === 0) { list.innerHTML = '<p class="text-gray-400 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p>'; return; }
            list.innerHTML = state.allPosts.map(post => {
                const typeIcon = { 'news': 'üì∞', 'event': 'üéâ', 'urgent': '‚ö†Ô∏è' }[post.type] || 'üìÑ';
                const approvalClass = getApprovalStatusClass(post.approvalStatus);
                const approvalText = getApprovalStatusText(post.approvalStatus);
                return `
                    <div class="flex justify-between items-center p-4 bg-[#111317] rounded-2xl cursor-pointer hover:bg-[#1a1e24] transition-all border border-[#2a313c] hover:border-[#06c755]" onclick="showPostDetail('${post.postId}')">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1"><span class="text-lg">${typeIcon}</span><span class="font-semibold">${post.title}</span></div>
                            <p class="text-xs text-gray-400">${formatDateShort(post.createdAt)} ‚Ä¢ ‡πÇ‡∏î‡∏¢ ${post.authorName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="status-badge ${approvalClass} text-xs">${approvalText}</span>
                            <span class="text-xs ${post.status === 'published' ? 'text-[#06c755]' : 'text-gray-500'}">${post.status}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== MY POSTS ==========
        async function loadMyPosts() {
            const result = await callGAS('user/posts');
            if (result.success) { state.myPosts = result.data || []; renderMyPosts(); updateMyPostsBadge(); }
        }

        function renderMyPosts() {
            const list = document.getElementById('my-posts-list');
            if (state.myPosts.length === 0) {
                list.innerHTML = `<div class="empty-state"><i class="fas fa-pen-fancy text-4xl text-gray-600 mb-3"></i><p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p>${
                    (state.isAdmin || state.isEditor) ? '<button class="mt-5 bg-[#06c755] text-black px-5 py-2 rounded-full text-sm font-bold" onclick="showCreatePostModal()"><i class="fas fa-plus mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏£‡∏Å</button>' : ''
                }</div>`;
                return;
            }
            list.innerHTML = state.myPosts.map(post => {
                const typeIcon = { 'news': 'üì∞', 'event': 'üéâ', 'urgent': '‚ö†Ô∏è' }[post.type] || 'üìÑ';
                const approvalClass = getApprovalStatusClass(post.approvalStatus);
                const approvalText = getApprovalStatusText(post.approvalStatus);
                const cardClass = post.approvalStatus === 'pending' ? 'news-card pending' : post.approvalStatus === 'rejected' ? 'news-card rejected' : 'news-card approved';
                return `
                    <div class="${cardClass}" onclick="showPostDetail('${post.postId}')" data-aos="fade-up">
                        <div class="news-card-content">
                            <div class="flex justify-between items-start mb-2">
                                <span class="type-badge news">${typeIcon}</span>
                                <div class="flex gap-2"><span class="status-badge ${approvalClass}">${approvalText}</span></div>
                            </div>
                            <h3 class="news-title">${post.title}</h3>
                            <p class="news-excerpt">${post.content}</p>
                            ${post.approvalStatus === 'pending' ? '<span class="text-xs text-yellow-500 block mt-2"><i class="fas fa-clock mr-1"></i> ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>' : ''}
                            ${post.approvalStatus === 'rejected' ? '<span class="text-xs text-red-500 block mt-2"><i class="fas fa-exclamation-circle mr-1"></i> ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>' : ''}
                            <div class="card-footer mt-3"><span class="date"><i class="far fa-calendar-alt mr-1"></i>${formatDate(post.createdAt)}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== PENDING POSTS (ADMIN) ==========
        async function loadPendingPosts() {
            if (!state.isAdmin) return;
            const result = await callGAS('admin/pending-posts');
            if (result.success) { state.pendingPosts = result.data || []; renderPendingPosts(); updatePendingBadge(); }
        }

        function renderPendingPosts() {
            const section = document.getElementById('pending-posts-section');
            const list = document.getElementById('pending-posts-list');
            const countSpan = document.getElementById('pending-count');
            if (!section || !list) return;
            if (state.pendingPosts.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            countSpan.textContent = state.pendingPosts.length;
            list.innerHTML = state.pendingPosts.map(post => {
                const typeIcon = { 'news': 'üì∞', 'event': 'üéâ', 'urgent': '‚ö†Ô∏è' }[post.type] || 'üìÑ';
                return `
                    <div class="bg-[#111317] p-5 rounded-2xl border border-yellow-500/30">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1.5 rounded-full bg-yellow-500/20 text-yellow-500 text-xs font-medium">${typeIcon} ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                            <span class="text-xs text-gray-400">${formatDateShort(post.createdAt)}</span>
                        </div>
                        <h4 class="font-semibold text-lg mb-2">${post.title}</h4>
                        <p class="text-sm text-gray-400 line-clamp-2 mb-3">${post.content}</p>
                        <p class="text-xs text-gray-500 mb-4">‡πÇ‡∏î‡∏¢: ${post.authorName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</p>
                        <div class="flex gap-2">
                            <button class="flex-1 bg-[#06c755] text-black py-2 rounded-full text-sm font-bold" onclick="approvePost('${post.postId}')"><i class="fas fa-check mr-1"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button class="flex-1 bg-[#f85149] text-white py-2 rounded-full text-sm font-bold" onclick="showRejectModal('${post.postId}')"><i class="fas fa-times mr-1"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                            <button class="flex-1 bg-transparent border border-[#2a313c] text-white py-2 rounded-full text-sm" onclick="showPostDetail('${post.postId}')"><i class="fas fa-eye mr-1"></i> ‡∏î‡∏π</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePendingBadge() {
            const badge = document.getElementById('admin-pending-badge');
            if (state.pendingPosts.length > 0) { badge.textContent = state.pendingPosts.length > 9 ? '9+' : state.pendingPosts.length; badge.classList.remove('hidden'); } 
            else badge.classList.add('hidden');
        }

        // ========== APPROVAL FUNCTIONS ==========
        async function approvePost(postId) {
            if (!state.isAdmin) { showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 'error'); return; }
            const targetPostId = postId || state.currentPost?.postId;
            if (!targetPostId) return;
            const confirmed = await showAlert({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', type: 'warning', showCancel: true, confirmText: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
            if (!confirmed) return;
            const result = await callGAS('post/approve', { postId: targetPostId });
            if (result.success) {
                showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeModal(); closeRejectModal();
                await Promise.all([ loadPosts(), loadMyPosts(), loadPendingPosts(), loadAllPosts(), loadAdminStats() ]);
            }
        }
        function approveCurrentPost() { approvePost(state.currentPost?.postId); }

        function showRejectModal(postId) {
            if (postId) { callGAS('post', { postId }).then(result => { if (result.success) { state.currentPost = result.data; document.getElementById('reject-modal').classList.add('active'); } }); } 
            else document.getElementById('reject-modal').classList.add('active');
        }
        function closeRejectModal() { document.getElementById('reject-modal').classList.remove('active'); document.getElementById('reject-reason').value = ''; }

        async function rejectPost(e) {
            e.preventDefault();
            if (!state.isAdmin) { showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 'error'); return; }
            const postId = state.currentPost?.postId; if (!postId) return;
            const reason = document.getElementById('reject-reason').value;
            const confirmed = await showAlert({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', type: 'error', showCancel: true, confirmText: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
            if (!confirmed) return;
            const result = await callGAS('post/reject', { postId, reason });
            if (result.success) { showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning'); closeRejectModal(); closeModal(); await Promise.all([ loadPosts(), loadMyPosts(), loadPendingPosts(), loadAllPosts(), loadAdminStats() ]); }
        }

        // ========== SHARE ==========
        async function sharePost(postId) {
            if (!liff.isInClient()) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE', 'error'); return; }
            const result = await callGAS('post', { postId });
            if (!result.success) { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏û‡∏™‡∏ï‡πå', 'error'); return; }
            const post = result.data;
            if (post.approvalStatus !== 'approved') { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'warning'); return; }
            const flexMessage = { type: 'flex', altText: post.title, contents: { type: 'bubble', hero: post.imageUrl ? { type: 'image', url: post.imageUrl, size: 'full', aspectRatio: '20:13', aspectMode: 'cover', action: { type: 'uri', uri: `https://line.me/R/app/${CONFIG.LIFF_ID}?post=${postId}` } } : null, body: { type: 'box', layout: 'vertical', contents: [ { type: 'text', text: post.title, weight: 'bold', size: 'xl', wrap: true }, { type: 'box', layout: 'baseline', margin: 'md', contents: [ { type: 'text', text: { 'news': 'üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£', 'event': 'üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'urgent': '‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô' }[post.type] || post.type, size: 'sm', color: '#06c755', weight: 'bold' } ] }, { type: 'text', text: post.content, wrap: true, color: '#666666', size: 'sm', margin: 'md', maxLines: 5 }, { type: 'box', layout: 'vertical', margin: 'md', contents: [ { type: 'text', text: `‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢: ${post.authorName || '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'}`, size: 'xs', color: '#aaaaaa' }, { type: 'text', text: formatDate(post.createdAt), size: 'xs', color: '#aaaaaa', margin: 'xs' } ] } ] }, footer: { type: 'box', layout: 'vertical', spacing: 'sm', contents: [ { type: 'button', style: 'primary', color: '#06c755', action: { type: 'uri', label: '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', uri: `https://line.me/R/app/${CONFIG.LIFF_ID}?post=${postId}` } } ] } } };
            try { await liff.shareTargetPicker([flexMessage]); showToast('‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); } catch (err) { console.error('Share error:', err); showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ', 'error'); }
        }
        async function shareAsFlexMessage() { if (state.currentPost) await sharePost(state.currentPost.postId); }

        // ========== POST DETAIL ==========
        async function showPostDetail(postId) {
            const result = await callGAS('post', { postId });
            if (result.success) {
                state.currentPost = result.data; const post = result.data;
                document.getElementById('modal-title').textContent = post.title;
                const typeText = { 'news': 'üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£', 'event': 'üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'urgent': '‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô' }[post.type] || post.type;
                const approvalStatus = post.approvalStatus || 'approved';
                const approvalText = getApprovalStatusText(approvalStatus);
                const approvalClass = approvalStatus === 'pending' ? 'pending' : approvalStatus === 'approved' ? 'approved' : 'rejected';
                const approvalBanner = document.getElementById('modal-approval-banner');
                if (approvalStatus !== 'approved') {
                    approvalBanner.className = `approval-banner p-4 rounded-2xl mb-4 ${approvalClass}`;
                    approvalBanner.innerHTML = `<i class="fas ${approvalStatus === 'pending' ? 'fa-clock' : 'fa-exclamation-circle'} mr-3"></i><div><div class="font-medium">${approvalText}</div>${approvalStatus === 'rejected' && post.rejectReason ? `<div class="text-sm mt-1 opacity-90">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${post.rejectReason}</div>` : ''}</div>`;
                    approvalBanner.classList.remove('hidden');
                } else approvalBanner.classList.add('hidden');

                let html = `${post.imageUrl ? `<img src="${post.imageUrl}" class="w-full h-56 object-cover rounded-2xl" loading="lazy">` : ''}
                    <div class="flex justify-between items-center"><span class="type-badge ${post.type}">${typeText}</span><span class="text-sm text-gray-400"><i class="far fa-eye mr-1"></i>${post.viewCount || 0}</span></div>
                    <div class="text-gray-300 leading-relaxed whitespace-pre-wrap">${post.content}</div>
                    <div class="text-sm text-gray-500 border-t border-[#2a313c] pt-5 space-y-2">
                        <p><i class="fas fa-user mr-3"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢: ${post.authorName || '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'}</p>
                        <p><i class="fas fa-calendar-alt mr-3"></i> ${formatDate(post.createdAt)}</p>
                        ${post.link ? `<p><i class="fas fa-link mr-3"></i> <a href="${post.link}" target="_blank" class="text-[#06c755] hover:underline">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a></p>` : ''}
                    </div>`;
                document.getElementById('modal-body').innerHTML = html;

                const shareBtn = document.getElementById('modal-share-btn');
                if (approvalStatus === 'approved') shareBtn.classList.remove('hidden'); else shareBtn.classList.add('hidden');

                const isOwner = post.authorId === state.user?.lineUserId;
                document.getElementById('modal-owner-controls').classList.toggle('hidden', !isOwner);
                if (state.isAdmin) {
                    document.getElementById('modal-admin-controls').classList.remove('hidden');
                    document.getElementById('modal-approval-buttons').classList.toggle('hidden', approvalStatus !== 'pending');
                } else document.getElementById('modal-admin-controls').classList.add('hidden');

                document.getElementById('post-modal').classList.add('active');
            }
        }
        function closeModal() { document.getElementById('post-modal').classList.remove('active'); }

        // ========== CREATE/EDIT POST ==========
        function showCreatePostModal() {
            if (!state.isAdmin && !state.isEditor) { showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå', 'error'); return; }
            document.getElementById('create-modal-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('edit-post-id').value = '';
            document.getElementById('post-type').value = 'news';
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('post-image').value = '';
            document.getElementById('post-link').value = '';
            document.getElementById('post-status').value = 'published';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('post-image-file').value = '';

            const statusInfo = document.getElementById('post-status-info');
            const statusText = document.getElementById('post-status-text');
            if (state.isAdmin) {
                statusInfo.className = 'mb-5 p-4 rounded-2xl bg-[#06c755]/10 border border-[#06c755] text-[#06c755]';
                statusText.innerHTML = '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏∞‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ <i class="fas fa-check-circle ml-1"></i>';
                statusInfo.classList.remove('hidden');
            } else if (state.isEditor) {
                statusInfo.className = 'mb-5 p-4 rounded-2xl bg-yellow-500/10 border border-yellow-500 text-yellow-500';
                statusText.innerHTML = '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <i class="fas fa-clock ml-1"></i>';
                statusInfo.classList.remove('hidden');
            } else statusInfo.classList.add('hidden');

            document.getElementById('create-modal').classList.add('active');
        }
        function closeCreateModal() { document.getElementById('create-modal').classList.remove('active'); }

        async function savePost(e) {
            e.preventDefault();
            if (!state.isAdmin && !state.isEditor) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            const id = document.getElementById('edit-post-id').value;
            const isEdit = !!id;

            let imageUrl = document.getElementById('post-image').value;
            const fileInput = document.getElementById('post-image-file');
            if (fileInput.files && fileInput.files[0]) {
                const uploadedUrl = await uploadImageToDrive(fileInput.files[0]);
                if (uploadedUrl) imageUrl = uploadedUrl;
            }

            const data = { type: document.getElementById('post-type').value, title: document.getElementById('post-title').value, content: document.getElementById('post-content').value, imageUrl, link: document.getElementById('post-link').value, status: 'published' };
            if (isEdit) data.postId = id;

            const result = await callGAS(isEdit ? 'post/update' : 'post/create', data);
            if (result.success) {
                const message = result.message || (isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                const approvalStatus = result.data?.approvalStatus;
                showToast(message, approvalStatus === 'pending' ? 'warning' : 'success');
                closeCreateModal();
                await Promise.all([ loadPosts(), loadMyPosts(), state.isAdmin ? loadPendingPosts() : Promise.resolve(), state.isAdmin ? loadAllPosts() : Promise.resolve(), state.isAdmin ? loadAdminStats() : Promise.resolve() ]);
                if (approvalStatus === 'pending' && state.isEditor) setTimeout(() => showToast('üì® ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 'warning'), 500);
            }
        }

        function editCurrentPost() {
            if (!state.currentPost) return;
            if (!state.isAdmin && state.currentPost.authorId !== state.user?.lineUserId) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error'); return; }
            const post = state.currentPost;
            document.getElementById('create-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå';
            document.getElementById('edit-post-id').value = post.postId;
            document.getElementById('post-type').value = post.type || 'news';
            document.getElementById('post-title').value = post.title || '';
            document.getElementById('post-content').value = post.content || '';
            document.getElementById('post-image').value = post.imageUrl || '';
            document.getElementById('post-link').value = post.link || '';
            document.getElementById('post-status').value = post.status || 'published';
            if (post.imageUrl) { document.getElementById('image-preview').src = post.imageUrl; document.getElementById('image-preview').style.display = 'block'; } 
            else document.getElementById('image-preview').style.display = 'none';

            const statusInfo = document.getElementById('post-status-info');
            const statusText = document.getElementById('post-status-text');
            if (state.isAdmin) {
                statusInfo.className = 'mb-5 p-4 rounded-2xl bg-[#06c755]/10 border border-[#06c755] text-[#06c755]';
                statusText.innerHTML = '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∞‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ <i class="fas fa-check-circle ml-1"></i>';
                statusInfo.classList.remove('hidden');
            } else if (state.isEditor) {
                statusInfo.className = 'mb-5 p-4 rounded-2xl bg-yellow-500/10 border border-yellow-500 text-yellow-500';
                statusText.innerHTML = '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á <i class="fas fa-clock ml-1"></i>';
                statusInfo.classList.remove('hidden');
            } else statusInfo.classList.add('hidden');

            closeModal(); document.getElementById('create-modal').classList.add('active');
        }

        async function deleteCurrentPost() {
            if (!state.currentPost) return;
            if (!state.isAdmin && state.currentPost.authorId !== state.user?.lineUserId) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö', 'error'); return; }
            const confirmed = await showAlert({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', type: 'error', showCancel: true, confirmText: '‡∏•‡∏ö', cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
            if (!confirmed) return;
            const result = await callGAS('post/delete', { postId: state.currentPost.postId });
            if (result.success) { showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); closeModal(); await Promise.all([ loadPosts(), loadMyPosts(), state.isAdmin ? loadPendingPosts() : Promise.resolve(), state.isAdmin ? loadAllPosts() : Promise.resolve(), state.isAdmin ? loadAdminStats() : Promise.resolve() ]); }
        }

        // ========== NOTIFICATIONS ==========
        async function loadNotifications() {
            const result = await callGAS('user/notifications', { unreadOnly: 'true' });
            if (result.success) {
                state.notifications = result.data.notifications || [];
                const unread = result.data.unreadCount || 0;
                const badge = document.getElementById('notif-badge');
                if (unread > 0) { badge.textContent = unread > 9 ? '9+' : unread; badge.classList.remove('hidden'); } 
                else badge.classList.add('hidden');
                renderNotifications();
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notifications-list');
            if (state.notifications.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-bell-slash text-4xl text-gray-600 mb-3"></i><p class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p></div>';
                return;
            }
            list.innerHTML = state.notifications.map(n => {
                const isUnread = n.isRead !== 'TRUE';
                return `<div class="notification-item ${isUnread ? 'unread' : ''} p-5 bg-[#1a1e24] rounded-2xl border border-[#2a313c] cursor-pointer hover:border-[#06c755]" onclick="markNotificationAsRead('${n.notifId}')">
                    <div class="font-semibold mb-2">${n.title}</div>
                    <div class="text-sm text-gray-400 mb-3">${n.message}</div>
                    <div class="text-xs text-gray-500"><i class="far fa-clock mr-1"></i>${formatDate(n.createdAt)}</div>
                </div>`;
            }).join('');
        }

        // ========== MODIFIED: markNotificationAsRead with immediate badge update ==========
        async function markNotificationAsRead(notifId) {
            const result = await callGAS('user/notification/read', { notifId });
            if (result.success) {
                const notif = state.notifications.find(n => n.notifId === notifId);
                if (notif) notif.isRead = 'TRUE';
                const unreadCount = state.notifications.filter(n => n.isRead !== 'TRUE').length;
                const badge = document.getElementById('notif-badge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                // remove unread class from clicked item
                const el = event?.currentTarget;
                if (el) el.classList.remove('unread');
                showToast('‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'info');
            }
        }

        async function markAllNotificationsAsRead() {
            if (state.notifications.length === 0) return;
            const confirmed = await showAlert({ title: '‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', type: 'info', showCancel: true, confirmText: '‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
            if (!confirmed) return;
            const result = await callGAS('user/notifications/read-all');
            if (result.success) {
                state.notifications.forEach(n => n.isRead = 'TRUE');
                document.querySelectorAll('.notification-item.unread').forEach(el => el.classList.remove('unread'));
                document.getElementById('notif-badge').classList.add('hidden');
                showToast('‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        // ========== ADMIN: USERS ==========
        async function loadUsers() {
            if (!state.isAdmin) return;
            const result = await callGAS('admin/users');
            if (result.success) { state.users = result.data || []; renderUsers(); }
        }

        function renderUsers() {
            const list = document.getElementById('users-list');
            const search = document.getElementById('user-search')?.value?.toLowerCase() || '';
            const filtered = state.users.filter(u => u.displayName?.toLowerCase().includes(search) || u.email?.toLowerCase().includes(search));
            if (filtered.length === 0) { list.innerHTML = '<p class="text-gray-400 text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>'; return; }
            list.innerHTML = filtered.map(user => {
                const roleClass = { 'admin': 'role-admin', 'editor': 'role-editor', 'user': 'role-user' }[user.role] || 'role-user';
                const roleText = { 'admin': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'editor': '‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', 'user': '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' }[user.role] || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                return `<div class="user-row flex items-center gap-3 p-4 bg-[#1a1e24] rounded-2xl border border-[#2a313c] hover:border-[#06c755]">
                    <img src="${user.pictureUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border-2 border-[#06c755]">
                    <div class="flex-1"><p class="font-semibold">${user.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</p><p class="text-xs text-gray-400">${user.email || ''}</p></div>
                    <span class="status-badge ${roleClass}">${roleText}</span>
                    ${state.isAdmin ? `<button class="text-[#06c755] text-sm hover:scale-110" onclick="showRoleModal('${user.lineUserId}', '${user.displayName}', '${user.role}')"><i class="fas fa-cog text-lg"></i></button>` : ''}
                </div>`;
            }).join('');
        }

        function showRoleModal(userId, userName, currentRole) {
            document.getElementById('role-user-id').value = userId;
            document.getElementById('role-user-name').textContent = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${userName}`;
            document.getElementById('user-role').value = currentRole || 'user';
            document.getElementById('role-modal').classList.add('active');
        }
        function closeRoleModal() { document.getElementById('role-modal').classList.remove('active'); }
        async function saveUserRole(e) {
            e.preventDefault();
            const userId = document.getElementById('role-user-id').value;
            const role = document.getElementById('user-role').value;
            const result = await callGAS('admin/user/role', { targetUserId: userId, role });
            if (result.success) { showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); closeRoleModal(); await loadUsers(); }
        }

        // ========== ADMIN: STATS ==========
        async function loadAdminStats() {
            if (!state.isAdmin) return;
            const result = await callGAS('admin/stats');
            if (result.success) {
                const stats = result.data;
                document.getElementById('admin-users').textContent = stats.users || 0;
                document.getElementById('admin-posts').textContent = stats.posts || 0;
                document.getElementById('admin-today').textContent = stats.today || 0;
                document.getElementById('admin-pending').textContent = stats.pending || 0;
            }
        }

        // ========== SETTINGS ==========
        async function saveSettings(e) {
            e.preventDefault();
            if (!state.isAdmin) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            const data = { appName: document.getElementById('setting-app-name').value, driveFolderId: document.getElementById('setting-drive-folder').value, allowUserPosts: document.getElementById('setting-allow-user-posts').value };
            const result = await callGAS('admin/settings/update', data);
            if (result.success) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); Object.assign(state.settings, data); updateUI(); }
        }

        // ========== PROFILE ==========
        function showProfileSettings() {
            document.getElementById('profile-phone').value = state.user?.phone || '';
            document.getElementById('profile-department').value = state.user?.department || '';
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('profile-dropdown').classList.remove('show');
        }
        function closeProfileModal() { document.getElementById('profile-modal').classList.remove('active'); }
        async function saveProfile(e) {
            e.preventDefault();
            const data = { phone: document.getElementById('profile-phone').value, department: document.getElementById('profile-department').value };
            const result = await callGAS('user/update', data);
            if (result.success) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); closeProfileModal(); Object.assign(state.user, data); updateUI(); }
        }

        function logout() {
            showAlert({ title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', type: 'warning', showCancel: true, confirmText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }).then(confirmed => {
                if (confirmed) { if (liff.isLoggedIn()) liff.logout(); location.reload(); }
            });
        }

        // ========== TAB NAVIGATION ==========
        document.querySelectorAll('.nav-item').forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${target}`).classList.add('active');
                if (target === 'home') loadPosts();
                if (target === 'my') loadMyPosts();
                if (target === 'notifications') loadNotifications();
                if (target === 'admin' && state.isAdmin) { loadAdminStats(); loadPendingPosts(); loadAllPosts(); loadUsers(); }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });

        // ========== ADMIN TABS ==========
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.adminTab;
                document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
                document.getElementById(`admin-${target}-tab`).classList.remove('hidden');
            });
        });

        // ========== SEARCH ==========
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { state.searchTerm = e.target.value; state.currentPage = 1; loadPosts(); }, 500);
        });
        document.getElementById('user-search')?.addEventListener('input', renderUsers);

        // ========== FILTER ==========
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentFilter = btn.dataset.filter;
                state.currentPage = 1;
                loadPosts();
            });
        });

        // ========== REFRESH ADMIN ==========
        document.getElementById('refresh-admin')?.addEventListener('click', () => { if (state.isAdmin) { loadAdminStats(); loadPendingPosts(); loadAllPosts(); loadUsers(); showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); } });

        // ========== PROFILE DROPDOWN TOGGLE ==========
        document.getElementById('profile-avatar').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('profile-dropdown').classList.toggle('show');
        });
        document.addEventListener('click', () => { document.getElementById('profile-dropdown').classList.remove('show'); });

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading();
            try { if (typeof liff !== 'undefined') await initLIFF(); else window.addEventListener('load', async () => await initLIFF()); } 
            catch (err) { console.error(err); showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ', 'error'); } 
            finally { hideLoading(); }
        });

        // Close modals on outside click
        window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); };
    </script>
</body>
</html>
