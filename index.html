<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>iTNews ¬∑ LINE</title>
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/653/653021.png">
    
    <!-- Inline Critical CSS - ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ -->
    <style>
        /* Core styles - minimal */
        *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,'Segoe UI',sans-serif;}
        :root{--primary:#06c755;--bg:#0a0a0f;--bg-card:#1a1d24;--border:#2a2e36;--text:#fff;--text-secondary:#9ca3af;}
        body{background:var(--bg);color:var(--text);padding-bottom:70px;}
        
        /* Loading screen */
        .loading-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;transition:opacity .2s;}
        .loading-screen.hide{opacity:0;pointer-events:none;}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        
        /* Layout */
        .navbar{position:sticky;top:0;background:rgba(10,10,15,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:12px 16px;z-index:100;}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(26,29,36,.95);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;padding:8px 0;z-index:100;}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--text-secondary);font-size:12px;cursor:pointer;}
        .nav-item.active{color:var(--primary);}
        .tab-content{display:none;}
        .tab-content.active{display:block;}
        
        /* Profile */
        .profile-header{background:var(--bg-card);border-radius:16px;padding:16px;margin:16px;display:flex;align-items:center;gap:12px;border:1px solid var(--border);cursor:pointer;}
        .profile-avatar{width:48px;height:48px;border-radius:50%;border:2px solid var(--primary);object-fit:cover;background:var(--border);}
        
        /* Search & Filter */
        .search-box{position:relative;max-width:1200px;margin:0 auto 16px;padding:0 16px;}
        .search-box input{width:100%;padding:12px 40px;background:var(--bg-card);border:1px solid var(--border);border-radius:30px;color:var(--text);font-size:14px;}
        .filter-container{display:flex;gap:8px;overflow-x:auto;padding:0 16px 16px;max-width:1200px;margin:0 auto;}
        .filter-btn{padding:8px 16px;border-radius:30px;font-size:14px;white-space:nowrap;background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);cursor:pointer;}
        .filter-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);}
        
        /* Posts grid */
        .posts-grid{display:grid;gap:16px;padding:0 16px;max-width:1200px;margin:0 auto;}
        @media (min-width:768px){.posts-grid{grid-template-columns:repeat(2,1fr);}}
        @media (min-width:1024px){.posts-grid{grid-template-columns:repeat(3,1fr);}}
        
        /* Cards */
        .news-card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;}
        .news-image{width:100%;height:180px;object-fit:cover;background:var(--border);}
        .news-content{padding:12px;}
        .badge{padding:4px 8px;border-radius:20px;font-size:11px;display:inline-block;}
        .badge-news{background:rgba(6,199,85,.15);color:var(--primary);}
        .badge-event{background:rgba(245,158,11,.15);color:#f59e0b;}
        .badge-urgent{background:rgba(239,68,68,.15);color:#ef4444;}
        
        /* Modal */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.98);z-index:1000;display:none;overflow-y:auto;}
        .modal.active{display:block;}
        .modal-content{background:var(--bg-card);min-height:100vh;padding:16px;}
        @media (min-width:768px){.modal-content{max-width:800px;margin:20px auto;min-height:auto;border-radius:24px;}}
        
        /* Buttons */
        .btn-primary{background:var(--primary);color:#fff;padding:12px 20px;border-radius:12px;border:none;font-weight:600;cursor:pointer;width:100%;}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed;}
        .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text);padding:12px 20px;border-radius:12px;cursor:pointer;width:100%;}
        .btn-danger{background:#ef4444;color:#fff;padding:12px 20px;border-radius:12px;border:none;font-weight:600;cursor:pointer;width:100%;}
        
        /* Utilities */
        .hidden{display:none!important;}
        .flex{display:flex;}
        .items-center{align-items:center;}
        .justify-between{justify-content:space-between;}
        .gap-2{gap:8px;}
        .gap-4{gap:16px;}
        .w-full{width:100%;}
        .text-center{text-align:center;}
        .text-sm{font-size:14px;}
        .text-xs{font-size:12px;}
        .font-bold{font-weight:700;}
        .text-gray-400{color:var(--text-secondary);}
        .text-[#06c755]{color:var(--primary);}
        .mt-2{margin-top:8px;}
        .mt-4{margin-top:16px;}
        .mb-2{margin-bottom:8px;}
        .mb-4{margin-bottom:16px;}
        .p-4{padding:16px;}
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
        
        /* Skeleton */
        .skeleton{background:linear-gradient(90deg,var(--bg-card) 25%,#252930 50%,var(--bg-card) 75%);background-size:200% 100%;animation:skeleton 1.5s infinite;border-radius:16px;height:280px;}
        @keyframes skeleton{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
    </style>
    
    <!-- Preload important resources -->
    <link rel="preconnect" href="https://static.line-scdn.net">
    <link rel="preconnect" href="https://script.google.com">
    
    <!-- Load LIFF asap -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="spinner"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="flex items-center justify-between" style="max-width:1200px;margin:0 auto;">
            <div class="flex items-center gap-2" onclick="switchTab('home')" style="cursor:pointer;">
                <span style="color:var(--primary);font-size:24px;">üì∞</span>
                <span id="navbar-app-name" style="font-weight:600;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">iTNews</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div>
        <!-- Home Tab -->
        <div id="tab-home" class="tab-content active">
            <!-- Profile Header -->
            <div class="profile-header hidden" id="profile-header">
                <img id="profile-avatar" class="profile-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Crect width='48' height='48' fill='%232a2e36'/%3E%3C/svg%3E">
                <div style="flex:1;">
                    <div id="profile-name" class="font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    <div id="profile-email" class="text-sm text-gray-400"></div>
                </div>
                <span style="color:var(--text-secondary);">‚ñº</span>
            </div>

            <!-- Stats -->
            <div class="grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:1200px;margin:0 auto 16px;padding:0 16px;">
                <div class="stat-card" style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div class="text-xs text-gray-400">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</div>
                    <div id="stat-news" class="text-xl font-bold" style="color:var(--primary);">0</div>
                </div>
                <div class="stat-card" style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div class="text-xs text-gray-400">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
                    <div id="stat-events" class="text-xl font-bold" style="color:var(--primary);">0</div>
                </div>
                <div class="stat-card" style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
                    <div class="text-xs text-gray-400">‡∏î‡πà‡∏ß‡∏ô</div>
                    <div id="stat-urgent" class="text-xl font-bold" style="color:var(--primary);">0</div>
                </div>
            </div>

            <!-- Hero Slider -->
            <div style="max-width:1200px;margin:0 auto 16px;padding:0 16px;">
                <div id="hero-slider" style="width:100%;height:200px;background:var(--bg-card);border-radius:16px;position:relative;overflow:hidden;"></div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <span style="position:absolute;left:28px;top:50%;transform:translateY(-50%);color:var(--text-secondary);">üîç</span>
                <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...">
            </div>

            <!-- Filter -->
            <div class="filter-container" id="filter-container">
                <button class="filter-btn active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" data-filter="news">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</button>
                <button class="filter-btn" data-filter="event">üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                <button class="filter-btn" data-filter="urgent">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</button>
            </div>

            <!-- Posts List with skeleton -->
            <div id="posts-list" class="posts-grid">
                <div class="skeleton"></div>
                <div class="skeleton"></div>
                <div class="skeleton"></div>
            </div>
        </div>

        <!-- My Posts Tab -->
        <div id="tab-my" class="tab-content hidden">
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold" style="color:var(--primary);font-size:18px;">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                    <button id="create-post-btn" class="hidden" onclick="showCreateModal()" style="background:var(--primary);color:#fff;border:none;padding:8px 16px;border-radius:12px;font-size:14px;cursor:pointer;">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                </div>
                <div id="my-posts-list" class="posts-grid">
                    <div class="skeleton"></div>
                    <div class="skeleton"></div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="tab-admin" class="tab-content hidden">
            <div class="p-4">
                <h2 class="font-bold mb-4" style="color:var(--primary);font-size:18px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                
                <!-- Admin Stats -->
                <div style="background:linear-gradient(135deg,rgba(6,199,85,0.1),transparent);border:1px solid var(--primary);border-radius:16px;padding:16px;margin-bottom:16px;">
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                        <div style="background:var(--bg-card);padding:12px;border-radius:12px;text-align:center;">
                            <div class="text-xs text-gray-400">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
                            <div id="admin-users" class="text-xl font-bold" style="color:var(--primary);">0</div>
                        </div>
                        <div style="background:var(--bg-card);padding:12px;border-radius:12px;text-align:center;">
                            <div class="text-xs text-gray-400">‡πÇ‡∏û‡∏™‡∏ï‡πå</div>
                            <div id="admin-posts" class="text-xl font-bold" style="color:var(--primary);">0</div>
                        </div>
                        <div style="background:var(--bg-card);padding:12px;border-radius:12px;text-align:center;">
                            <div class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                            <div id="admin-today" class="text-xl font-bold" style="color:var(--primary);">0</div>
                        </div>
                        <div style="background:var(--bg-card);padding:12px;border-radius:12px;text-align:center;">
                            <div class="text-xs text-gray-400">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                            <div id="admin-pending" class="text-xl font-bold" style="color:#f59e0b;">0</div>
                        </div>
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div style="display:flex;border-bottom:1px solid var(--border);margin-bottom:16px;">
                    <button class="admin-tab active" data-admin="posts" style="flex:1;padding:12px;background:none;border:none;color:var(--text);cursor:pointer;">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                    <button class="admin-tab" data-admin="pending" style="flex:1;padding:12px;background:none;border:none;color:var(--text);cursor:pointer;">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <span id="pending-count" style="background:#f59e0b;color:#fff;padding:2px 6px;border-radius:10px;font-size:10px;margin-left:4px;display:none;">0</span></button>
                    <button class="admin-tab" data-admin="users" style="flex:1;padding:12px;background:none;border:none;color:var(--text);cursor:pointer;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                </div>

                <!-- Admin Content -->
                <div id="admin-content"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home"><span>üè†</span><span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span></div>
        <div class="nav-item" data-tab="my"><span>‚úèÔ∏è</span><span>‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></div>
        <div class="nav-item hidden" data-tab="admin" id="admin-nav"><span>‚öôÔ∏è</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span></div>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal" id="post-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="font-bold" style="font-size:18px;"></h3>
                <button onclick="closeModal()" style="font-size:24px;background:none;border:none;color:var(--text);cursor:pointer;">‚úï</button>
            </div>
            <div id="modal-body"></div>
            <div class="flex gap-2 mt-4">
                <button class="btn-primary" onclick="sharePost()" id="share-btn" disabled>‡πÅ‡∏ä‡∏£‡πå</button>
                <button class="btn-outline" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
            </div>
            <div id="modal-admin-controls" class="flex gap-2 mt-2 hidden">
                <button class="btn-outline" onclick="editPost()" id="edit-post-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn-danger" onclick="deletePost()" id="delete-post-btn">‡∏•‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="create-modal-title" class="font-bold" style="font-size:18px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå</h3>
                <button onclick="closeCreateModal()" style="font-size:24px;background:none;border:none;color:var(--text);cursor:pointer;">‚úï</button>
            </div>
            <form id="post-form" onsubmit="savePost(event)">
                <select id="post-type" style="width:100%;padding:12px;margin-bottom:12px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);" required>
                    <option value="news">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</option>
                    <option value="event">üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
                    <option value="urgent">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</option>
                </select>
                <input type="text" id="post-title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" style="width:100%;padding:12px;margin-bottom:12px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);" required>
                <textarea id="post-content" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤" rows="5" style="width:100%;padding:12px;margin-bottom:12px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);" required></textarea>
                <input type="file" id="post-image" accept="image/*" style="width:100%;padding:12px;margin-bottom:12px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);">
                <input type="text" id="post-link" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" style="width:100%;padding:12px;margin-bottom:12px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);">
                <img id="image-preview" style="width:100%;max-height:200px;object-fit:cover;border-radius:12px;margin-bottom:12px;display:none;">
                <button type="submit" class="btn-primary" id="save-post-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
        </div>
    </div>

    <!-- Role Modal -->
    <div class="modal" id="role-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold" style="font-size:18px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h3>
                <button onclick="closeRoleModal()" style="font-size:24px;background:none;border:none;color:var(--text);cursor:pointer;">‚úï</button>
            </div>
            <div id="role-user-name" class="mb-4"></div>
            <select id="user-role" style="width:100%;padding:12px;margin-bottom:12px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);">
                <option value="user">üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                <option value="editor">‚úèÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</option>
                <option value="admin">üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</option>
            </select>
            <button class="btn-primary" onclick="saveUserRole()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>

    <script>
        // ========== CONFIG ==========
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwSz6Y_fpvB0qN52eS6QD2RFJD-bJA369B6b86W1ZGVCOrbPXGGbpBIS3hDO8h6awKzkw/exec',
            LIFF_ID: '2008904120-T7I0VPZf'
        };

        // ========== STATE ==========
        const state = {
            user: null,
            posts: [],
            myPosts: [],
            pendingPosts: [],
            users: [],
            comments: {},
            filter: 'all',
            search: '',
            isAdmin: false,
            isEditor: false,
            currentPage: 1,
            currentPost: null,
            settings: { appName: 'iTNews' }
        };

        // ========== DOM Elements ==========
        const dom = {
            loading: document.getElementById('loading-screen'),
            home: document.getElementById('tab-home'),
            my: document.getElementById('tab-my'),
            admin: document.getElementById('tab-admin'),
            postsList: document.getElementById('posts-list'),
            myPostsList: document.getElementById('my-posts-list'),
            adminContent: document.getElementById('admin-content'),
            profileHeader: document.getElementById('profile-header'),
            profileName: document.getElementById('profile-name'),
            profileEmail: document.getElementById('profile-email'),
            profileAvatar: document.getElementById('profile-avatar'),
            statNews: document.getElementById('stat-news'),
            statEvents: document.getElementById('stat-events'),
            statUrgent: document.getElementById('stat-urgent'),
            heroSlider: document.getElementById('hero-slider'),
            search: document.getElementById('search-input'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            navItems: document.querySelectorAll('.nav-item'),
            adminNav: document.getElementById('admin-nav'),
            createBtn: document.getElementById('create-post-btn'),
            modal: document.getElementById('post-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            shareBtn: document.getElementById('share-btn'),
            modalAdminControls: document.getElementById('modal-admin-controls'),
            editPostBtn: document.getElementById('edit-post-btn'),
            deletePostBtn: document.getElementById('delete-post-btn'),
            navbarName: document.getElementById('navbar-app-name'),
            adminUsers: document.getElementById('admin-users'),
            adminPosts: document.getElementById('admin-posts'),
            adminToday: document.getElementById('admin-today'),
            adminPending: document.getElementById('admin-pending'),
            pendingCount: document.getElementById('pending-count')
        };

        // ========== UTILS ==========
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('th-TH') : '';
        const formatDateTime = (d) => d ? new Date(d).toLocaleString('th-TH') : '';

        function showToast(msg, isError = false) {
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed;bottom:80px;left:16px;right:16px;background:${isError?'#ef4444':'#06c755'};color:#fff;padding:12px;border-radius:12px;text-align:center;z-index:9999;`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ========== API CALL ==========
        async function callAPI(path, data = {}) {
            try {
                const formData = new FormData();
                formData.append('path', path);
                if (state.user?.lineUserId) formData.append('lineUserId', state.user.lineUserId);
                Object.keys(data).forEach(k => data[k] !== undefined && formData.append(k, data[k]));

                const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: formData });
                const text = await res.text();
                return JSON.parse(text);
            } catch {
                return { success: false, message: 'connection error' };
            }
        }

        // ========== IMAGE UPLOAD ==========
        async function uploadImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        // ========== INIT ==========
        async function init() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                const token = liff.getDecodedIDToken();

                const result = await callAPI('user/profile', {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    email: token?.email || ''
                });

                if (result.success) {
                    state.user = result.data;
                    state.isAdmin = state.user.role === 'admin';
                    state.isEditor = state.isAdmin || state.user.role === 'editor';

                    // Update UI
                    dom.profileName.textContent = state.user.displayName;
                    dom.profileEmail.textContent = state.user.email || '';
                    dom.profileAvatar.src = state.user.pictureUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\' viewBox=\'0 0 48 48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%232a2e36\'/%3E%3C/svg%3E';
                    dom.profileHeader.classList.remove('hidden');

                    if (state.isAdmin) dom.adminNav.classList.remove('hidden');
                    if (state.isEditor) dom.createBtn.classList.remove('hidden');

                    // Load settings
                    await loadSettings();
                    
                    // Load data in parallel
                    await Promise.all([
                        loadPosts(),
                        loadUrgentPosts(),
                        loadMyPosts()
                    ]);

                    if (state.isAdmin) {
                        loadAdminStats();
                        loadUsers();
                        loadPendingPosts();
                    }

                    // Hide loading
                    setTimeout(() => dom.loading.classList.add('hide'), 200);
                }
            } catch (error) {
                dom.loading.classList.add('hide');
                showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', true);
            }
        }

        // ========== POSTS ==========
        async function loadPosts() {
            const result = await callAPI('posts', {
                page: state.currentPage,
                filter: state.filter,
                search: state.search
            });

            if (result.success) {
                state.posts = result.data.posts || [];
                dom.statNews.textContent = result.data.stats?.news || 0;
                dom.statEvents.textContent = result.data.stats?.events || 0;
                dom.statUrgent.textContent = result.data.stats?.urgent || 0;
                renderPosts();
            }
        }

        function renderPosts() {
            if (!state.posts.length) {
                dom.postsList.innerHTML = '<div class="text-center p-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</div>';
                return;
            }

            dom.postsList.innerHTML = state.posts.map(p => `
                <div class="news-card" onclick="showPost('${p.postId}')">
                    ${p.imageUrl ? `<img src="${p.imageUrl}" class="news-image" loading="lazy">` : ''}
                    <div class="news-content">
                        <div class="flex justify-between items-start mb-2">
                            <span class="badge badge-${p.type}">${{news:'üì∞',event:'üéâ',urgent:'‚ö†Ô∏è'}[p.type]}</span>
                            <span class="text-xs text-gray-400">${formatDate(p.createdAt)}</span>
                        </div>
                        <h3 class="font-bold mb-2 line-clamp-2">${p.title}</h3>
                        <p class="text-sm text-gray-400 line-clamp-2">${p.content}</p>
                    </div>
                </div>
            `).join('');
        }

        // ========== URGENT POSTS ==========
        async function loadUrgentPosts() {
            const result = await callAPI('posts', { filter: 'urgent', pageSize: 5 });
            if (result.success) {
                const urgent = result.data.posts?.filter(p => p.approvalStatus === 'approved') || [];
                renderHeroSlider(urgent);
            }
        }

        function renderHeroSlider(posts) {
            if (!posts.length) {
                dom.heroSlider.innerHTML = '<div style="padding:20px;text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</div>';
                return;
            }

            let current = 0;
            const slide = () => {
                const p = posts[current];
                dom.heroSlider.innerHTML = `
                    <div onclick="showPost('${p.postId}')" style="cursor:pointer;">
                        <img src="${p.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'1200\' height=\'200\' viewBox=\'0 0 1200 200\'%3E%3Crect width=\'1200\' height=\'200\' fill=\'%232a2e36\'/%3E%3C/svg%3E'}" style="width:100%;height:200px;object-fit:cover;">
                        <div style="position:absolute;bottom:0;left:0;right:0;padding:20px;background:linear-gradient(to top, rgba(0,0,0,0.9), transparent);">
                            <h3 style="font-weight:bold;">${p.title}</h3>
                        </div>
                    </div>
                `;
                current = (current + 1) % posts.length;
            };
            
            slide();
            setInterval(slide, 3000);
        }

        // ========== MY POSTS ==========
        async function loadMyPosts() {
            const result = await callAPI('user/posts', { lineUserId: state.user?.lineUserId });
            if (result.success) {
                state.myPosts = result.data.posts || result.data || [];
                renderMyPosts();
            }
        }

        function renderMyPosts() {
            if (!state.myPosts.length) {
                dom.myPostsList.innerHTML = '<div class="text-center p-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</div>';
                return;
            }

            dom.myPostsList.innerHTML = state.myPosts.map(p => `
                <div class="news-card" onclick="showPost('${p.postId}')">
                    ${p.imageUrl ? `<img src="${p.imageUrl}" class="news-image" loading="lazy">` : ''}
                    <div class="news-content">
                        <div class="flex justify-between items-start mb-2">
                            <span class="badge badge-${p.type}">${{news:'üì∞',event:'üéâ',urgent:'‚ö†Ô∏è'}[p.type]}</span>
                            <span class="text-xs ${p.approvalStatus==='approved'?'text-green-500':'text-yellow-500'}">
                                ${p.approvalStatus==='approved'?'‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà':'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
                            </span>
                        </div>
                        <h3 class="font-bold mb-2 line-clamp-2">${p.title}</h3>
                        <p class="text-sm text-gray-400 line-clamp-2">${p.content}</p>
                    </div>
                </div>
            `).join('');
        }

        // ========== POST DETAIL ==========
        window.showPost = async function(postId) {
            dom.modal.classList.add('active');
            dom.modalBody.innerHTML = '<div class="text-center p-8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
            
            const result = await callAPI('post', { postId });
            
            if (result.success) {
                const p = result.data;
                state.currentPost = p;
                dom.modalTitle.textContent = p.title;

                const canEdit = state.isAdmin || (state.isEditor && p.authorId === state.user?.lineUserId);
                const canDelete = state.isAdmin || (state.isEditor && p.authorId === state.user?.lineUserId);

                dom.modalBody.innerHTML = `
                    ${p.imageUrl ? `<img src="${p.imageUrl}" style="width:100%;max-height:300px;object-fit:cover;border-radius:12px;margin-bottom:16px;">` : ''}
                    <div style="margin-bottom:16px;">${p.content}</div>
                    ${p.link ? `<a href="${p.link}" target="_blank" style="display:block;text-align:center;padding:12px;background:var(--primary);color:#fff;border-radius:12px;margin-bottom:16px;text-decoration:none;">üîó ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>` : ''}
                    <div style="font-size:12px;color:var(--text-secondary);">‡πÇ‡∏û‡∏™‡∏ï‡πå: ${formatDateTime(p.createdAt)}</div>
                `;

                dom.shareBtn.disabled = false;

                if (canEdit || canDelete) {
                    dom.modalAdminControls.classList.remove('hidden');
                    dom.editPostBtn.style.display = canEdit ? 'block' : 'none';
                    dom.deletePostBtn.style.display = canDelete ? 'block' : 'none';
                } else {
                    dom.modalAdminControls.classList.add('hidden');
                }

                loadComments(postId);
            }
        };

        window.closeModal = () => dom.modal.classList.remove('active');

        // ========== COMMENTS ==========
        async function loadComments(postId) {
            const result = await callAPI('post/comments', { postId });
            if (result.success) {
                state.comments[postId] = result.data || [];
                renderComments(postId);
            }
        }

        function renderComments(postId) {
            const comments = state.comments[postId] || [];
            const section = document.createElement('div');
            section.innerHTML = `
                <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
                    <h4 style="margin-bottom:12px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (${comments.length})</h4>
                    <div style="margin-bottom:12px;">
                        <textarea id="comment-${postId}" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." style="width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);" rows="2"></textarea>
                        <button onclick="addComment('${postId}')" style="margin-top:8px;padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:12px;">‡∏™‡πà‡∏á</button>
                    </div>
                    <div id="comments-${postId}">
                        ${comments.map(c => `
                            <div style="margin-bottom:12px;padding:12px;background:var(--bg);border-radius:12px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                    <span style="font-weight:600;color:var(--primary);">${c.userName}</span>
                                    <span style="font-size:10px;color:var(--text-secondary);">${formatDate(c.createdAt)}</span>
                                </div>
                                <div>${c.content}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('comments-section');
            if (existing) existing.remove();
            
            section.id = 'comments-section';
            dom.modalBody.appendChild(section);
        }

        window.addComment = async function(postId) {
            const input = document.getElementById(`comment-${postId}`);
            const content = input?.value.trim();
            
            if (!content) return;

            const result = await callAPI('post/comment/add', {
                postId,
                userId: state.user.lineUserId,
                userName: state.user.displayName,
                userPicture: state.user.pictureUrl,
                content
            });

            if (result.success) {
                input.value = '';
                loadComments(postId);
            }
        };

        // ========== SHARE ==========
        window.sharePost = async function() {
            if (!state.currentPost || !liff.isInClient()) return;
            
            const p = state.currentPost;
            await liff.shareTargetPicker([{
                type: 'text',
                text: `${p.title}\n\n${p.content.substring(0,200)}...\n\n‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÉ‡∏ô iTNews`
            }]);
            
            showToast('‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        };

        // ========== CREATE/EDIT POST ==========
        window.showCreateModal = function() {
            document.getElementById('create-modal-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå';
            document.getElementById('edit-post-id')?.remove();
            document.getElementById('post-type').value = 'news';
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('post-link').value = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('create-modal').classList.add('active');
        };

        window.closeCreateModal = () => document.getElementById('create-modal').classList.remove('active');

        window.savePost = async function(e) {
            e.preventDefault();
            
            const file = document.getElementById('post-image').files[0];
            let imageUrl = '';
            
            if (file) {
                imageUrl = await uploadImage(file);
            }

            const data = {
                type: document.getElementById('post-type').value,
                title: document.getElementById('post-title').value,
                content: document.getElementById('post-content').value,
                imageUrl,
                link: document.getElementById('post-link').value,
                lineUserId: state.user.lineUserId
            };

            const result = await callAPI('post/create', data);
            
            if (result.success) {
                showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeCreateModal();
                loadPosts();
                loadMyPosts();
            }
        };

        window.editPost = function() {
            const p = state.currentPost;
            if (!p) return;
            
            document.getElementById('create-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå';
            
            let input = document.getElementById('edit-post-id');
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                input.id = 'edit-post-id';
                document.getElementById('post-form').appendChild(input);
            }
            input.value = p.postId;
            
            document.getElementById('post-type').value = p.type;
            document.getElementById('post-title').value = p.title;
            document.getElementById('post-content').value = p.content;
            document.getElementById('post-link').value = p.link || '';
            
            if (p.imageUrl) {
                const preview = document.getElementById('image-preview');
                preview.src = p.imageUrl;
                preview.style.display = 'block';
            }
            
            closeModal();
            document.getElementById('create-modal').classList.add('active');
        };

        window.deletePost = async function() {
            if (!state.currentPost) return;
            
            if (!confirm('‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ?')) return;
            
            const result = await callAPI('post/delete', { postId: state.currentPost.postId });
            
            if (result.success) {
                showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeModal();
                loadPosts();
                loadMyPosts();
            }
        };

        // ========== ADMIN ==========
        async function loadAdminStats() {
            const result = await callAPI('admin/stats');
            if (result.success) {
                dom.adminUsers.textContent = result.data.users || 0;
                dom.adminPosts.textContent = result.data.posts || 0;
                dom.adminToday.textContent = result.data.today || 0;
                dom.adminPending.textContent = result.data.pending || 0;
            }
        }

        async function loadPendingPosts() {
            const result = await callAPI('admin/posts/pending');
            if (result.success) {
                state.pendingPosts = result.data || [];
                const count = state.pendingPosts.length;
                if (count > 0) {
                    dom.pendingCount.textContent = count;
                    dom.pendingCount.style.display = 'inline';
                } else {
                    dom.pendingCount.style.display = 'none';
                }
                renderAdminPosts();
            }
        }

        function renderAdminPosts() {
            dom.adminContent.innerHTML = state.pendingPosts.map(p => `
                <div style="background:var(--bg-card);padding:16px;border-radius:12px;border:1px solid #f59e0b;margin-bottom:12px;">
                    <h4 style="font-weight:bold;margin-bottom:8px;">${p.title}</h4>
                    <p style="color:var(--text-secondary);margin-bottom:12px;">${p.content.substring(0,100)}...</p>
                    <div style="display:flex;gap:8px;">
                        <button onclick="approvePost('${p.postId}')" style="flex:1;padding:8px;background:#28a745;color:#fff;border:none;border-radius:8px;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button onclick="rejectPost('${p.postId}')" style="flex:1;padding:8px;background:#ef4444;color:#fff;border:none;border-radius:8px;">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    </div>
                </div>
            `).join('');
        }

        window.approvePost = async function(postId) {
            const result = await callAPI('admin/post/approve', { postId });
            if (result.success) {
                showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                loadPendingPosts();
                loadPosts();
            }
        };

        window.rejectPost = async function(postId) {
            const result = await callAPI('admin/post/reject', { postId });
            if (result.success) {
                showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                loadPendingPosts();
            }
        };

        async function loadUsers() {
            const result = await callAPI('admin/users');
            if (result.success) {
                state.users = result.data || [];
                renderUsers();
            }
        }

        function renderUsers() {
            dom.adminContent.innerHTML = state.users.map(u => `
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border-radius:12px;margin-bottom:8px;">
                    <img src="${u.pictureUrl||'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Crect width=\'40\' height=\'40\' fill=\'%232a2e36\'/%3E%3C/svg%3E'}" style="width:40px;height:40px;border-radius:50%;">
                    <div style="flex:1;">
                        <div style="font-weight:600;">${u.displayName}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">${u.email||''}</div>
                    </div>
                    <button onclick="showRoleModal('${u.lineUserId}','${u.displayName}','${u.role}')" style="padding:6px 12px;background:var(--primary);color:#fff;border:none;border-radius:8px;">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
                </div>
            `).join('');
        }

        window.showRoleModal = function(userId, userName, role) {
            document.getElementById('role-user-name').innerHTML = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: <strong>${userName}</strong>`;
            document.getElementById('user-role').value = role;
            document.getElementById('role-modal').dataset.userId = userId;
            document.getElementById('role-modal').classList.add('active');
        };

        window.closeRoleModal = () => document.getElementById('role-modal').classList.remove('active');

        window.saveUserRole = async function() {
            const userId = document.getElementById('role-modal').dataset.userId;
            const role = document.getElementById('user-role').value;

            const result = await callAPI('admin/user/role', {
                targetUserId: userId,
                role,
                lineUserId: state.user.lineUserId
            });

            if (result.success) {
                showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeRoleModal();
                loadUsers();
            }
        };

        async function loadSettings() {
            const result = await callAPI('settings');
            if (result.success) {
                state.settings = result.data || { appName: 'iTNews' };
                dom.navbarName.textContent = state.settings.appName;
                document.title = state.settings.appName + ' ¬∑ LINE';
            }
        }

        // ========== TAB SWITCHING ==========
        window.switchTab = function(tab) {
            dom.navItems.forEach(i => i.classList.toggle('active', i.dataset.tab === tab));
            dom.home.classList.toggle('hidden', tab !== 'home');
            dom.my.classList.toggle('hidden', tab !== 'my');
            dom.admin.classList.toggle('hidden', tab !== 'admin');

            if (tab === 'admin' && state.isAdmin) {
                dom.adminContent.innerHTML = '<div class="text-center p-8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
                loadAdminStats();
                loadPendingPosts();
            }
        };

        // ========== EVENT LISTENERS ==========
        dom.filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                dom.filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.filter = btn.dataset.filter;
                loadPosts();
            });
        });

        let searchTimer;
        dom.search.addEventListener('input', (e) => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                state.search = e.target.value;
                loadPosts();
            }, 300);
        });

        dom.navItems.forEach(item => {
            item.addEventListener('click', () => switchTab(item.dataset.tab));
        });

        dom.profileHeader.addEventListener('click', () => {
            if (confirm('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
                liff.logout();
                location.reload();
            }
        });

        document.querySelectorAll('.admin-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                if (btn.dataset.admin === 'posts') loadAdminStats();
                if (btn.dataset.admin === 'pending') loadPendingPosts();
                if (btn.dataset.admin === 'users') loadUsers();
            });
        });

        // ========== START ==========
        init();
    </script>
</body>
</html>
