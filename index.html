<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE MiniApp ¬∑ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LINE LIFF -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* (CSS ‡πÄ‡∏î‡∏¥‡∏° - ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        * {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #06c755;
            --primary-dark: #05b34a;
            --bg: #0a0a0f;
            --bg-card: #1a1d24;
            --border: #2a2e36;
            --text: #ffffff;
            --text-secondary: #9ca3af;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 70px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 50;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item i {
            font-size: 20px;
        }
        
        .tab-content {
            display: none;
            padding: 16px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .activity-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .activity-card:active {
            transform: scale(0.98);
            border-color: var(--primary);
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .badge-open {
            background: rgba(6,199,85,0.15);
            color: var(--primary);
            border: 1px solid rgba(6,199,85,0.3);
        }
        
        .badge-closed {
            background: rgba(239,68,68,0.15);
            color: #ef4444;
            border: 1px solid rgba(239,68,68,0.3);
        }
        
        .badge-full {
            background: rgba(245,158,11,0.15);
            color: #f59e0b;
            border: 1px solid rgba(245,158,11,0.3);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            width: 100%;
            cursor: pointer;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .loading {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .profile-header {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            border: 3px solid var(--primary);
            object-fit: cover;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 30px;
            color: var(--text);
        }
        
        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .filter-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            white-space: nowrap;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .input-field {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
        }
        
        .admin-section {
            background: linear-gradient(135deg, rgba(6,199,85,0.1), transparent);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .admin-stat {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }
        
        .toast {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            padding: 12px 16px;
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease;
        }
        
        .toast.show {
            display: block;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .profile-menu {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 16px;
        }
        
        .profile-menu-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .profile-menu-item:hover {
            background: var(--bg-hover, #252930);
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <p id="toast-message"></p>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Tab: Home -->
        <div id="tab-home" class="tab-content active">
            <!-- Profile Header -->
            <div class="profile-header" id="profile-header">
                <img id="profile-avatar" src="" alt="avatar" class="profile-avatar">
                <div class="flex-1">
                    <h2 id="profile-name" class="text-lg font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
                    <p id="profile-email" class="text-sm text-gray-400"></p>
                </div>
                <i class="fas fa-chevron-down text-gray-400" id="profile-chevron"></i>
            </div>
            
            <!-- Profile Menu (Dropdown) -->
            <div id="profile-menu" class="profile-menu hidden">
                <div class="profile-menu-item" onclick="showProfileSettings()">
                    <i class="fas fa-user mr-2 text-[#06c755]"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                </div>
                <div class="profile-menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt mr-2 text-red-500"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="stat-card">
                    <p class="text-xs text-gray-400">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="stat-total" class="text-2xl font-bold">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs text-gray-400">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</p>
                    <p id="stat-open" class="text-2xl font-bold text-[#06c755]">-</p>
                </div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...">
            </div>

            <!-- Filter -->
            <div class="filter-container">
                <button class="filter-btn active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" data-filter="open">üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</button>
                <button class="filter-btn" data-filter="full">üü° ‡πÄ‡∏ï‡πá‡∏°</button>
                <button class="filter-btn" data-filter="closed">üî¥ ‡∏õ‡∏¥‡∏î</button>
            </div>

            <!-- Activities List -->
            <div id="activities-list" class="space-y-3"></div>
        </div>

        <!-- Tab: My Activities -->
        <div id="tab-my" class="tab-content">
            <h2 class="text-xl font-bold mb-4">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <div id="my-activities-list" class="space-y-3"></div>
        </div>

        <!-- Tab: Notifications -->
        <div id="tab-notifications" class="tab-content">
            <h2 class="text-xl font-bold mb-4">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
            <div id="notifications-list" class="space-y-3"></div>
        </div>

        <!-- Tab: Admin -->
        <div id="tab-admin" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <button id="refresh-admin" class="text-[#06c755] text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>

            <!-- Admin Stats -->
            <div class="admin-section">
                <h3 class="font-semibold mb-3">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="admin-stat">
                        <p class="text-xs text-gray-400">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                        <p id="admin-users" class="text-xl font-bold">-</p>
                    </div>
                    <div class="admin-stat">
                        <p class="text-xs text-gray-400">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                        <p id="admin-activities" class="text-xl font-bold">-</p>
                    </div>
                    <div class="admin-stat">
                        <p class="text-xs text-gray-400">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                        <p id="admin-registrations" class="text-xl font-bold">-</p>
                    </div>
                    <div class="admin-stat">
                        <p class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                        <p id="admin-today" class="text-xl font-bold">-</p>
                    </div>
                </div>
            </div>

            <!-- Admin Actions -->
            <div class="admin-section">
                <h3 class="font-semibold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
                <button class="btn-primary mb-2" onclick="showCreateActivityModal()">
                    <i class="fas fa-plus mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button class="btn-outline text-sm" onclick="showAllActivities()">
                        <i class="fas fa-list mr-2"></i>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button class="btn-outline text-sm" onclick="showAllUsers()">
                        <i class="fas fa-users mr-2"></i>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    </button>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="admin-section">
                <h3 class="font-semibold mb-3">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <div id="admin-activities-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home">
            <i class="fas fa-home"></i>
            <span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </div>
        <div class="nav-item" data-tab="my">
            <i class="fas fa-ticket-alt"></i>
            <span>‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
        </div>
        <div class="nav-item" data-tab="notifications">
            <i class="fas fa-bell"></i>
            <span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
            <span id="notif-badge" class="absolute -top-1 right-4 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
        </div>
        <div class="nav-item hidden admin-only" data-tab="admin">
            <i class="fas fa-cog"></i>
            <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
        </div>
    </div>

    <!-- Activity Detail Modal -->
    <div class="modal" id="activity-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold"></h3>
                <button onclick="closeModal()"><i class="fas fa-times text-gray-400 text-xl"></i></button>
            </div>
            <div id="modal-body" class="space-y-4"></div>
            <div class="flex gap-2 mt-4">
                <button id="modal-register-btn" class="btn-primary" onclick="registerFromModal()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <button class="btn-outline" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
            </div>
            <div id="modal-admin-controls" class="hidden mt-4 pt-4 border-t border-[#2a2e36]">
                <p class="text-sm text-gray-400 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                <div class="flex gap-2">
                    <button class="btn-outline flex-1 text-sm" onclick="editCurrentActivity()">
                        <i class="fas fa-edit mr-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button class="bg-red-500 text-white flex-1 text-sm py-2 rounded-lg" onclick="deleteCurrentActivity()">
                        <i class="fas fa-trash mr-2"></i>‡∏•‡∏ö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Activity Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="create-modal-title" class="text-xl font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                <button onclick="closeCreateModal()"><i class="fas fa-times text-gray-400 text-xl"></i></button>
            </div>
            <form id="activity-form" onsubmit="saveActivity(event)">
                <input type="hidden" id="edit-activity-id">
                
                <input type="text" id="activity-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" class="input-field" required>
                
                <textarea id="activity-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="input-field" rows="3" required></textarea>
                
                <select id="activity-category" class="input-field" required>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                </select>
                
                <input type="text" id="activity-location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" class="input-field" required>
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="datetime-local" id="activity-start" class="input-field" required>
                    <input type="datetime-local" id="activity-end" class="input-field" required>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="activity-max" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î" class="input-field" required>
                    <input type="number" id="activity-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (0=‡∏ü‡∏£‡∏µ)" class="input-field" value="0">
                </div>
                
                <input type="url" id="activity-image" placeholder="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)" class="input-field">
                
                <input type="text" id="activity-tags" placeholder="‡πÅ‡∏ó‡πá‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤)" class="input-field">
                
                <textarea id="activity-requirements" placeholder="‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1)" class="input-field" rows="2"></textarea>
                
                <textarea id="activity-benefits" placeholder="‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1)" class="input-field" rows="2"></textarea>
                
                <input type="text" id="activity-contact" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="input-field">
                
                <div class="flex gap-2">
                    <button type="submit" class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn-outline" onclick="closeCreateModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
                <button onclick="closeProfileModal()"><i class="fas fa-times text-gray-400 text-xl"></i></button>
            </div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <input type="text" id="profile-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="input-field">
                
                <input type="date" id="profile-birth" class="input-field">
                
                <select id="profile-gender" class="input-field">
                    <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                    <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                    <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                </select>
                
                <input type="text" id="profile-province" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" class="input-field">
                
                <input type="text" id="profile-interests" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤)" class="input-field">
                
                <div class="flex gap-2">
                    <button type="submit" class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn-outline" onclick="closeProfileModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIG ==========
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwSz6Y_fpvB0qN52eS6QD2RFJD-bJA369B6b86W1ZGVCOrbPXGGbpBIS3hDO8h6awKzkw/exec', // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            LIFF_ID: '2008904120-T7I0VPZf', // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            PAGE_SIZE: 10
        };

        // ========== STATE ==========
        const state = {
            user: null,
            activities: [],
            myRegistrations: [],
            notifications: [],
            categories: [],
            currentFilter: 'all',
            searchTerm: '',
            isAdmin: false,
            currentPage: 1,
            currentActivity: null
        };

        // ========== DOM Elements ==========
        const loading = document.getElementById('loading');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // ========== UTILS ==========
        function showLoading() { loading.classList.add('active'); }
        function hideLoading() { loading.classList.remove('active'); }

        function showToast(msg, type = 'success') {
            toastMessage.textContent = msg;
            toast.style.borderLeftColor = type === 'success' ? '#06c755' : '#ef4444';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }

        // ========== API CALL - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö GAS ‡∏à‡∏£‡∏¥‡∏á ==========
        async function callGAS(path, data = {}) {
            showLoading();
            
            try {
                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° FormData
                const formData = new FormData();
                formData.append('path', path);
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° lineUserId ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (state.user?.lineUserId) {
                    formData.append('lineUserId', state.user.lineUserId);
                }
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        formData.append(key, data[key]);
                    }
                });

                // ‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (GAS ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CORS ‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ)
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors', // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'no-cors' ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                    credentials: 'omit'
                });

                // ‡∏≠‡πà‡∏≤‡∏ô response ‡πÄ‡∏õ‡πá‡∏ô text ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ GAS ‡∏™‡πà‡∏á JSON ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á format)
                const text = await response.text();
                
                // ‡∏•‡∏≠‡∏á parse JSON
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error('JSON parse error:', text);
                    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }

                return result;

            } catch (error) {
                console.error('API call error:', error);
                showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
                return { success: false, message: error.message };
            } finally {
                hideLoading();
            }
        }

        // ========== LIFF INIT ==========
        async function initLIFF() {
            return new Promise((resolve, reject) => {
                liff.init({ liffId: CONFIG.LIFF_ID }, async () => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    
                    try {
                        const profile = await liff.getProfile();
                        const idToken = liff.getDecodedIDToken();
                        
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏à‡∏£‡∏¥‡∏á
                        const result = await callGAS('user/profile', {
                            lineUserId: profile.userId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl || '',
                            email: idToken?.email || ''
                        });
                        
                        if (result.success) {
                            state.user = result.data;
                            state.isAdmin = state.user.role === 'admin' || state.user.role === 'org';
                            
                            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                            await loadCategories();
                            await loadHomeData();
                            await loadMyActivities();
                            await loadNotifications();
                            
                            updateUI();
                            resolve();
                        } else {
                            throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ');
                        }
                        
                    } catch (err) {
                        console.error('LIFF init error:', err);
                        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ', 'error');
                        reject(err);
                    }
                }, reject);
            });
        }

        // ========== LOAD CATEGORIES ==========
        async function loadCategories() {
            try {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ API categories ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
                // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                state.categories = [
                    { id: 'CAT001', name: '‡∏≠‡∏ö‡∏£‡∏°' },
                    { id: 'CAT002', name: '‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤' },
                    { id: 'CAT003', name: 'workshop' },
                    { id: 'CAT004', name: '‡∏Å‡∏µ‡∏¨‡∏≤' },
                    { id: 'CAT005', name: '‡∏î‡∏ô‡∏ï‡∏£‡∏µ' },
                    { id: 'CAT006', name: '‡∏®‡∏¥‡∏•‡∏õ‡∏∞' },
                    { id: 'CAT007', name: '‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß' }
                ];
                
                const select = document.getElementById('activity-category');
                if (select) {
                    select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>' + 
                        state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Load categories error:', error);
            }
        }

        // ========== UPDATE UI ==========
        function updateUI() {
            // Profile
            document.getElementById('profile-name').textContent = state.user?.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            document.getElementById('profile-email').textContent = state.user?.email || '';
            document.getElementById('profile-avatar').src = state.user?.pictureUrl || 'https://via.placeholder.com/100/06c755/ffffff?text=LINE';

            // Admin nav
            const adminNav = document.querySelector('.admin-only');
            if (state.isAdmin) {
                adminNav.classList.remove('hidden');
                loadAdminData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• admin
            } else {
                adminNav.classList.add('hidden');
            }
        }

        // ========== HOME ==========
        async function loadHomeData() {
            try {
                const result = await callGAS('activities', {
                    page: state.currentPage,
                    status: state.currentFilter,
                    search: state.searchTerm,
                    pageSize: CONFIG.PAGE_SIZE
                });
                
                if (result.success) {
                    state.activities = result.data.activities || [];
                    document.getElementById('stat-total').textContent = result.data.totalActivities || 0;
                    document.getElementById('stat-open').textContent = result.data.openActivities || 0;
                    renderActivities();
                }
            } catch (error) {
                console.error('Load home error:', error);
            }
        }

        function renderActivities() {
            const list = document.getElementById('activities-list');
            if (!state.activities || state.activities.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = state.activities.map(act => {
                const isRegistered = state.myRegistrations?.some(r => r.activityId === act.activityId);
                const statusClass = `badge-${act.status}`;
                const statusText = { 
                    'open': '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö', 
                    'closed': '‡∏õ‡∏¥‡∏î', 
                    'full': '‡πÄ‡∏ï‡πá‡∏°',
                    'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    'draft': '‡∏£‡πà‡∏≤‡∏á'
                }[act.status] || act.status;
                
                // Parse tags
                let tags = [];
                try { tags = JSON.parse(act.tags || '[]'); } catch { tags = []; }
                
                return `
                    <div class="activity-card" onclick="showActivityDetail('${act.activityId}')">
                        <div class="flex gap-3">
                            <img src="${act.imageUrl || 'https://via.placeholder.com/80/06c755/ffffff?text=Ê¥ªÂä®'}" 
                                 class="w-20 h-20 rounded-xl object-cover" 
                                 onerror="this.src='https://via.placeholder.com/80/06c755/ffffff?text=Ê¥ªÂä®'">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-semibold">${act.title || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'}</h3>
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1 line-clamp-2">${act.description || ''}</p>
                                <div class="flex items-center gap-2 mt-2 text-xs text-gray-400">
                                    <i class="fas fa-users"></i> ${act.currentParticipants || 0}/${act.maxParticipants}
                                    <i class="fas fa-map-marker-alt ml-2"></i> ${act.location || ''}
                                </div>
                                <div class="flex items-center gap-2 mt-1 text-xs">
                                    ${act.price > 0 ? 
                                        `<span class="text-yellow-500"><i class="fas fa-tag"></i> ‡∏ø${act.price}</span>` : 
                                        `<span class="text-[#06c755]"><i class="fas fa-gift"></i> ‡∏ü‡∏£‡∏µ</span>`
                                    }
                                    ${isRegistered ? 
                                        '<span class="text-[#06c755] ml-2"><i class="fas fa-check-circle"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== MY ACTIVITIES ==========
        async function loadMyActivities() {
            try {
                const result = await callGAS('user/registrations');
                if (result.success) {
                    state.myRegistrations = result.data || [];
                    renderMyActivities();
                }
            } catch (error) {
                console.error('Load my activities error:', error);
            }
        }

        function renderMyActivities() {
            const list = document.getElementById('my-activities-list');
            if (!state.myRegistrations || state.myRegistrations.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-ticket-alt text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = state.myRegistrations.map(reg => {
                const act = reg.activity || {};
                const statusText = {
                    'confirmed': '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                    'waiting': '‚è≥ ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß',
                    'cancelled': '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    'attended': 'üéâ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß'
                }[reg.status] || reg.status;
                
                return `
                    <div class="activity-card" onclick="showActivityDetail('${act.activityId}')">
                        <div class="flex gap-3">
                            <img src="${act.imageUrl || 'https://via.placeholder.com/80'}" 
                                 class="w-20 h-20 rounded-xl object-cover">
                            <div class="flex-1">
                                <h3 class="font-semibold">${act.title || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'}</h3>
                                <p class="text-xs text-gray-400 mt-1">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${formatDateShort(reg.registrationDate)}</p>
                                <p class="text-xs text-gray-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusText}</p>
                                ${reg.status === 'confirmed' ? 
                                    `<button class="text-xs text-red-500 mt-2" onclick="event.stopPropagation(); cancelRegistration('${reg.regId}')">
                                        <i class="fas fa-times mr-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>` : ''}
                                ${reg.status === 'waiting' && reg.remark ? 
                                    `<p class="text-xs text-yellow-500 mt-1">${reg.remark}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function cancelRegistration(regId) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô?')) return;
            
            const result = await callGAS('cancel', { registrationId: regId });
            if (result.success) {
                showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                await loadMyActivities();
                await loadHomeData();
            }
        }

        // ========== NOTIFICATIONS ==========
        async function loadNotifications() {
            try {
                const result = await callGAS('user/notifications', { unreadOnly: 'true' });
                if (result.success) {
                    state.notifications = result.data.notifications || [];
                    const unread = result.data.unreadCount || 0;
                    const badge = document.getElementById('notif-badge');
                    if (unread > 0) {
                        badge.textContent = unread > 9 ? '9+' : unread;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                    renderNotifications();
                }
            } catch (error) {
                console.error('Load notifications error:', error);
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notifications-list');
            if (!state.notifications || state.notifications.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = state.notifications.map(n => `
                <div class="bg-[#1a1d24] p-4 rounded-xl border border-[#2a2e36] ${n.isRead !== 'TRUE' ? 'border-l-4 border-l-[#06c755]' : ''}">
                    <p class="font-semibold">${n.title}</p>
                    <p class="text-sm text-gray-400 mt-1">${n.message}</p>
                    <p class="text-xs text-gray-500 mt-2">${formatDate(n.createdAt)}</p>
                </div>
            `).join('');
        }

        // ========== ACTIVITY DETAIL ==========
        async function showActivityDetail(activityId) {
            try {
                const result = await callGAS('activity', { activityId });
                if (result.success) {
                    state.currentActivity = result.data;
                    const act = result.data;
                    
                    document.getElementById('modal-title').textContent = act.title;

                    const isRegistered = state.myRegistrations?.some(r => r.activityId === act.activityId);
                    const statusText = { 
                        'open': '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö', 
                        'closed': '‡∏õ‡∏¥‡∏î', 
                        'full': '‡πÄ‡∏ï‡πá‡∏°',
                        'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                        'draft': '‡∏£‡πà‡∏≤‡∏á'
                    }[act.status] || act.status;
                    const statusClass = `badge-${act.status}`;

                    // Parse JSON fields
                    let requirements = [], benefits = [], tags = [];
                    try { requirements = JSON.parse(act.requirements || '[]'); } catch { requirements = []; }
                    try { benefits = JSON.parse(act.benefits || '[]'); } catch { benefits = []; }
                    try { tags = JSON.parse(act.tags || '[]'); } catch { tags = []; }

                    let html = `
                        <img src="${act.imageUrl || 'https://via.placeholder.com/400/06c755/ffffff?text=Ê¥ªÂä®'}" 
                             class="w-full h-48 object-cover rounded-xl"
                             onerror="this.src='https://via.placeholder.com/400/06c755/ffffff?text=Ê¥ªÂä®'">
                        
                        <div class="flex justify-between items-center">
                            <span class="badge ${statusClass}">${statusText}</span>
                            <span class="text-sm text-gray-400">
                                <i class="fas fa-users mr-1"></i>${act.currentParticipants || 0}/${act.maxParticipants}
                            </span>
                        </div>
                        
                        <div class="flex flex-wrap gap-1">
                            ${tags.map(t => `<span class="text-xs bg-[#2a2e36] px-2 py-1 rounded-full">#${t}</span>`).join('')}
                        </div>
                        
                        <p class="text-gray-400">${act.description || ''}</p>
                        
                        <div class="space-y-2 text-sm">
                            <p><i class="fas fa-calendar w-5 text-[#06c755]"></i> ${formatDate(act.startDate)}</p>
                            <p><i class="fas fa-calendar-check w-5 text-[#06c755]"></i> ${formatDate(act.endDate)}</p>
                            <p><i class="fas fa-map-marker-alt w-5 text-[#06c755]"></i> ${act.location || ''}</p>
                            <p><i class="fas fa-tag w-5 text-[#06c755]"></i> ${act.price > 0 ? '‡∏ø' + Number(act.price).toLocaleString() : '‡∏ü‡∏£‡∏µ'}</p>
                        </div>
                    `;

                    if (requirements.length > 0) {
                        html += `
                            <div class="mt-2">
                                <p class="font-semibold mb-1">üìã ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥</p>
                                <ul class="text-sm text-gray-400 list-disc pl-4">
                                    ${requirements.map(r => `<li>${r}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (benefits.length > 0) {
                        html += `
                            <div class="mt-2">
                                <p class="font-semibold mb-1">üéÅ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå</p>
                                <ul class="text-sm text-gray-400 list-disc pl-4">
                                    ${benefits.map(b => `<li>${b}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (act.contact) {
                        html += `<p class="text-sm text-gray-400 mt-2"><i class="fas fa-phone mr-2 text-[#06c755]"></i> ${act.contact}</p>`;
                    }

                    document.getElementById('modal-body').innerHTML = html;

                    const registerBtn = document.getElementById('modal-register-btn');
                    if (isRegistered) {
                        registerBtn.disabled = true;
                        registerBtn.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (act.status !== 'open') {
                        registerBtn.disabled = true;
                        registerBtn.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ';
                    } else {
                        registerBtn.disabled = false;
                        registerBtn.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                    }

                    // Admin controls
                    const adminControls = document.getElementById('modal-admin-controls');
                    if (state.isAdmin) {
                        adminControls.classList.remove('hidden');
                    } else {
                        adminControls.classList.add('hidden');
                    }

                    document.getElementById('activity-modal').classList.add('active');
                }
            } catch (error) {
                console.error('Show activity detail error:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function registerFromModal() {
            if (!state.currentActivity) return;
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô?')) return;
            
            const result = await callGAS('register', { 
                activityId: state.currentActivity.activityId,
                displayName: state.user?.displayName || '',
                email: state.user?.email || '',
                phone: state.user?.phone || ''
            });
            
            if (result.success) {
                showToast('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeModal();
                await loadMyActivities();
                await loadHomeData();
                
                if (result.data?.status === 'waiting') {
                    showToast(`‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${result.data.queuePosition}`, 'info');
                }
            }
        }

        function closeModal() {
            document.getElementById('activity-modal').classList.remove('active');
        }

        // ========== ADMIN ==========
        async function loadAdminData() {
            try {
                const result = await callGAS('admin/stats');
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('admin-users').textContent = stats.users || 0;
                    document.getElementById('admin-activities').textContent = stats.activities || 0;
                    document.getElementById('admin-registrations').textContent = stats.registrations || 0;
                    document.getElementById('admin-today').textContent = stats.todayRegistrations || 0;
                }

                // Load recent activities
                const acts = await callGAS('activities', { page: 1, pageSize: 5 });
                if (acts.success) {
                    const list = document.getElementById('admin-activities-list');
                    list.innerHTML = acts.data.activities.map(a => `
                        <div class="flex justify-between items-center p-2 bg-[#111317] rounded-lg cursor-pointer" onclick="showActivityDetail('${a.activityId}')">
                            <span class="text-sm">${a.title}</span>
                            <span class="badge badge-${a.status} text-xs">${a.status}</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Load admin data error:', error);
            }
        }

        // ========== ADMIN: CREATE/EDIT ==========
        function showCreateActivityModal() {
            if (!state.isAdmin) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', 'error');
                return;
            }
            
            document.getElementById('create-modal-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
            document.getElementById('edit-activity-id').value = '';
            document.getElementById('activity-title').value = '';
            document.getElementById('activity-desc').value = '';
            document.getElementById('activity-category').value = '';
            document.getElementById('activity-location').value = '';
            document.getElementById('activity-start').value = '';
            document.getElementById('activity-end').value = '';
            document.getElementById('activity-max').value = '100';
            document.getElementById('activity-price').value = '0';
            document.getElementById('activity-image').value = '';
            document.getElementById('activity-tags').value = '';
            document.getElementById('activity-requirements').value = '';
            document.getElementById('activity-benefits').value = '';
            document.getElementById('activity-contact').value = '';
            
            document.getElementById('create-modal').classList.add('active');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
        }

        async function saveActivity(e) {
            e.preventDefault();
            
            if (!state.isAdmin) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error');
                return;
            }
            
            const id = document.getElementById('edit-activity-id').value;
            const isEdit = !!id;

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const tags = document.getElementById('activity-tags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);

            const requirements = document.getElementById('activity-requirements').value
                .split('\n')
                .map(r => r.trim())
                .filter(r => r);

            const benefits = document.getElementById('activity-benefits').value
                .split('\n')
                .map(b => b.trim())
                .filter(b => b);

            const data = {
                title: document.getElementById('activity-title').value,
                description: document.getElementById('activity-desc').value,
                category: document.getElementById('activity-category').value,
                location: document.getElementById('activity-location').value,
                startDate: document.getElementById('activity-start').value,
                endDate: document.getElementById('activity-end').value,
                maxParticipants: parseInt(document.getElementById('activity-max').value) || 100,
                price: parseInt(document.getElementById('activity-price').value) || 0,
                imageUrl: document.getElementById('activity-image').value,
                tags: JSON.stringify(tags),
                requirements: JSON.stringify(requirements),
                benefits: JSON.stringify(benefits),
                contact: document.getElementById('activity-contact').value
            };

            if (isEdit) {
                data.activityId = id;
            }

            const result = await callGAS(isEdit ? 'activities/update' : 'activities/create', data);
            if (result.success) {
                showToast(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeCreateModal();
                await loadHomeData();
                if (state.isAdmin) await loadAdminData();
            }
        }

        function editCurrentActivity() {
            if (!state.isAdmin || !state.currentActivity) return;
            
            const act = state.currentActivity;
            
            document.getElementById('create-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
            document.getElementById('edit-activity-id').value = act.activityId;
            document.getElementById('activity-title').value = act.title || '';
            document.getElementById('activity-desc').value = act.description || '';
            document.getElementById('activity-category').value = act.category || '';
            document.getElementById('activity-location').value = act.location || '';
            document.getElementById('activity-start').value = act.startDate ? act.startDate.slice(0,16) : '';
            document.getElementById('activity-end').value = act.endDate ? act.endDate.slice(0,16) : '';
            document.getElementById('activity-max').value = act.maxParticipants || 100;
            document.getElementById('activity-price').value = act.price || 0;
            document.getElementById('activity-image').value = act.imageUrl || '';

            // Parse tags
            let tags = [];
            try { tags = JSON.parse(act.tags || '[]'); } catch { tags = []; }
            document.getElementById('activity-tags').value = tags.join(', ');

            // Parse requirements
            let reqs = [];
            try { reqs = JSON.parse(act.requirements || '[]'); } catch { reqs = []; }
            document.getElementById('activity-requirements').value = reqs.join('\n');

            // Parse benefits
            let benefits = [];
            try { benefits = JSON.parse(act.benefits || '[]'); } catch { benefits = []; }
            document.getElementById('activity-benefits').value = benefits.join('\n');

            document.getElementById('activity-contact').value = act.contact || '';

            closeModal();
            document.getElementById('create-modal').classList.add('active');
        }

        async function deleteCurrentActivity() {
            if (!state.isAdmin || !state.currentActivity) return;
            if (!confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
            
            const result = await callGAS('activities/delete', { 
                activityId: state.currentActivity.activityId 
            });
            
            if (result.success) {
                showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeModal();
                await loadHomeData();
                if (state.isAdmin) await loadAdminData();
            }
        }

        // ========== PROFILE ==========
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('hidden');
        }

        document.getElementById('profile-header').addEventListener('click', toggleProfileMenu);

        function showProfileSettings() {
            document.getElementById('profile-phone').value = state.user?.phone || '';
            document.getElementById('profile-birth').value = state.user?.birthDate || '';
            document.getElementById('profile-gender').value = state.user?.gender || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('profile-province').value = state.user?.province || '';
            document.getElementById('profile-interests').value = state.user?.interests || '';
            
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('profile-menu').classList.add('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        async function saveProfile(e) {
            e.preventDefault();
            
            const data = {
                phone: document.getElementById('profile-phone').value,
                birthDate: document.getElementById('profile-birth').value,
                gender: document.getElementById('profile-gender').value,
                province: document.getElementById('profile-province').value,
                interests: document.getElementById('profile-interests').value
            };

            const result = await callGAS('user/update', data);
            if (result.success) {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeProfileModal();
                if (state.user) {
                    Object.assign(state.user, data);
                }
            }
        }

        function logout() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
                liff.logout();
                location.reload();
            }
        }

        // ========== ADMIN UTILS ==========
        function showAllActivities() {
            alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
        }

        function showAllUsers() {
            alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        }

        // ========== TAB NAVIGATION ==========
        document.querySelectorAll('.nav-item').forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                
                document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${target}`).classList.add('active');
                
                // Load data for tab
                if (target === 'home') loadHomeData();
                if (target === 'my') loadMyActivities();
                if (target === 'notifications') loadNotifications();
                if (target === 'admin' && state.isAdmin) loadAdminData();
            });
        });

        // ========== SEARCH ==========
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                state.searchTerm = e.target.value;
                state.currentPage = 1;
                loadHomeData();
            }, 500);
        });

        // ========== FILTER ==========
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentFilter = btn.dataset.filter;
                state.currentPage = 1;
                loadHomeData();
            });
        });

        // ========== REFRESH ADMIN ==========
        document.getElementById('refresh-admin')?.addEventListener('click', loadAdminData);

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading();
            try {
                await initLIFF();
                hideLoading();
            } catch (err) {
                console.error(err);
                hideLoading();
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ', 'error');
                
                // ‡πÅ‡∏™‡∏î‡∏á UI ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
                document.getElementById('profile-name').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                document.getElementById('activities-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-3"></i>
                        <p class="text-gray-400">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ</p>
                        <button class="btn-primary mt-4" onclick="location.reload()">‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                    </div>
                `;
            }
        });

        // Close modals on outside click
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
            
            // Close profile menu when clicking outside
            if (!e.target.closest('#profile-header') && !e.target.closest('#profile-menu')) {
                document.getElementById('profile-menu')?.classList.add('hidden');
            }
        };
    </script>
</body>
</html>
